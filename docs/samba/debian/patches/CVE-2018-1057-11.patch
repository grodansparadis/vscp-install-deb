Backport of:

From 4cdbbd43ca1c508a795ccdcdc6e08fe783286790 Mon Sep 17 00:00:00 2001
From: Ralph Boehme <slow@samba.org>
Date: Fri, 16 Feb 2018 15:30:13 +0100
Subject: [PATCH 11/13] CVE-2018-1057: s4:dsdb/samdb: define
 DSDB_CONTROL_PASSWORD_ACL_VALIDATION_OID control

Will be used to pass "user password change" vs "password reset" from the
ACL to the password_hash module, ensuring both modules treat the request
identical.

Bug: https://bugzilla.samba.org/show_bug.cgi?id=13272

Signed-off-by: Ralph Boehme <slow@samba.org>
Reviewed-by: Stefan Metzmacher <metze@samba.org>
---
 source4/dsdb/samdb/samdb.h          | 9 +++++++++
 source4/libcli/ldap/ldap_controls.c | 1 +
 source4/setup/schema_samba4.ldif    | 2 ++
 3 files changed, 12 insertions(+)

Index: samba-4.3.11+dfsg/source4/dsdb/samdb/samdb.h
===================================================================
--- samba-4.3.11+dfsg.orig/source4/dsdb/samdb/samdb.h	2018-03-06 16:47:28.709674414 +0100
+++ samba-4.3.11+dfsg/source4/dsdb/samdb/samdb.h	2018-03-06 16:47:28.709674414 +0100
@@ -157,6 +157,15 @@ struct dsdb_control_password_change {
 */
 #define DSDB_CONTROL_CHANGEREPLMETADATA_RESORT_OID "1.3.6.1.4.1.7165.4.3.25"
 
+/*
+ * Used to pass "user password change" vs "password reset" from the ACL to the
+ * password_hash module, ensuring both modules treat the request identical.
+ */
+#define DSDB_CONTROL_PASSWORD_ACL_VALIDATION_OID "1.3.6.1.4.1.7165.4.3.33"
+struct dsdb_control_password_acl_validation {
+	bool pwd_reset;
+};
+
 #define DSDB_EXTENDED_REPLICATED_OBJECTS_OID "1.3.6.1.4.1.7165.4.4.1"
 struct dsdb_extended_replicated_object {
 	struct ldb_message *msg;
Index: samba-4.3.11+dfsg/source4/libcli/ldap/ldap_controls.c
===================================================================
--- samba-4.3.11+dfsg.orig/source4/libcli/ldap/ldap_controls.c	2018-03-06 16:47:28.709674414 +0100
+++ samba-4.3.11+dfsg/source4/libcli/ldap/ldap_controls.c	2018-03-06 16:47:28.709674414 +0100
@@ -1280,6 +1280,7 @@ static const struct ldap_control_handler
 	{ DSDB_CONTROL_PASSWORD_CHANGE_STATUS_OID, NULL, NULL },
 	{ DSDB_CONTROL_PASSWORD_HASH_VALUES_OID, NULL, NULL },
 	{ DSDB_CONTROL_PASSWORD_CHANGE_OID, NULL, NULL },
+	{ DSDB_CONTROL_PASSWORD_ACL_VALIDATION_OID, NULL, NULL },
 	{ DSDB_CONTROL_APPLY_LINKS, NULL, NULL },
 	{ LDB_CONTROL_BYPASS_OPERATIONAL_OID, NULL, NULL },
 	{ DSDB_CONTROL_CHANGEREPLMETADATA_OID, NULL, NULL },
Index: samba-4.3.11+dfsg/source4/setup/schema_samba4.ldif
===================================================================
--- samba-4.3.11+dfsg.orig/source4/setup/schema_samba4.ldif	2018-03-06 16:47:28.709674414 +0100
+++ samba-4.3.11+dfsg/source4/setup/schema_samba4.ldif	2018-03-06 16:48:17.398083125 +0100
@@ -200,6 +200,7 @@
 #Allocated: DSDB_CONTROL_PERMIT_INTERDOMAIN_TRUST_UAC_OID 1.3.6.1.4.1.7165.4.3.23
 #Allocated: DSDB_CONTROL_RESTORE_TOMBSTONE_OID 1.3.6.1.4.1.7165.4.3.24
 #Allocated: DSDB_CONTROL_CHANGEREPLMETADATA_RESORT_OID 1.3.6.1.4.1.7165.4.3.25
+#Allocated: DSDB_CONTROL_PASSWORD_ACL_VALIDATION_OID 1.3.6.1.4.1.7165.4.3.33
 
 # Extended 1.3.6.1.4.1.7165.4.4.x
 #Allocated: DSDB_EXTENDED_REPLICATED_OBJECTS_OID 1.3.6.1.4.1.7165.4.4.1
