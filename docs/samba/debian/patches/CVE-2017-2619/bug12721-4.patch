From 28e641a86ce61bb01e068d9ad6b147e4a6d6d087 Mon Sep 17 00:00:00 2001
From: Jeremy Allison <jra@samba.org>
Date: Mon, 27 Mar 2017 17:04:58 -0700
Subject: [PATCH 2/4] s3: smbd: Fix "follow symlink = no" regression part 2.

Add an extra paramter to cwd_name to check_reduced_name().

If cwd_name == NULL then fname is a client given path relative
to the root path of the share.

If cwd_name != NULL then fname is a client given path relative
to cwd_name. cwd_name is relative to the root path of the share.

Not yet used, logic added in the next commit.

BUG: https://bugzilla.samba.org/show_bug.cgi?id=12721

Signed-off-by: Jeremy Allison <jra@samba.org>
---
 source3/smbd/filename.c |  2 +-
 source3/smbd/open.c     |  2 +-
 source3/smbd/proto.h    |  4 +++-
 source3/smbd/vfs.c      | 10 +++++++++-
 4 files changed, 14 insertions(+), 4 deletions(-)

Index: samba-4.3.11+dfsg/source3/smbd/filename.c
===================================================================
--- samba-4.3.11+dfsg.orig/source3/smbd/filename.c	2017-03-28 08:34:42.047408121 -0400
+++ samba-4.3.11+dfsg/source3/smbd/filename.c	2017-03-28 08:34:42.039407977 -0400
@@ -1194,7 +1194,7 @@
 	}
 
 	if (!lp_widelinks(SNUM(conn)) || !lp_follow_symlinks(SNUM(conn))) {
-		status = check_reduced_name(conn,name);
+		status = check_reduced_name(conn, NULL, name);
 		if (!NT_STATUS_IS_OK(status)) {
 			DEBUG(5,("check_name: name %s failed with %s\n",name,
 						nt_errstr(status)));
Index: samba-4.3.11+dfsg/source3/smbd/open.c
===================================================================
--- samba-4.3.11+dfsg.orig/source3/smbd/open.c	2017-03-28 08:34:42.047408121 -0400
+++ samba-4.3.11+dfsg/source3/smbd/open.c	2017-03-28 08:34:42.043408049 -0400
@@ -539,7 +539,7 @@
 	}
 
 	/* Ensure the relative path is below the share. */
-	status = check_reduced_name(conn, final_component);
+	status = check_reduced_name(conn, parent_dir, final_component);
 	if (!NT_STATUS_IS_OK(status)) {
 		saved_errno = map_errno_from_nt_status(status);
 		goto out;
Index: samba-4.3.11+dfsg/source3/smbd/proto.h
===================================================================
--- samba-4.3.11+dfsg.orig/source3/smbd/proto.h	2017-03-28 08:34:42.047408121 -0400
+++ samba-4.3.11+dfsg/source3/smbd/proto.h	2017-03-28 08:34:42.043408049 -0400
@@ -1173,7 +1173,9 @@
 			    SMB_STRUCT_STAT *sbuf, char **talloced);
 int vfs_ChDir(connection_struct *conn, const char *path);
 char *vfs_GetWd(TALLOC_CTX *ctx, connection_struct *conn);
-NTSTATUS check_reduced_name(connection_struct *conn, const char *fname);
+NTSTATUS check_reduced_name(connection_struct *conn,
+			const char *cwd_name,
+			const char *fname);
 NTSTATUS check_reduced_name_with_privilege(connection_struct *conn,
 			const char *fname,
 			struct smb_request *smbreq);
Index: samba-4.3.11+dfsg/source3/smbd/vfs.c
===================================================================
--- samba-4.3.11+dfsg.orig/source3/smbd/vfs.c	2017-03-28 08:34:42.047408121 -0400
+++ samba-4.3.11+dfsg/source3/smbd/vfs.c	2017-03-28 08:34:42.043408049 -0400
@@ -1149,9 +1149,17 @@
 /*******************************************************************
  Reduce a file name, removing .. elements and checking that
  it is below dir in the heirachy. This uses realpath.
+
+ If cwd_name == NULL then fname is a client given path relative
+ to the root path of the share.
+
+ If cwd_name != NULL then fname is a client given path relative
+ to cwd_name. cwd_name is relative to the root path of the share.
 ********************************************************************/
 
-NTSTATUS check_reduced_name(connection_struct *conn, const char *fname)
+NTSTATUS check_reduced_name(connection_struct *conn,
+				const char *cwd_name,
+				const char *fname)
 {
 	char *resolved_name = NULL;
 	bool allow_symlinks = true;
