head	1.1;
access;
symbols
	Release-7-1-1:1.1.0.52
	Root_Release-7-1-1:1.1
	Root_Release_7-0-1:1.1
	Release_7-0-1:1.1.0.50
	Release_7-0-0:1.1.0.48
	Root_Release_7-0-0:1.1
	Release-6-2-2:1.1.0.46
	Release-6-1-2-3:1.1
	Root_Release-6-1-2-3:1.1
	Release-6-1-2-2:1.1.0.44
	Root_Release-6-1-2-2:1.1
	debian_version_6_1_2_1-1:1.1
	upstream_version_6_1_2_1:1.1
	Release-6-1-2-1_new:1.1.0.42
	Root_Release-6-1-2-1_new:1.1
	Release-6-1-2-1:1.1.0.40
	Root_Release-6-1-2-1:1.1
	upstream_version_6_1_2:1.1
	debian_version_6_1_2-1:1.1
	Release-6-1-2:1.1.0.38
	Root_Release-6-1-2:1.1
	debian_version_6_1_1-2:1.1
	debian_version_6_1_1-1:1.1
	upstream_version_6_1_1:1.1
	Release-6-1-1:1.1.0.36
	Root_Release-6-1-1:1.1
	Release-6-0-4:1.1.0.34
	Root_Release-6-0-4:1.1
	Release-6-0-3_NEW:1.1.0.30
	Root_Release-6-0-3_NEW:1.1
	Release-6-0-3:1.1.0.32
	Root_Release-6-0-3:1.1
	Release-6-0-0:1.1.0.28
	Root_Release-6-0-0:1.1
	Release-5-5-4-1:1.1.0.26
	Root_Release-5-5-4-1:1.1
	Release-5-5-4:1.1.0.24
	Root_Release-5-5-4:1.1
	Release-5-5-3:1.1.0.22
	ROOT_Release-5-5-3:1.1
	Release-5-5-2:1.1.0.20
	Root_Release-5-5-2:1.1
	debian_version_5_5_1-1:1.1
	Release-5-5-1:1.1.0.16
	upstream_version_5_5_1:1.1
	ROOT_Release-5-5-1:1.1
	debian_version_5_5-1:1.1
	upstream_version_5_5:1.1
	ROOT_Release-5-5:1.1
	Release-5-5:1.1.0.18
	debian_version_5_4_4_2-3:1.1
	Release-5-4-4-2-1:1.1.0.12
	debian_version_5_4_4_2-2:1.1
	debian_version_5_4_4_2-1:1.1
	upstream_version_5_4_4_2:1.1
	debian_version_5_4_4_1-1:1.1
	upstream_version_5_4_4_1:1.1
	debian_version_5_4_4-1:1.1
	upstream_version_5_4_4:1.1
	Release-5-4-4:1.1.0.14
	Root_Release-5-4-4:1.1
	debian_version_5_4_3_2-1:1.1
	upstream_version_5_4_3_2:1.1
	Release_5-4-3-2:1.1.0.10
	Root_Release_5-4-3-2:1.1
	upstream_version_5_4_3_1:1.1
	debian_version_5_4_3_1-1:1.1
	Release-5-4-3:1.1.0.8
	Root_Release-5-4-3:1.1
	Root_Release-5-4-1:1.1
	Release-5-4-1:1.1.0.6
	Root_Release-5-4:1.1
	Release-5-4:1.1.0.4
	upstream_version_5_3_4:1.1
	debian_version_5_3_4-1:1.1
	ROOT_Release-5-3-4:1.1
	Release-5-3-4:1.1.0.2;
locks; strict;
comment	@# @;


1.1
date	2008.11.27.21.00.26;	author jost_boekemeier;	state Exp;
branches;
next	;


desc
@@


1.1
log
@Release 5.3.3.1
@
text
@<?php require_once ("java/Java.inc");

java_require("lucene.jar");


try {
  echo "indexing ... ";
  /* Create an index */
  $cwd=getcwd();
  /* create the index files in the tmp dir */
  $tmp = create_index_dir();
  $analyzer = new java("org.apache.lucene.analysis.standard.StandardAnalyzer");
  $writer = new java("org.apache.lucene.index.IndexWriter", $tmp, $analyzer, true);
  $file = new java("java.io.File", $cwd);
  $files = $file->listFiles();
  assert (!java_is_null($files));

  foreach($files as $f) {
    $doc = new java("org.apache.lucene.document.Document");
    $doc->add(new java("org.apache.lucene.document.Field",
      "name", 
       $f->getName(), 
       java('org.apache.lucene.document.Field$Store')->YES, 
       java('org.apache.lucene.document.Field$Index')->UN_TOKENIZED));
    $writer->addDocument($doc);
  }
  $writer->optimize();
  $writer->close();
  echo "done\n";

  echo "searching... ";
  /* Search */
  $searcher = new java("org.apache.lucene.search.IndexSearcher", $tmp);
  $phrase = new java("org.apache.lucene.search.MatchAllDocsQuery");
  $hits = $searcher->search($phrase);

  /* Print result */
  $iter = $hits->iterator();
  $n = java_values($hits->length());
  echo "done\n";
  echo "Hits: $n\n";

  /* Instead of retrieving the values one-by-one, we store them into a
   * LinkedList on the server side and then retrieve the list in one
   * query using java_values():
   */
  $resultList = new java("java.util.LinkedList");

				// create an XML document from the
				// following PHP code, ...
  java_begin_document();
  while($n--) {
    $next = $iter->next();
    $name = $next->get("name");
    $resultList->add($name);
  }
				//  ... execute the XML document on
				//  the server side, ...
  java_end_document();
  
				// .. retrieve the result, ...
  $result = java_values($resultList); 
				// ... print the result array
  print_r($result);

  delete_index_dir();
} catch (JavaException $e) {
  echo "Exception occured: "; echo $e; echo "<br>\n";
}

/** helper functions */
$tmp_file=null;
$tmp_dir=null;
/** create a temporary directory for the lucene index files. Make sure
 * to create the tmpdir from Java so that the directory has
 * javabridge_tmp_t Security Enhanced Linux permission. Note that PHP
 * does not have access to tempfiles with java_bridge_tmp_t: PHP
 * inherits the rights from the HTTPD, usually httpd_tmp_t.
 */
function create_index_dir() {
  global $tmp_file, $tmp_dir;
  $javaTmpdir = java("java.lang.System")->getProperty("java.io.tmpdir");
  $tmpdir = java_values($javaTmpdir);
  $tmp_file=tempnam($tmpdir, "idx");
  $tmp_dir=new java("java.io.File", "${tmp_file}.d");
  $tmp_dir->mkdir();
  return java_values($tmp_dir->toString());
}

/** delete the lucene index files */
function delete_index_dir() {
  global $tmp_file, $tmp_dir;
  $files = $tmp_dir->listFiles();
  foreach($files as $f) {
    $f->delete();
  }
  $tmp_dir->delete();
  unlink($tmp_file);
  $tmp_file=$tmp_dir=null;
}

?>
@
