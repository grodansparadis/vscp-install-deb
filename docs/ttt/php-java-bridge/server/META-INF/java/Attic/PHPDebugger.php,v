head	1.20;
access;
symbols
	Root_Release_7-0-1:1.18
	Release_7-0-1:1.18.0.2
	Release_7-0-0:1.17.0.6
	Root_Release_7-0-0:1.17
	Release-6-2-2:1.17.0.4
	Release-6-1-2-3:1.17
	Root_Release-6-1-2-3:1.17
	Release-6-1-2-2:1.17.0.2
	Root_Release-6-1-2-2:1.17
	debian_version_6_1_2_1-1:1.17
	upstream_version_6_1_2_1:1.16
	Release-6-1-2-1_new:1.16.0.4
	Root_Release-6-1-2-1_new:1.16
	Release-6-1-2-1:1.16.0.2
	Root_Release-6-1-2-1:1.16
	upstream_version_6_1_2:1.8
	debian_version_6_1_2-1:1.8
	Release-6-1-2:1.8.0.2
	Root_Release-6-1-2:1.8
	debian_version_6_1_1-2:1.7
	debian_version_6_1_1-1:1.7
	upstream_version_6_1_1:1.7
	Release-6-1-1:1.7.0.2
	Root_Release-6-1-1:1.7
	Release-6-0-4:1.6.0.6
	Root_Release-6-0-4:1.6
	Release-6-0-3_NEW:1.6.0.2
	Root_Release-6-0-3_NEW:1.6
	Release-6-0-3:1.6.0.4
	Root_Release-6-0-3:1.6
	Release-6-0-0:1.5.0.2
	Root_Release-6-0-0:1.6;
locks; strict;
comment	@# @;


1.20
date	2017.04.09.14.00.06;	author jost_boekemeier;	state dead;
branches;
next	1.19;

1.19
date	2017.03.02.17.40.37;	author jost_boekemeier;	state Exp;
branches;
next	1.18;

1.18
date	2017.02.25.16.28.47;	author jost_boekemeier;	state Exp;
branches;
next	1.17;

1.17
date	2010.05.04.09.24.00;	author jost_boekemeier;	state Exp;
branches;
next	1.16;

1.16
date	2010.05.02.11.49.36;	author jost_boekemeier;	state Exp;
branches;
next	1.15;

1.15
date	2010.04.28.21.22.39;	author jost_boekemeier;	state Exp;
branches;
next	1.14;

1.14
date	2010.04.28.20.56.30;	author jost_boekemeier;	state Exp;
branches;
next	1.13;

1.13
date	2010.04.28.03.18.31;	author jost_boekemeier;	state Exp;
branches;
next	1.12;

1.12
date	2010.04.26.16.48.32;	author jost_boekemeier;	state Exp;
branches;
next	1.11;

1.11
date	2010.04.25.20.08.59;	author jost_boekemeier;	state Exp;
branches;
next	1.10;

1.10
date	2010.04.25.06.52.31;	author jost_boekemeier;	state Exp;
branches;
next	1.9;

1.9
date	2010.04.24.14.19.59;	author jost_boekemeier;	state Exp;
branches;
next	1.8;

1.8
date	2010.04.17.18.15.48;	author jost_boekemeier;	state Exp;
branches;
next	1.7;

1.7
date	2010.03.16.16.46.23;	author jost_boekemeier;	state Exp;
branches;
next	1.6;

1.6
date	2010.02.28.15.20.43;	author jost_boekemeier;	state Exp;
branches;
next	1.5;

1.5
date	2010.02.18.16.31.00;	author jost_boekemeier;	state Exp;
branches;
next	1.4;

1.4
date	2010.01.29.17.05.20;	author jost_boekemeier;	state Exp;
branches;
next	1.3;

1.3
date	2010.01.25.16.45.14;	author jost_boekemeier;	state Exp;
branches;
next	1.2;

1.2
date	2010.01.23.10.09.35;	author jost_boekemeier;	state Exp;
branches;
next	1.1;

1.1
date	2010.01.04.15.33.07;	author jost_boekemeier;	state Exp;
branches;
next	;


desc
@@


1.20
log
@Release-7.1.1
@
text
@<?php /*-*- mode: php; tab-width:4 -*-*/

  /**
   * PHPDebugger.inc -- A PHP debugger for Eclipse for PHP Developers
   *
   * Copyright (C) 2009,2010 Jost Boekemeier.
   *
   * This file is part of the PHP/Java Bridge.
   * 
   * The PHP/Java Bridge ("the library") is free software; you can
   * redistribute it and/or modify it under the terms of the GNU General
   * Public License as published by the Free Software Foundation; either
   * version 2, or (at your option) any later version.
   * 
   * The library is distributed in the hope that it will be useful, but
   * WITHOUT ANY WARRANTY; without even the implied warranty of
   * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
   * General Public License for more details.
   * 
   * You should have received a copy of the GNU General Public License
   * along with the PHP/Java Bridge; see the file COPYING.  If not, write to the
   * Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA
   * 02111-1307 USA.
   * 
   * Linking this file statically or dynamically with other modules is
   * making a combined work based on this library.  Thus, the terms and
   * conditions of the GNU General Public License cover the whole
   * combination.
   * 
   * As a special exception, the copyright holders of this library give you
   * permission to link this library with independent modules to produce an
   * executable, regardless of the license terms of these independent
   * modules, and to copy and distribute the resulting executable under
   * terms of your choice, provided that you also meet, for each linked
   * independent module, the terms and conditions of the license of that
   * module.  An independent module is a module which is not derived from
   * or based on this library.  If you modify this library, you may extend
   * this exception to your version of the library, but you are not
   * obligated to do so.  If you do not wish to do so, delete this
   * exception statement from your version. 
   *
   * Installation:
   *
   * Install "Eclipse for PHP Developers" version >= 3.5.2
   * 
   * - Open Window -> Preferences -> Servers and set Default Web Server to: http://localhost:8080
   * - Deploy JavaBridgeTemplate.war
   * - Create a new Project using .../apache-tomcat-7.0.75/webapps/JavaBridgeTemplate as directory
   * - Open index.php and start debugger: Default Web Server with Zend Debugger (other options default)
   * - Click debug 
   *
   * To debug standalone applications, remove zend_extension=ZendDebugger.so from your php.ini and set:
   * 
   *<code>
   * ;; activate the PHPDebugger in the php.ini
   * auto_prepend_file=PHPDebugger.php
   *</code>
   *
   * - Debug your PHP scripts as usual. 
   *
   *
   * @@category   java
   * @@package    pdb
   * @@author     Jost Boekemeier
   * @@license    GPL+Classpath exception
   * @@version    7.0
   * @@link       http://php-java-bridge.sf.net/phpdebugger
   */


/** @@access private */
define ("PDB_DEBUG", 0);
set_time_limit (0);
if(!function_exists("token_get_all")) {
	dl("tokenizer.so");
}

if ($pdb_script_orig = $pdb_script = pdb_getDebugHeader("X_JAVABRIDGE_INCLUDE", $_SERVER)) {
	if ($pdb_script!="@@") {
		if (($_SERVER['REMOTE_ADDR']=='127.0.0.1') || (($pdb_script = realpath($pdb_script)) && (!strncmp($_SERVER['DOCUMENT_ROOT'], $pdb_script, strlen($_SERVER['DOCUMENT_ROOT']))))) {
			$_SERVER['SCRIPT_FILENAME'] = $pdb_script; // set to the original script filename
		} else {
			trigger_error("illegal access: ".$pdb_script_orig, E_USER_ERROR);
			unset($pdb_script);
		}
	}
}



if (!class_exists("pdb_Parser")) {
  /**
   * The PHP parser
   * @@access private
   */
  class pdb_Parser {
	const BLOCK = 1;
	const STATEMENT = 2;
	const EXPRESSION = 3;
	const FUNCTION_BLOCK = 4; // BLOCK w/ STEP() as last statement

	private $scriptName, $content;
	private $code;
	private $output;
	private $line, $currentLine;
	private $beginStatement, $inPhp, $inDQuote;
 
	/**
	 * Create a new PHP parser
	 * @@param string the script name
	 * @@param string the script content
	 * @@access private
	 */
	public function __construct($scriptName, $content) {
	  $this->scriptName = $scriptName;
	  $this->content = $content;
	  $this->code = token_get_all($content);
	  $this->output = "";
	  $this->line = $this->currentLine = 0;
	  $this->beginStatement = $this->inPhp = $this->inDQuote = false;
	}

	private function toggleDQuote($chr) {
	  if ($chr == '"') $this->inDQuote = !$this->inDQuote;
	}

	private function each() {
	  $next = each ($this->code);
	  if ($next) {
		$cur = current($this->code);
		if (is_array($cur)) {
		  $this->currentLine = $cur[2] + ($cur[1][0] == "\n" ? substr_count($cur[1], "\n") : 0);
		  if ($this->isWhitespace($cur)) {
			$this->write($cur[1]);
			return $this->each();
		  }
		}
		else 
		  $this->toggleDQuote($cur);
	  }
	  return $next;
	}

	private function write($code) {
	  //echo "write:::".$code."\n";
	  $this->output.=$code;
	}

	private function writeInclude($once) {
	  $name = "";
	  while(1) {
		if (!$this->each()) die("parse error");
		$val = current($this->code);
		if (is_array($val)) {
		  $name.=$val[1];
		} else {
		  if ($val==';') break;
		  $name.=$val;
		}
	  }
	  if (PDB_DEBUG == 2) 
		$this->write("EVAL($name);");
	  else
		$this->write("eval('?>'.pdb_startInclude($name, $once)); pdb_endInclude();");
	}

	private function writeCall() {
	  while(1) {
		if (!$this->each()) die("parse error");
		$val = current($this->code);
		if (is_array($val)) {
		  $this->write($val[1]);
		} else {
		  $this->write($val);
		  if ($val=='{') break;
		}
	  }
	  $scriptName = addslashes($this->scriptName);
	  $this->write("\$__pdb_CurrentFrame=pdb_startCall(\"$scriptName\", {$this->currentLine});");
	}

	private function writeStep($pLevel) {
	  $token = current($this->code);
	  if ($this->inPhp && !$pLevel && !$this->inDQuote && $this->beginStatement && !$this->isWhitespace($token) && ($this->line != $this->currentLine)) {
		$line = $this->line = $this->currentLine;
		$scriptName = addslashes($this->scriptName);
		if (PDB_DEBUG == 2)
		  $this->write(";STEP($line);");
		else
		  $this->write(";pdb_step(\"$scriptName\", $line, pdb_getDefinedVars(get_defined_vars(), (isset(\$this) ? \$this : NULL)));");
	  }
	}

	private function writeNext() {
	  $this->next();
	  $token = current($this->code);
	  if (is_array($token)) $token = $token[1];
	  $this->write($token);
	}

	private function nextIs($chr) {
	  $i = 0;
	  while(each($this->code)) {
		$cur = current($this->code);
		$i++;
		if (is_array($cur)) {
		  switch ($cur[0]) {
		  case T_COMMENT:
		  case T_DOC_COMMENT:
		  case T_WHITESPACE:
			break;	/* skip */
		  default: 
			while($i--) prev($this->code);
			return false;	/* not found */
		  }
		} else {
		  while($i--) prev($this->code);
		  return $cur == $chr;	/* found */
		}
	  }
	  while($i--) prev($this->code);
	  return false;	/* not found */
	}

	private function nextTokenIs($ar) {
	  $i = 0;
	  while(each($this->code)) {
		$cur = current($this->code);
		$i++;
		if (is_array($cur)) {
		  switch ($cur[0]) {
		  case T_COMMENT:
		  case T_DOC_COMMENT:
		  case T_WHITESPACE:
			break;	/* skip */
		  default: 
			while($i--) prev($this->code);
			return (in_array($cur[0], $ar));
		  }
		} else {
		  break; /* not found */
		}
	  }
	  while($i--) prev($this->code);
	  return false;	/* not found */
	}

	private function isWhitespace($token) {
	  $isWhitespace = false;
	  switch($token[0]) {
	  case T_COMMENT:
	  case T_DOC_COMMENT:
	  case T_WHITESPACE:
		$isWhitespace = true;
		break;
	  }
	  return $isWhitespace;
	}
	private function next() {
	  if (!$this->each()) trigger_error("parse error", E_USER_ERROR);
	}

	private function parseBlock () {
	  $this->parse(self::BLOCK);
	}
	private function parseFunction () {
	  $this->parse(self::FUNCTION_BLOCK);
	}
	private function parseStatement () {
	  $this->parse(self::STATEMENT);
	}
	private function parseExpression () {
	  $this->parse(self::EXPRESSION);
	}

	private function parse ($type) {
	  pdb_Logger::debug("parse:::$type");

	  $this->beginStatement = true;
	  $pLevel = 0;

	  do {
		$token = current($this->code);
		if (!is_array($token)) {
		  pdb_Logger::debug(":::".$token);
		  if (!$pLevel && $type==self::FUNCTION_BLOCK && $token=='}') $this->writeStep($pLevel);
		  $this->write($token);
		  if ($this->inPhp && !$this->inDQuote) {
			$this->beginStatement = false; 
			switch($token) {
			case '(': 
			  $pLevel++;
			  break;
			case ')':
			  if (!--$pLevel && $type==self::EXPRESSION) return;
			  break;
			case '{': 
			  $this->next();
			  $this->parseBlock(); 
			  break;
			case '}': 
			  if (!$pLevel) return;
			  break;
			case ';':
			  if (!$pLevel) {
				if ($type==self::STATEMENT) return;
				$this->beginStatement = true; 
			  }
			  break;
			}
		  }
		} else {
		  pdb_Logger::debug(":::".$token[1].":(".token_name($token[0]).')');

		  if ($this->inDQuote) {
			$this->write($token[1]);
			continue;
		  }

		  switch($token[0]) {

		  case T_OPEN_TAG: 
		  case T_START_HEREDOC:
		  case T_OPEN_TAG_WITH_ECHO: 
			$this->beginStatement = $this->inPhp = true;
			$this->write($token[1]);
			break;

		  case T_END_HEREDOC:
		  case T_CLOSE_TAG: 
			$this->writeStep($pLevel);

			$this->write($token[1]);
			$this->beginStatement = $this->inPhp = false; 
			break;

		  case T_FUNCTION:
			$this->write($token[1]);
			$this->writeCall();
			$this->next();
			$this->parseFunction();
			$this->beginStatement = true;
			break;

		  case T_ELSE:
			$this->write($token[1]);
			if ($this->nextIs('{')) {
			  $this->writeNext();
			  $this->next();

			  $this->parseBlock();
			} else {
			  $this->next();

			  /* create an artificial block */
			  $this->write('{');
			  $this->beginStatement = true;
			  $this->writeStep($pLevel);
			  $this->parseStatement();
			  $this->write('}');

			}
			if ($type==self::STATEMENT) return;

			$this->beginStatement = true;
			break;

		  case T_DO:
			$this->writeStep($pLevel);
			$this->write($token[1]);
			if ($this->nextIs('{')) {
			  $this->writeNext();
			  $this->next();

			  $this->parseBlock();
			  $this->next();

			} else {
			  $this->next();

			  /* create an artificial block */
			  $this->write('{');
			  $this->beginStatement = true;
			  $this->writeStep($pLevel);
			  $this->parseStatement();
			  $this->next();
			  $this->write('}');
			}
			$token = current($this->code);
			$this->write($token[1]);

			if ($token[0]!=T_WHILE) trigger_error("parse error", E_USER_ERROR);
			$this->next();
			$this->parseExpression();

			if ($type==self::STATEMENT) return;

			$this->beginStatement = true;
			break;

		  case T_CATCH:
		  case T_IF:
		  case T_ELSEIF:
		  case T_FOR:
		  case T_FOREACH:
		  case T_WHILE:
			$this->writeStep($pLevel);

			$this->write($token[1]);
			$this->next();

			$this->parseExpression();

			if ($this->nextIs('{')) {
			  $this->writeNext();
			  $this->next();

			  $this->parseBlock();


			} else {
			  $this->next();
			  /* create an artificial block */
			  $this->write('{');
			  $this->beginStatement = true;
			  $this->writeStep($pLevel);
			  $this->parseStatement();
			  $this->write('}');
			}

			if ($this->nextTokenIs(array(T_ELSE, T_ELSEIF, T_CATCH))) {
			  $this->beginStatement = false;
			} else {
			  if ($type==self::STATEMENT) return;
			  $this->beginStatement = true;
			}
			break;

		  case T_REQUIRE_ONCE:
		  case T_INCLUDE_ONCE: 
		  case T_INCLUDE: 
		  case T_REQUIRE: 
			$this->writeStep($pLevel);
			$this->writeInclude((($token[0]==T_REQUIRE_ONCE) || ($token[0]==T_INCLUDE_ONCE)) ? 1 : 0);

			if ($type==self::STATEMENT) return;

			$this->beginStatement = true;
			break;

		  case T_CLASS:
			$this->write($token[1]);
			$this->writeNext();
			if ($this->nextIs('{')) {
			  $this->writeNext();
			  $this->next();
			  $this->parseBlock(); 
			  $this->beginStatement = true;
			} else {
			  $this->writeNext();
			  $this->beginStatement = false;
			}
			break;

		  case T_CASE:
		  case T_DEFAULT:
		  case T_PUBLIC:
		  case T_PRIVATE:
		  case T_PROTECTED:
		  case T_STATIC:
		  case T_CONST:
		  case T_GLOBAL:
		  case T_ABSTRACT:
			$this->write($token[1]);
			$this->beginStatement = false;
			break;

		  default:
			$this->writeStep($pLevel);
			$this->write($token[1]);
			$this->beginStatement = false;
			break;
	
		  }
		}
	  } while($this->each());
	}

	/**
	 * parse the given PHP script
	 * @@return the parsed PHP script
	 * @@access private
	 */
	public function parseScript() {
	  do {
		$this->parseBlock();
	  } while($this->each());

	  return $this->output;
	}
  }
}

/**
 * @@access private
 */
class pdb_Logger {
  const FATAL = 1;
  const INFO = 2;
  const VERBOSE = 3;
  const DEBUG = 4;

  private static $logLevel = 0;
  private static $logFileName;

  private static function println($msg, $level) {
	if (!self::$logLevel) self::$logLevel=PDB_DEBUG?self::DEBUG:self::INFO;
	if ($level <= self::$logLevel) {
	  static $file = null;
	  if(!isset(self::$logFileName)) {
		self::$logFileName = $_SERVER['HOME'].DIRECTORY_SEPARATOR."pdb_PHPDebugger.inc.log";
	  }
	  if (!$file) $file = fopen(self::$logFileName, "ab") or die("fopen");
	  fwrite($file, time().": ");
	  fwrite($file, $msg."\n");
	  fflush($file);
	}
  }

  public static function logFatal($msg) {
	self::println($msg, self::FATAL);
  }
  public static function logInfo($msg) {
	self::println($msg, self::INFO);
  }
  public static function logMessage($msg) {
	self::println($msg, self::VERBOSE);
  }
  public static function logDebug($msg) {
	self::println($msg, self::DEBUG);
  }
  public static function debug($msg) {
	self::logDebug($msg);
  }
  public static function log($msg) {
	self::logMessage($msg);
  }
  public static function setLogLevel($level) {
	self::$logLevel=$level;
  }
  public static function setLogFileName($name) {
	self::$logFileName = $name;
  }
}

/**
 * @@access private
 */
class pdb_Environment {
  public $filename, $stepNext;
  public $vars, $line, $firstLine;
  public $parent;

  public function __construct($parent, $filename, $stepNext, $firstLine) {
	$this->parent = $parent;
    $this->filename = $filename;
    $this->stepNext = $stepNext;
	$this->firstLine = $firstLine;
    $this->line = -1;
  }

  public function update ($line, &$vars) {
    $this->line = $line;
    $this->vars = &$vars;
  }
  public function __toString() {
	return "pdb_Environment: {$this->filename}, {$this->firstLine} - {$this->line}";
  }
}

/**
 * @@access private
 */
abstract class pdb_Message {
  public $session;

  public abstract function getType();

  public function __construct($session) {
    $this->session = $session;
  }

  public function serialize() {
    $this->session->out->writeShort($this->getType());
  }

  private static $messages = array();
  public static function register($message) {
    pdb_Message::$messages[$message->getType()] = $message;
  }
  public function getMessageById($id) {
    $message = pdb_Message::$messages[$id];
    return $message;
  }
  public function getMessage() {
    $id = $this->session->in->readShort();
    $message = $this->getMessageById($id);
    if (!$message) trigger_error("invalid message: $id", E_USER_ERROR);
    $message->deserialize();
    return $message;
  }

  protected function handleContinueProcessFile($message) {
	$code = $this->session->parseCode($this->currentFrame->filename, file_get_contents($this->currentFrame->filename));
	if (PDB_DEBUG) pdb_Logger::debug( "parse file:::" . $code ."\n");
	if (!PDB_DEBUG) ob_start();
	self::doEval ($code);
	$output = $this->getMessageById(pdb_OutputNotification::TYPE);
	if(!PDB_DEBUG) $output->setOutput(ob_get_contents());
	if(!PDB_DEBUG) ob_end_clean();
	$output->serialize();
	$this->status = 42; //FIXME
	$this->getMessageById(pdb_DebugScriptEndedNotification::TYPE)->serialize();
    return true;
  }
  private static function doEval($__pdb_Code) {
    return  eval ("?>".$__pdb_Code);
  }
  protected function handleStep($message) {
    return false;
  }
  protected function handleGo($message) {
    foreach ($this->session->allFrames as $frame) {
      $frame->stepNext = false;
    }
    return true; // exit
  }
  public function handleRequests () {
	$this->ignoreInterrupt = false;

    $this->serialize();
    while(1) {
      $message = $this->getMessage();
      switch ($message->getType()) {
      case pdb_SetProtocolRequest::TYPE:
		$message->ack();
		break;
      case pdb_StartRequest::TYPE:
		$message->ack();
		$this->getMessageById(pdb_StartProcessFileNotification::TYPE)->serialize();
		break;
      case pdb_ContinueProcessFileNotification::TYPE:
		if ($this->handleContinueProcessFile($message)) return pdb_ContinueProcessFileNotification::TYPE;
		break;
      case pdb_AddBreakpointRequest::TYPE:
		$message->ack();
		break;
      case pdb_RemoveBreakpointRequest::TYPE:
		$message->ack();
		break;
      case pdb_RemoveAllBreakpointsRequest::TYPE:
		$message->ack();
		break;
      case pdb_GetCallStackRequest::TYPE:
		$message->ack();
		break;
      case pdb_GetCWDRequest::TYPE:
		$message->ack();
		break;
      case pdb_GetVariableValueRequest::TYPE:
		$message->ack();
		break;
      case pdb_AddFilesRequest::TYPE:
		$message->ack();
		break;
      case pdb_FileContentExtendedRequest::TYPE:
		$message->ack();
		break;
      case pdb_MsgEvalRequest::TYPE:
		$message->ack();
		break;
      case pdb_GoRequest::TYPE:
		$message->ack();
		if ($this->handleGo($message)) return pdb_GoRequest::TYPE;
		break;
      case pdb_StepOverRequest::TYPE:
		$message->ack();
		if ($this->handleStep($message)) return pdb_StepOverRequest::TYPE;
		break;
      case pdb_StepIntoRequest::TYPE:
		$message->ack();
		if ($this->handleStep($message)) return pdb_StepIntoRequest::TYPE;
		break;
      case pdb_StepOutRequest::TYPE:
		$message->ack();
		if ($this->handleStep($message)) return pdb_StepOutRequest::TYPE;
		break;
      case pdb_End::TYPE:
		$this->session->end();
      default: trigger_error("protocol error: $message", E_USER_ERROR);
      }
    }
  }
}
/**
 * @@access private
 */
abstract class pdb_MessageRequest extends pdb_Message {
  public abstract function ack();
}

/**
 * @@access private
 */
class pdb_Serializer {
  private $serial;
  private $depth;

  private function doSerialize ($o, $depth) {
    $serial = &$this->serial;

    switch(gettype($o)) {
    case 'object':
      $serial.="O:";
      $serial.=strlen(get_class($o));
      $serial.=":\"";
      $serial.=get_class($o);
      $serial.="\":";
      $serial.=count((array)$o);

	  if ($depth <= $this->depth) {
		$serial.=":{";
		foreach((array)$o as $k=>$v) {
		  $serial.=serialize($k);
		  $this->doSerialize($v, $depth+1);
		}
		$serial.="}";
	  } else {
		$serial .= ";";
	  }
      break;

    case 'array':
      $serial.="a:";
      $serial.=count($o);

	  if ($depth <= $this->depth) {
		$serial.=":{";
		foreach($o as $k=>$v) {
		  $serial.=serialize($k);
		  $this->doSerialize($v, $depth+1);
		}
		$serial.="}";
	  } else {
		$serial.=";";
	  }
      break;
    default:
      $serial.=serialize($o);
      break;
    }
  }

  public function serialize ($obj, $depth) {
    $this->serial = "";
	$this->depth = $depth;

    $this->doSerialize ($obj, 1);

    return $this->serial;
  }
}

/**
 * @@access private
 */
class pdb_DebugSessionStart extends pdb_Message {
  const TYPE = 2005;

  public $status;
  public $end;

  private $breakFirstLine;
  private $enable;
  public $uri;
  public $query;
  public $options;
  
  public $in, $out;
  private $outputNotification;

  public $lines;
  public $breakpoints;

  public $currentTopLevelFrame, $currentFrame;
  public $allFrames; // should be a weak map so that frames could be gc'ed

  public $ignoreInterrupt; 

  public $serializer;

  public $includedScripts;

  public function getType() {
    return self::TYPE;
  }
  public function __construct($options) {
    parent::__construct($this);
	$this->end = true;
	if (isset($_SERVER["SCRIPT_FILENAME"]) && isset($_SERVER["QUERY_STRING"])&&!extension_loaded("Zend Debugger")) {
	  $filename = $uri = $_SERVER["SCRIPT_FILENAME"];
	  $queryStr = $_SERVER["QUERY_STRING"];
	} else { // PHPDebugger disabled
	  global $pdb_script;
	  $this->enable = false;
	  if (isset($pdb_script) && $pdb_script!="@@") {
	  	require_once($pdb_script);
	  }
	  return;
	}

	$params = explode('&', $queryStr);
	$args = array();
	for ($i=0; $i<count($params); $i++) {
		$arg=explode( '=', urldecode($params[$i]));
		$args[$arg[0]] = $arg[1];
	}
	$this->enable = $args["start_debug"];
	$this->breakFirstLine = isset($args["debug_stop"]) ? $args["debug_stop"] : 0;
    $this->uri = $uri;
    $this->query = $queryStr;
    $this->options = $options;
    $this->breakpoints = $this->lines = array();

	$this->serializer = new pdb_Serializer();

	$this->currentTopLevelFrame = $this->currentFrame = new pdb_Environment(null, $filename, false, 1);
	$this->allFrames[] = $this->currentFrame;
	$this->ignoreInterrupt = false;
	$this->includedScripts = array();

    $errno = 0; $errstr = "";
    $io = null;
    foreach(explode(",", $args["debug_host"]) as $host) {
        if ($io = fsockopen($host, $args['debug_port'], $errno, $errstr, 5)) {
            break;
        }
    }
    if ($io==null) {
        trigger_error("fsockopen", E_USER_ERROR);
    }
	$this->end = false;

    $this->in =new pdb_In($io, $this);
    $this->out=new pdb_Out($io, $this);
  }
  public function end() {
	$this->end = true;
	if (PDB_DEBUG) pdb_Logger::debug( "end() called");
	exit(0);
  }
  /**
   * @@access private
   */
  public function flushOutput() {
	if (!isset($this->outputNotification))
	  $this->outputNotification = $this->getMessageById(pdb_OutputNotification::TYPE);

	$this->outputNotification->setOutput(ob_get_contents());
	if (!PDB_DEBUG) ob_clean();
	$this->outputNotification->serialize();
  }

  /**
   * @@access private
   */
  public function resolveIncludePath($scriptName) {
	if (file_exists($scriptName)) return realpath($scriptName);
	$paths = explode(PATH_SEPARATOR, get_include_path());
	$name = $scriptName;
	foreach ($paths as $path) {
	  $scriptName = realpath("${path}${name}");
	  if ($scriptName) return $scriptName;
	}
	trigger_error("file $scriptName not found", E_USER_ERROR);
  }

  public function serialize() {
    $out = $this->session->out;
    parent::serialize();
    $out->writeInt(2004102501);
    $out->writeString($this->currentFrame->filename);
    $out->writeString($this->uri);
    $out->writeString($this->query);
    $out->writeString($this->options);
    $out->flush();
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function handleRequests () {
	if ($this->enable) {
	  set_error_handler("pdb_error_handler");
	  register_shutdown_function("pdb_shutdown");

	  parent::handleRequests(); 
	  if (PDB_DEBUG) pdb_Logger::debug( "exit({$this->status})");
	  exit ($this->status); }
  }
  public function hasBreakpoint($scriptName, $line) {
	if ($this->breakFirstLine) {$this->breakFirstLine = false; return true;}

    if ($this->currentFrame->stepNext) return true;

    foreach ($this->breakpoints as $breakpoint) {
      if($breakpoint->type==1) {
		if ($breakpoint->file==$scriptName&&$breakpoint->line==$line) return true;
      }
    }

    return false;
  }
  function parseCode($filename, $contents) {
	$parser = new pdb_Parser($filename, $contents);
	return $parser->parseScript();
  }

  public function __toString() {
    return "pdb_DebugSessionStart: {$this->currentFrame->filename}";
  }
}


/**
 * @@access private
 */
class pdb_HeaderOutputNotification extends pdb_Message {
  const TYPE = 2008;
  private $out;

  public function setOutput($out) {
    $this->out = $out;
  }
  protected function getAsciiOutput() {
    return $this->out;
  }
  protected function getEncodedOutput () {
    return $this->out; //FIXME
  }
  protected function getOutput() {
    return $this->getAsciiOutput();
  }
  public function getType() {
    return self::TYPE;
  }

  public function serialize() {
    $out = $this->session->out;
    parent::serialize();
    $out->writeString($this->getOutput());
    $out->flush();
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function __toString () {
    return "pdb_HeaderOutputNotification: ".$this->getOutput();
  }
}

/**
 * @@access private
 */
class pdb_OutputNotification extends pdb_HeaderOutputNotification {
  const TYPE = 2004;

  public function getType() {
    return self::TYPE;
  }
  protected function getOutput() {
    return $this->getEncodedOutput();
  }
  public function __toString () {
    return "pdb_OutputNotification: ".$this->getAsciiOutput();
  }
}

/**
 * @@access private
 */
class pdb_ErrorNotification extends pdb_Message {
  const TYPE = 2006;
  private $type, $filename, $lineno, $error;

  public function getType() {
    return self::TYPE;
  }
  public function setError($type, $filename, $lineno, $error) {
	$this->type = $type;
	$this->filename = $filename;
	$this->lineno = $lineno;
	$this->error = $error;
  }

  public function serialize() {
    $out = $this->session->out;
    parent::serialize();
    $out->writeInt($this->type);
	$out->writeString($this->filename);
	$out->writeInt($this->lineno);
	$out->writeString($this->error);
    $out->flush();
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function __toString () {
    return "pdb_ErrorNotification: {$this->error} at {$this->filename} line {$this->lineno}";
  }
}

/**
 * @@access private
 */
class pdb_DebugScriptEndedNotification extends pdb_Message {
  const TYPE = 2002;

  public function getType() {
    return self::TYPE;
  }

  public function serialize() {
    $out = $this->session->out;
    parent::serialize();
    $out->writeShort($this->session->status);
    $out->flush();
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function __toString () {
    return "pdb_DebugScriptEndedNotification: {$this->session->status}";
  }
}


/**
 * @@access private
 */
class pdb_ReadyNotification extends pdb_Message {
  const TYPE = 2003;
  
  public function getType() {
    return self::TYPE;
  }

  protected function handleStep($message) {
    return true;
  }

  public function serialize() {
    $out = $this->session->out;
    parent::serialize();
    $out->writeString($this->session->currentFrame->filename);
    $out->writeInt($this->session->currentFrame->line);
    $out->writeInt(0);
    $out->flush();
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function __toString () {
    return "pdb_ReadyNotification: {$this->session->currentFrame->filename}, {$this->session->currentFrame->line}";
  }
}

/**
 * @@access private
 */
class pdb_SetProtocolRequest extends pdb_MessageRequest {
  const TYPE = 10000;
  public $id;
  public $protocolId;
  
  public function getType() {
    return self::TYPE;
  }
  public function deserialize() {
    $in = $this->session->in;
    $this->id = $in->readInt();
    $this->protocolId = $in->readInt();
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function ack() {
    $res = new pdb_SetProtocolResponse($this);
    $res->serialize();
  }
  public function __toString () {
    return "pdb_SetProtocolRequest: ". $this->protocolId;
  }
}

/**
 * @@access private
 */
class pdb_SetProtocolResponse extends pdb_Message {
  const TYPE = 11000;
  private $req;
  
  public function __construct ($req) {
    parent::__construct($req->session);
    $this->req = $req;
  }

  public function getType() {
    return self::TYPE;
  }
  public function serialize() {
    $out = $this->session->out;
    parent::serialize();
    $out->writeInt($this->req->id);

    // use fixed id instead of $out->writeInt($this->req->protocolId);
	$out->writeInt(2012121702);

    $out->flush();
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function __toString () {
    return "pdb_SetProtocolResponse: ";
  }
}

/**
 * @@access private
 */
class pdb_StartRequest extends pdb_MessageRequest {
  const TYPE = 1;
  public $id;
  public $protocolId;
  
  public function getType() {
    return self::TYPE;
  }
  public function deserialize() {
    $in = $this->session->in;
    $this->id = $in->readInt();
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }

  public function ack() {
    $res = new pdb_StartResponse($this);
    $res->serialize();
  }
  public function __toString () {
    return "pdb_StartRequest: ";
  }
}

/**
 * @@access private
 */
class pdb_AddFilesRequest extends pdb_MessageRequest {
  const TYPE = 38;
  public $id;
  public $pathSize;
  public $paths;

  public function getType() {
    return self::TYPE;
  }
  public function deserialize() {
    $in = $this->session->in;
    $this->id = $in->readInt();
    $this->pathSize = $in->readInt();
    $this->paths = array();
    for($i=0; $i<$this->pathSize; $i++) {
       $this->paths[] = $in->readString();
    }
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }

  public function ack() {
    $res = new pdb_AddFilesResponse($this);
    $res->serialize();
  }
  public function __toString () {
    return "pdb_AddFilesRequest: ";
  }
}
/**
 * @@access private
 */
class pdb_FileContentExtendedRequest extends pdb_MessageRequest {
  const TYPE = 10002;
  public $id;
  public $size;
  public $checksum;

  public function getType() {
    return self::TYPE;
  }
  public function deserialize() {
    $in = $this->session->in;
    $this->id = $in->readInt();
    $this->size = $in->readInt();
    $this->checksum = $in->readInt();

    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }

  public function ack() {
    $res = new pdb_FileContentExtendedResponse($this);
    $res->serialize();
  }
  public function __toString () {
    return "pdb_FileContentExtendedRequest: ";
  }
}

/**
 * @@access private
 */
class pdb_AddFilesResponse extends pdb_Message {
  const TYPE = 1038;
  private $req;
  
  public function __construct ($req) {
    parent::__construct($req->session);
    $this->req = $req;
  }

  public function getType() {
    return self::TYPE;
  }
  public function serialize() {
    $out = $this->session->out;
    parent::serialize();
    $out->writeInt($this->req->id);
    $out->writeInt(0);
    $out->flush();
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function __toString () {
    return "pdb_AddFilesResponse: ";
  }
}

/**
 * @@access private
 */
class pdb_FileContentExtendedResponse extends pdb_Message {
  const TYPE = 11001;
  private $req;
  
  public function __construct ($req) {
    parent::__construct($req->session);
    $this->req = $req;
  }

  public function getType() {
    return self::TYPE;
  }
  public function serialize() {
    $out = $this->session->out;
    parent::serialize();
    $out->writeInt($this->req->id);
    $out->writeInt(0); // fixme: status
    $out->writeInt(0); // fixme: string: filecontent
    $out->flush();
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function __toString () {
    return "pdb_FileContentExtendedResponse: ";
  }
}

/**
 * @@access private
 */
class pdb_StartResponse extends pdb_Message {
  const TYPE = 1001;
  private $req;
  
  public function __construct ($req) {
    parent::__construct($req->session);
    $this->req = $req;
  }

  public function getType() {
    return self::TYPE;
  }
  public function serialize() {
    $out = $this->session->out;
    parent::serialize();
    $out->writeInt($this->req->id);
    $out->writeInt(0);
    $out->flush();
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function __toString () {
    return "pdb_StartResponse: ";
  }
}
/**
 * @@access private
 */
class pdb_StartProcessFileNotification extends pdb_Message {
  const TYPE = 2009;
  public function __construct ($session) {
    parent::__construct($session);
  }
  protected function handleContinueProcessFile($message) {
    return true; // next
  }
  public function getType() {
    return self::TYPE;
  }
  public function serialize() {
    $out = $this->session->out;
    parent::serialize();
    $out->writeString($this->session->currentFrame->filename);
    $out->flush();
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function __toString () {
    return "pdb_StartProcessFileNotification: {$this->session->currentFrame->filename}";
  }
}

/**
 * @@access private
 */
class pdb_ContinueProcessFileNotification extends pdb_Message {
  const TYPE = 2010;
  public function getType() {
    return self::TYPE;
  }
  public function deserialize() {
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function __toString () {
    return "pdb_ContinueProcessFileNotification: ";
  }
}

/**
 * @@access private
 */
class pdb_Breakpoint {
  public $type, $lifeTime, $file, $line, $condition;
  private $id;

  public function __construct($type, $lifeTime, $file, $line, $condition, $id) {
    $this->type = $type;
    $this->lifeTime = $lifeTime;
    $this->file = $file;
    $this->line = $line;
    $this->condition = $condition;
    $this->id = $id;
  }
  public function __toString () {
    return "pdb_Breakpoint: ";
  }
}
/**
 * @@access private
 */
class pdb_AddBreakpointResponse extends pdb_Message {
  const TYPE = 1021;
  private $req;
  private $id;

  private static function getId() {
    static $id = 0;
    return ++$id;
  }

  public function __construct($req) {
    parent::__construct($req->session);
    $this->req = $req;
    $this->id = self::getId();
    $this->session->breakpoints[$this->id] = new pdb_Breakpoint($req->type, $req->lifeTime, $req->file, $req->line, $req->condition, $this->id);
  }

  public function getType() {
    return self::TYPE;
  }
  public function serialize() {
    $out = $this->session->out;
    parent::serialize();
    $out->writeInt($this->req->id);
    $out->writeInt(0);
    $out->writeInt($this->id);
    $out->flush();
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function __toString () {
    return "pdb_AddBreakpointResponse: {$this->id}";
  }
}

/**
 * @@access private
 */
class pdb_RemoveBreakpointResponse extends pdb_Message {
  const TYPE = 1022;
  private $req;
  private $id;
  private $failure;

  public function __construct($req) {
    parent::__construct($req->session);
    $this->req = $req;

	$this->remove();
  }

  protected function remove() {
	if (isset($this->session->breakpoints[$this->req->bpId])) {
	  unset($this->session->breakpoints[$this->req->bpId]);
	  $this->failure = 0;
	} else {
	  $this->failure = -1;
	}
  }

  public function getType() {
    return self::TYPE;
  }
  public function serialize() {
    $out = $this->session->out;
    parent::serialize();
    $out->writeInt($this->req->id);
    $out->writeInt($this->failure);
    $out->flush();
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function __toString () {
    return "pdb_RemoveBreakpointResponse: {$this->id}";
  }
}
/**
 * @@access private
 */
class pdb_RemoveAllBreakpointsResponse extends pdb_RemoveBreakpointResponse {
  const TYPE = 1023;
  public function __construct($req) {
    parent::__construct($req);
  }

  protected function remove() {
	$keys = array_keys($this->session->breakpoints);
	foreach($keys as $key)
	  unset($this->session->breakpoints[$key]);
	
	$this->failure = 0;
  }

  public function getType() {
    return self::TYPE;
  }

  public function __toString () {
    return "pdb_RemoveAllBreakpoinstResponse: {$this->id}";
  }
}

/**
 * @@access private
 */
class pdb_AddBreakpointRequest extends pdb_MessageRequest {
  const TYPE = 21;
  public $id;
  public $type;
  public $lifeTime;

  public $file;
  public $line;

  public $condition;

  public function getType() {
    return self::TYPE;
  }
  public function deserialize() {
    $in = $this->session->in;
    $this->id = $in->readInt();
    $this->type = $in->readShort();
    $this->lifeType = $in->readShort();
    switch($this->type) {
    case 1: 
      $this->file = $in->readString();
      $this->line = $in->readInt();
      break;
    case 2:
      $this->condition = $in->readString();
      break;
    default: 
      trigger_error("invalid breakpoint", E_USER_ERROR);
    }
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function ack() {
    $res = new pdb_AddBreakpointResponse ($this);
    $res->serialize();
  }
  public function __toString () {
    if ($this->type == 1) 
      return "pdb_AddBreakpointRequest: {$this->file}, {$this->line}";
    else
      return "pdb_AddBreakpointRequest: {$this->condition}";
  }
}
/**
 * @@access private
 */
class pdb_RemoveAllBreakpointsRequest extends pdb_MessageRequest {
  const TYPE = 23;
  public $id;

  public function getType() {
    return self::TYPE;
  }
  public function deserialize() {
    $in = $this->session->in;
    $this->id = $in->readInt();
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function ack() {
    $res = new pdb_RemoveAllBreakpointsResponse ($this);
    $res->serialize();
  }
  public function __toString () {
	return "pdb_RemoveAllBreakpointsRequest ";
  }
}
/**
 * @@access private
 */
class pdb_RemoveBreakpointRequest extends pdb_RemoveAllBreakpointsRequest {
  const TYPE = 22;
  public $bpId;

  public function getType() {
    return self::TYPE;
  }

  public function deserialize() {
	parent::deserialize();
    $in = $this->session->in;
    $this->bpId = $in->readInt();
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function ack() {
    $res = new pdb_RemoveBreakpointResponse ($this);
    $res->serialize();
  }
  public function __toString () {
	return "pdb_RemoveBreakpointRequest: {$this->bpId}";
  }
}

/**
 * @@access private
 */
class pdb_GetCallStackResponse extends pdb_Message {
  const TYPE = 1034;
  private $req;

  public function __construct($req) {
    parent::__construct($req->session);
    $this->req = $req;
  }

  public function getType() {
    return self::TYPE;
  }
  public function serialize() {
    $out = $this->session->out;
    parent::serialize();
    $out->writeInt($this->req->id);

	for($frame=$this->session->currentFrame; $frame; $frame=$frame->parent)
	  $environments[] = $frame;

	$environments = array_reverse($environments);
    $n = count($environments);

    $out->writeInt($n);
    for ($i=0; $i<$n; $i++) {
	  $env = $environments[$i];
      $out->writeString($env->filename);
      $out->writeInt($env->line);
      $out->writeInt(0);
      $out->writeString($env->filename);
      $out->writeInt($env->firstLine);
      $out->writeInt(0);
      $out->writeInt(0); //fixme: params
    }

	$out->flush();
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function __toString () {
    return "pdb_GetCallStackResponse: ";
  }
}
/**
 * @@access private
 */
class pdb_GetCallStackRequest extends pdb_MessageRequest {
  const TYPE = 34;
  public $id;
	
  public function getType() {
    return self::TYPE;
  }
  public function deserialize() {
    $in = $this->session->in;
    $this->id = $in->readInt();
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function ack() {
    $res = new pdb_GetCallStackResponse ($this);
    $res->serialize();
  }
  public function __toString () {
    return "pdb_GetCallStackRequest: ";
  }
}


/**
 * @@access private
 */
class pdb_GetCWDResponse extends pdb_Message {
  const TYPE = 1036;
  private $req;

  public function __construct ($req) {
    parent::__construct($req->session);
    $this->req = $req;
  }

  public function getType() {
    return self::TYPE;
  }
  public function serialize() {
    $out = $this->session->out;
    parent::serialize();
    $out->writeInt($this->req->id);
    $out->writeInt(0);
    $out->writeString(getcwd());    
    $out->flush();
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function __toString () {
    return "pdb_GetCWDResponse: ";
  }
}

/**
 * @@access private
 */
class pdb_GetCWDRequest extends pdb_MessageRequest {
  const TYPE = 36;
  public $id;

  public function getType() {
    return self::TYPE;
  }
  public function deserialize() {
    $in = $this->session->in;
    $this->id = $in->readInt();
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function ack() {
    $res = new pdb_GetCWDResponse($this);
    $res->serialize();
  }
  public function __toString () {
    return "pdb_GetCWDRequest: ";
  }
}

/**
 * @@access private
 */
class pdb_MsgEvalResponse extends pdb_Message {
  const TYPE = 1031;
  private $req;

  public function __construct ($req) {
    parent::__construct($req->session);
    $this->req = $req;
  }

  public function getType() {
    return self::TYPE;
  }

  public function serialize() {
    $out = $this->session->out;
    parent::serialize();
    $out->writeInt($this->req->id);
    if (PDB_DEBUG) pdb_Logger::debug( "evalcode:::".$this->req->code."\n");
	$error = 0;
    $code = $this->req->code;
    $res = eval("return $code ?>");
 	$out->writeInt($error);
    $out->writeString($res);

	if (PDB_DEBUG) pdb_Logger::debug("pdb_MsgEvalResponse: ".print_r($res, true));
    $out->flush();
  }
  public function __toString () {
    return "pdb_MsgEvalResponse: ";
  }
}
/**
 * @@access private
 */
class pdb_GetVariableValueResponse extends pdb_Message {
  const TYPE = 1032;
  private $req;

  public function __construct ($req) {
    parent::__construct($req->session);
    $this->req = $req;
  }

  public function getType() {
    return self::TYPE;
  }

  public function serialize() {
    $out = $this->session->out;
    parent::serialize();
    $out->writeInt($this->req->id);
    if (PDB_DEBUG) pdb_Logger::debug( "evalcode:::".$this->req->code."\n");
	$error = 0;
    if ($this->req->code[0]=='$') {

	  $this->session->end = true;
	  $key = substr($this->req->code, 1);
	  if (isset($this->session->currentFrame->vars[$key])) {
		$var = $this->session->currentFrame->vars[$key];
		$paths = $this->req->paths;
		foreach ($paths as $path) {
		  if (is_object($var)) {
			$var = $var->$path;
		  } else {
			$var = $var[$path];
		  }
		}
	  } else {
		$var = "${key} not found!";
		$error = -1;
	  }
	  $ser = $this->session->serializer->serialize($var, $this->req->depth);
	  $this->session->end = false;

	  $out->writeInt($error);
      $out->writeString($ser);
	  if (PDB_DEBUG) pdb_Logger::debug("pdb_GetVariableValueResponse: ".print_r($var, true).": ${ser}, error: ${error}");
    } else {
	  if (PDB_DEBUG) pdb_Logger::debug(print_r($this->session->currentFrame->vars, true));

	  $this->session->end = true;
	  $vars = $this->session->currentFrame->vars;
	  $ser = $this->session->serializer->serialize($vars, $this->req->depth);
	  $this->session->end = false;

	  $out->writeInt($error);
	  $out->writeString($ser);
	  if (PDB_DEBUG) pdb_Logger::debug("pdb_GetVariableValueResponse: ".print_r($vars, true).": ${ser}, error: ${error}");
	}
    $out->flush();
  }
  public function __toString () {
    return "pdb_GetVariableValueResponse: ";
  }
}

/**
 * @@access private
 */
class pdb_MsgEvalRequest extends pdb_MessageRequest {
  const TYPE = 31;
  public $id;
  public $code;

  public function getType() {
    return self::TYPE;
  }
  public function deserialize() {
    $in = $this->session->in;
    $this->id = $in->readInt();
    $this->code = $in->readString();

    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function ack() {
    $res = new pdb_MsgEvalResponse($this);
    $res->serialize();
  }
  public function __toString () {
    return "pdb_MsgEvalRequest: {$this->code}";
  }
}

/**
 * @@access private
 */
class pdb_GetVariableValueRequest extends pdb_MessageRequest {
  const TYPE = 32;
  public $id;
  public $code;
  public $depth;
  public $paths;

  public function getType() {
    return self::TYPE;
  }
  public function deserialize() {
    $in = $this->session->in;
    $this->id = $in->readInt();
    $this->code = $in->readString();
    $this->depth = $in->readInt();

    $this->paths = array();
    $length = $in->readInt();
    while($length--) {
      $this->paths[] = $in->readString();
    }
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function ack() {
    $res = new pdb_GetVariableValueResponse($this);
    $res->serialize();
  }
  public function __toString () {
    return "pdb_GetVariableValueRequest: {$this->code}, {$this->depth}, paths::".print_r($this->paths, true);
  }
}

/**
 * @@access private
 */
class pdb_StepOverResponse extends pdb_Message {
  const TYPE = 1012;
  private $req;

  public function __construct($req) {
    parent::__construct($req->session);
    $this->req = $req;
  }

  public function getType() {
    return self::TYPE;
  }
  public function serialize() {
    $out = $this->req->session->out;
    parent::serialize();
    $out->writeInt($this->req->id);
    $out->writeInt(0);
    $out->flush();
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function __toString () {
    return "pdb_StepOverResponse: ";
  }
}

/**
 * @@access private
 */
class pdb_StepOverRequest extends pdb_MessageRequest {
  const TYPE = 12;
  public $id;
  
  public function getType() {
    return self::TYPE;
  }
  public function deserialize() {
    $in = $this->session->in;
    $this->id = $in->readInt();
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function ack() {
    $res = new pdb_StepOverResponse($this);
    $res->serialize();
  }
  public function __toString () {
    return "pdb_StepOverRequest: ";
  }
}

/**
 * @@access private
 */
class pdb_StepIntoResponse extends pdb_StepOverResponse {
  const TYPE = 1011;
  public function getType() {
    return self::TYPE;
  }
  public function __toString () {
    return "pdb_StepIntoResponse: ";
  }
}

/**
 * @@access private
 */
class pdb_StepIntoRequest extends pdb_StepOverRequest {
  const TYPE = 11;
  public function getType() {
    return self::TYPE;
  }
  public function ack() {
    $res = new pdb_StepIntoResponse($this);
    $res->serialize();
  }
  public function __toString () {
    return "pdb_StepIntoRequest: ";
  }
}

/**
 * @@access private
 */
class pdb_StepOutResponse extends pdb_StepOverResponse {
  const TYPE = 1013;
  public function getType() {
    return self::TYPE;
  }
  public function __toString () {
    return "pdb_StepOutResponse: ";
  }
}

/**
 * @@access private
 */
class pdb_StepOutRequest extends pdb_StepOverRequest {
  const TYPE = 13;
  public function getType() {
    return self::TYPE;
  }
  public function ack() {
    $res = new pdb_StepOutResponse($this);
    $res->serialize();
  }
  public function __toString () {
    return "pdb_OutIntoRequest: ";
  }
}

/**
 * @@access private
 */
class pdb_GoResponse extends pdb_Message {
  const TYPE = 1014;
  private $req;

  public function __construct ($req) {
    parent::__construct($req->session);
    $this->req = $req;
  }

  public function getType() {
    return self::TYPE;
  }
  public function serialize() {
    $out = $this->session->out;
    parent::serialize();
    $out->writeInt($this->req->id);
    $out->writeInt(0);
    $out->flush();
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function __toString () {
    return "pdb_GoResponse: ";
  }
}

/**
 * @@access private
 */
class pdb_GoRequest extends pdb_MessageRequest {
  const TYPE = 14;
  public $id;
 
  public function getType() {
    return self::TYPE;
  }
  public function deserialize() {
    $in = $this->session->in;
    $this->id = $in->readInt();
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function ack() {
    $res = new pdb_GoResponse($this);
    $res->serialize();
  }
  public function __toString () {
    return "pdb_GoRequest: ";
  }
}
/**
 * @@access private
 */
class pdb_End extends pdb_Message {
  const TYPE = 3;
  public $id;
 
  public function getType() {
    return self::TYPE;
  }
  public function deserialize() {
    if (PDB_DEBUG) pdb_Logger::debug( "$this");
  }
  public function __toString () {
    return "pdb_End: ";
  }
}

/**
 * @@access private
 */
class pdb_In {
  private $in;
  private $len;
  private $session;

  public function __construct($in, $session) {
    $this->in = $in;
    $this->len = 0;
	$this->session = $session;
  }
  private function readBytes($n) {
    $str = "";
    while ($n) {
      $s = fread($this->in, $n);
	  if (feof($this->in)) $this->session->end();

      $n -= strlen($s);

      $str.=$s;
    }
    return $str;
  }
  public function read() {
    if(!$this->len) {
      $str = $this->readBytes(4);
      $lenDesc = unpack("N", $str);
      $this->len = array_pop($lenDesc);
    }
  }
  public function readShort() {
    $this->read();

    $this->len-=2;
    $str = $this->readBytes(2);
    $lenDesc = unpack("n", $str);
    return array_pop($lenDesc);
  }
  public function readInt() {
    $this->read();

    $this->len-=4;
    $str = $this->readBytes(4);
    $lenDesc = unpack("N", $str);
    return array_pop($lenDesc);
  }
  public function readString() {
    $this->read();

    $length = $this->readInt();
    $this->len-=$length;
    return $this->readBytes($length);
  }
  public function __toString () {
    return "pdb_In: ";
  }
}
/**
 * @@access private
 */
class pdb_Out {
  private $out;
  private $buf;
  private $session;
  
  public function __construct($out, $session) {
    $this->out = $out;
    $this->buf = "";
	$this->session = $session;
  }

  public function writeShort($val) {
    $this->buf.=pack("n", $val);
  }
  public function writeInt($val) {
    $this->buf.=pack("N", $val);
  }
  public function writeString($str) {
    $length = strlen($str);
    $this->writeInt($length);
    $this->buf.=$str;
  }
  public function writeUTFString($str) {
    $this->writeString(urlencode($str));
  }
  public function flush() {
    $length = strlen($this->buf);
    $this->buf = pack("N", $length).$this->buf;
    fwrite($this->out, $this->buf);
	if (feof($this->out)) $this->session->end();
    $this->buf = "";
  }
  public function __toString () {
    return "pdb_Out: ";
  }
}
$pdb_dbg = new pdb_DebugSessionStart("&debug_fastfile=1");
pdb_Message::register(new pdb_SetProtocolRequest($pdb_dbg));
pdb_Message::register(new pdb_StartRequest($pdb_dbg));
pdb_Message::register(new pdb_AddFilesRequest($pdb_dbg));
pdb_Message::register(new pdb_FileContentExtendedRequest($pdb_dbg));
pdb_Message::register(new pdb_ContinueProcessFileNotification($pdb_dbg));
pdb_Message::register(new pdb_AddBreakpointRequest($pdb_dbg));
pdb_Message::register(new pdb_RemoveBreakpointRequest($pdb_dbg));
pdb_Message::register(new pdb_RemoveAllBreakpointsRequest($pdb_dbg));
pdb_Message::register(new pdb_GetCallStackRequest($pdb_dbg));
pdb_Message::register(new pdb_GetCWDRequest($pdb_dbg));
pdb_Message::register(new pdb_GetVariableValueRequest($pdb_dbg));
pdb_Message::register(new pdb_MsgEvalRequest($pdb_dbg));
pdb_Message::register(new pdb_StepOverRequest($pdb_dbg));
pdb_Message::register(new pdb_StepIntoRequest($pdb_dbg));
pdb_Message::register(new pdb_StepOutRequest($pdb_dbg));
pdb_Message::register(new pdb_GoRequest($pdb_dbg));
pdb_Message::register(new pdb_End($pdb_dbg));

pdb_Message::register(new pdb_StartProcessFileNotification($pdb_dbg));
pdb_Message::register(new pdb_ReadyNotification($pdb_dbg));
pdb_Message::register(new pdb_DebugScriptEndedNotification($pdb_dbg));
pdb_Message::register(new pdb_HeaderOutputNotification($pdb_dbg));
pdb_Message::register(new pdb_OutputNotification($pdb_dbg));
pdb_Message::register(new pdb_ErrorNotification($pdb_dbg));

/**
 * @@access private
 */
function pdb_getDefinedVars($vars1, $vars2) {
  //if(isset($vars2)) $vars1['pbd_This'] = $vars2;

  unset($vars1['__pdb_Code']);	     // see pdb_Message::doEval()

  return $vars1;   
}
/**
 * @@access private
 */
function pdb_startCall($scriptName, $line) {
  global $pdb_dbg;

  $stepNext = $pdb_dbg->currentFrame->stepNext == pdb_StepIntoRequest::TYPE ? pdb_StepIntoRequest::TYPE : false;

  pdb_Logger::debug("startCall::$scriptName, $stepNext");

  $env = new pdb_Environment($pdb_dbg->currentFrame, $scriptName, $stepNext, $line);
  $pdb_dbg->allFrames[] = $env;

  return $env;
}

/**
 * @@access private
 */
function pdb_startInclude($scriptName, $once) {
  global $pdb_dbg;

  $scriptName = $pdb_dbg->resolveIncludePath($scriptName);

  // include only from a top-level environment
  // initial line# and vars may be wrong due to a side-effect in step
  $pdb_dbg->session->currentFrame = $pdb_dbg->session->currentTopLevelFrame;

  $stepNext = $pdb_dbg->currentFrame->stepNext == pdb_StepIntoRequest::TYPE ? pdb_StepIntoRequest::TYPE : false;
  $pdb_dbg->currentFrame = new pdb_Environment($pdb_dbg->currentFrame, $scriptName, $stepNext, 1);
  $pdb_dbg->allFrames[] = $pdb_dbg->currentFrame;

  /* BEGIN: StartProcessFileNotification */
  $pdb_dbg->getMessageById(pdb_StartProcessFileNotification::TYPE)->handleRequests();
  /* ...  set breakpoints ... */
  /* END: ContinueProcessFileNotification */

  if ($once && isset($pdb_dbg->includedScripts[$scriptName]))
	$code = "<?php ?>";
  else
	$code = $pdb_dbg->parseCode(realpath($scriptName), file_get_contents($scriptName));

  $pdb_dbg->currentTopLevelFrame = $pdb_dbg->currentFrame;

  if (PDB_DEBUG) pdb_Logger::debug("include:::$code");

  if ($once) $pdb_dbg->includedScripts[$scriptName] = true;
  return $code; // eval -> pdb_step/MSG_READY or pdb_endInclude/MSG_READY OR FINISH
}
/**
 * @@access private
 */
function pdb_endInclude() {
  global $pdb_dbg;

  $pdb_dbg->currentFrame = $pdb_dbg->currentTopLevelFrame = $pdb_dbg->currentTopLevelFrame->parent;
}


/**
 * @@access private
 */
function pdb_step($filename, $line, $vars) {
  global $pdb_dbg;
  if ($pdb_dbg->ignoreInterrupt) return;

  $pdb_dbg->ignoreInterrupt = true;

  // pull the current frame from the stack or the top-level environment
  $pdb_dbg->currentFrame = (isset($vars['__pdb_CurrentFrame'])) ? $vars['__pdb_CurrentFrame'] : $pdb_dbg->currentTopLevelFrame;
  unset($vars['__pdb_CurrentFrame']);

  $pdb_dbg->currentFrame->update($line, $vars);

  if ($pdb_dbg->hasBreakpoint($filename, $line)) {
	$pdb_dbg->flushOutput();
	$stepNext = $pdb_dbg->getMessageById(pdb_ReadyNotification::TYPE)->handleRequests();
	pdb_Logger::logDebug("continue");
	/* clear all dynamic breakpoints */
	foreach ($pdb_dbg->allFrames as $currentFrame)
	  $currentFrame->stepNext = false;

	/* set new dynamic breakpoint */
	if ($stepNext != pdb_GoRequest::TYPE) {
	  $currentFrame = $pdb_dbg->currentFrame;

	  /* break in current frame or frame below */
	  if ($stepNext != pdb_StepOutRequest::TYPE)
		$currentFrame->stepNext = $stepNext;

	  /* or break in any parent */
	  while ($currentFrame = $currentFrame->parent) {
		$currentFrame->stepNext = $stepNext;
	  }
	}
  }
  $pdb_dbg->ignoreInterrupt = false;
}

/**
 * @@access private
 */
function pdb_error_handler($errno, $errstr, $errfile, $errline) {
  global $pdb_dbg;
  if (PDB_DEBUG) pdb_Logger::debug("PHP error $errno: $errstr in $errfile line $errline");
  if ($pdb_dbg->end) return false;

  $msg = $pdb_dbg->getMessageById(pdb_ErrorNotification::TYPE);
  $msg->setError($errno, $errfile, $errline, $errstr);
  $msg->serialize();
  return true;
}

/**
 * @@access private
 */
function pdb_shutdown() {
  global $pdb_dbg;
  if (PDB_DEBUG) pdb_Logger::debug("PHP error: ".print_r(error_get_last(), true));
  if ($pdb_dbg->end) return;

  $error = error_get_last();
  if ($error) {
	$msg = $pdb_dbg->getMessageById(pdb_ErrorNotification::TYPE);
	$msg->setError($error['type'], $error['file'], $error['line'], $error['message']);
	$msg->serialize();
  }
}


function pdb_getDebugHeader($name,$array) {
  if (array_key_exists($name,$array)) return $array[$name];
  $name="HTTP_$name";
  if (array_key_exists($name,$array)) return $array[$name];
  return null;
}


if (!isset($java_include_only) && isset($pdb_script) && $pdb_script!="@@") { // not called from JavaProxy.php and pdb_script is set
	chdir (dirname ($pdb_script));
	$pdb_dbg->handleRequests();
}

?>
@


1.19
log
@Release-7.0.1
@
text
@@


1.18
log
@Version 7.0.0 for PHP 7 released
@
text
@a80 4
			if(pdb_getDebugHeader("X_JAVABRIDGE_INCLUDE", $_SERVER)>=10) { // include Java.inc as well
				require_once("Java.inc");
			}
			chdir (dirname ($pdb_script));
d813 2
a814 1
	} else {
d816 3
d843 9
a851 1
    $io = fsockopen($args["debug_host"], $args['debug_port'], $errno, $errstr, 5) or trigger_error("fsockopen", E_USER_ERROR);
d2291 2
a2292 1
if (isset($pdb_script) && pdb_script!="@@") {
a2293 1
	require_once($pdb_script);
@


1.17
log
@Clear the old communication so that the session file doesn't grow
@
text
@d4 5
a8 1
   *  PHPDebugger.php -- The PHP debugger (JavaScript GUI)
d10 1
a10 3
   * Copyright (C) 2009 Jost Boekemeier
   * 
   * The PHPDebugger ("the library") is free software; you can
d17 1
a17 1
   * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
d21 1
a21 1
   * along with the PHPDebugger; see the file COPYING. If not, write to the
d26 1
a26 1
   * making a combined work based on this library. Thus, the terms and
d36 2
a37 2
   * module. An independent module is a module which is not derived from
   * or based on this library. If you modify this library, you may extend
d39 1
a39 1
   * obligated to do so. If you do not wish to do so, delete this
d42 3
a44 1
   * Usage:
d46 5
a50 1
   * - include() this file at the beginning of your script
d52 8
a59 1
   * - browse to your script using firefox 
a60 3
   * - set breakpoints using the JavaScript GUI, click on any variable or included file to visit that variable or file
   * 
   * - click on the stop button to terminate the debug session
d65 2
a66 2
   * @@license    GPL
   * @@version    1.0
a67 1
   * @@see        PHPDebugger.inc
d70 1
d74 3
d78 12
a89 28
$pdb_version = phpversion();
if ((version_compare("5.3.0", $pdb_version, ">")))
  trigger_error("<br><strong>PHP ${pdb_version} too old.</strong><br>\nPlease set the path to a PHP >= 5.3 executable, see php_exec in the WEB-INF/web.xml", E_USER_ERROR);

 
/**
 * a simple logger
 * @@access private
 */
class pdb_Logger {
  const FATAL = 1;
  const INFO = 2;
  const VERBOSE = 3;
  const DEBUG = 4;

  private static $logLevel = 0;
  private static $logFileName;
  private static function println($msg, $level) {
	if (!self::$logLevel) self::$logLevel=PDB_DEBUG?self::DEBUG:self::INFO;
	if ($level <= self::$logLevel) {
	  static $file = null;
	  if(!isset(self::$logFileName)) {
		self::$logFileName = $_SERVER['DOCUMENT_ROOT'].DIRECTORY_SEPARATOR."pdb_PHPDebugger.log";
	  }
	  if (!$file) $file = fopen(self::$logFileName, "ab") or die("fopen");
	  fwrite($file, time().": ");
	  fwrite($file, $msg."\n");
	  fflush($file);
a90 65
  }

  public static function logFatal($msg) {
	self::println($msg, self::FATAL);
  }
  public static function logInfo($msg) {
	self::println($msg, self::INFO);
  }
  public static function logMessage($msg) {
	self::println($msg, self::VERBOSE);
  }
  public static function logDebug($msg) {
	self::println($msg, self::DEBUG);
  }
  public static function debug($msg) {
	self::logDebug($msg);
  }
  public static function log($msg) {
	self::logMessage($msg);
  }
  public static function setLogLevel($level) {
	self::$logLevel=$level;
  }
  public static function setLogFileName($name) {
	self::$logFileName = $name;
  }
}

/**
 * @@access private
 */
interface pdb_Queue {

  /** 
   * Read a string from the queue
   * @@return string a json encoded string of values
   * @@access private
   */
  public function read();

  /**
   * Write a string to the queue
   * @@param string a json encoded string of values or TRUE
   * @@access private
   */
  public function write($val);

  /**
   * Set the script output before server shutdown
   * @@access private
   */
  public function setOutput($output);

  /**
   * Get the script output
   * @@access private
   */
  public function getOutput();

  /**
   * Mark the channel as dead. If marked, read will return boolean
   * TRUE, write will do nothing.
   * @@access private
   */
  public function shutdown();
a92 192
/**
 * This class represents the debugger back end connection. It
 * communicates with the debugger front end using a shared-memory queue.
 * It is slow, but it does not require any special library.
 * @@access private
 */
class pdb_PollingServerConnection implements pdb_Queue {
  protected $id;
  protected $role, $to;
  protected $chanTrm; // "back end terminated" flag
  protected $output;
  const TIMER_DURATION = 200000; // every 200ms

  /**
   * Create a new communication using a unique id
   * @@access private
   */
  public function pdb_PollingServerConnection($id) {
	$this->id = $id;
	$this->chanTrm = "pdb_trmserver{$this->id}";
	$this->output = "<missing>";

	$this->prepareCookies();
	$this->init();
  }

  protected function checkTrm() {
	return false!==$_SESSION[$this->chanTrm];
  }

  protected function prepareCookies() {
	ini_set("session.use_cookies", true);
	session_start();
	session_write_close();

	/* avoid PHP bug, which repeats set-cookie header for each
	   iteration of session_start/session_write_close */
	ini_set("session.use_cookies", false);
  }

  protected function init() {
	session_start();

	$this->role = "client";
	$this->to  = "server";

	$chanCtr = "pdb_ctr{$this->role}{$this->id}";
	$chan = "pdb_{$this->role}{$this->id}";
	unset ($_SESSION[$chan]);
	unset ($_SESSION[$chanCtr]);

	$this->role = "server";
	$this->to  = "client";

	$chanCtr = "pdb_ctr{$this->role}{$this->id}";
	$chan = "pdb_{$this->role}{$this->id}";
	unset ($_SESSION[$chan]);
	unset ($_SESSION[$chanCtr]);

	if (isset($_SESSION[$this->chanTrm]) && !$this->checkTrm()) {
	  $_SESSION[$this->chanTrm] = true;
	  session_write_close();
	  sleep(1);
	  session_start();
	}
	$_SESSION[$this->chanTrm] = false;
	session_write_close();
  }

  protected function poll() {
	$val = "";
	$chanCtr = "pdb_ctr{$this->role}{$this->id}";
	$chan = "pdb_{$this->role}{$this->id}";
	session_start();
	if (!($val = $this->checkTrm())) {
	  if(!isset($_SESSION[$chanCtr])) { 
		$_SESSION[$chan] = array(); 
		$_SESSION[$chanCtr]=0; 
	  }
	  $seq = $_SESSION[$chanCtr];
	  $seqNext = count($_SESSION[$chan]);
	  if (PDB_DEBUG) pdb_Logger::debug("...{$this->role}, {$this->id} poll next # ${seqNext} (${seq}) ...");
	  if ($seqNext > $seq) {
		$val = json_decode($_SESSION[$chan][$seq]);
		$_SESSION[$chan][$seq]=null;
		$_SESSION[$chanCtr]++;
		if (PDB_DEBUG) pdb_Logger::debug("...{$this->role}, {$this->id} polled next # ${seqNext} (${seq}), got: {$val->seq}");
	  }
	}
	session_write_close();
	return $val;
  }
  protected function send($val) {
	
	$seq = $val->seq;
	$chan = "pdb_{$this->to}{$this->id}";
	session_start();
	if (!$this->checkTrm()) $_SESSION[$chan][$seq]=json_encode($val);
	if (PDB_DEBUG) pdb_Logger::debug("...{$this->role}, {$this->id} send: ${seq} ...");
	session_write_close();
  }

  /**
   * read a new value from the read queue
   * @@access private
   */
  public function read() {
	$val = null;
	$cntr = 0;
	while(!($val=$this->poll())) {
	  if ($cntr<=20) {
		$cntr++;
		usleep(self::TIMER_DURATION);
	  } else {
		usleep(self::TIMER_DURATION*5);
	  }
	}
	return $val === true ? null : $val;
  }

  /**
   * write a new value to the write queue
   * @@access private
   */
  public function write($val) {
	$this->send((object)$val);
  }

  /**
   * Set the script output
   * @@access private
   */
  public function setOutput($output) {
	$this->output = $output;
  }
  /**
   * Get the script output
   * @@access private
   */
  public function getOutput() {
	return $_SESSION[$this->chanTrm];
  }

  /**
   * shut down the communication channel
   */
  public function shutdown() {
	if (PDB_DEBUG) pdb_Logger::debug("session terminated: {$this->chanTrm}");
	session_start();
	$_SESSION[$this->chanTrm] = $this->output;
	session_write_close();
  }
}  

/**
 * This class represents the debugger front end connection. It
 * communicates with the debugger back end using a shared-memory queue.
 * It is slow, but it does not require any special library.
 * @@access private
 */
class pdb_PollingClientConnection extends pdb_PollingServerConnection {
  private $seq;

  protected function init() {
	$this->role = "client";
	$this->to  = "server";
  }

  protected function poll() {
	$chan = "pdb_{$this->role}{$this->id}";
	session_start();
	if (!($val = $this->checkTrm())) {
	  if (PDB_DEBUG) pdb_Logger::debug("...{$this->role}, {$this->id} poll for {$this->seq} ...");
	  if (isset($_SESSION[$chan][$this->seq])) {
		$val = json_decode($_SESSION[$chan][$this->seq]);
		if (PDB_DEBUG) pdb_Logger::debug("...{$this->role}, {$this->id} polled for {$this->seq}, got: {$val->seq}");
		unset($_SESSION[$chan][$this->seq]);
	  }
	}
	session_write_close();
	return $val;
  }

  /**
   * write a new value to the write queue
   * @@access private
   */
  public function write($val) {
	$this->seq = $val->seq;

	parent::write($val);
  }
a93 6
  /**
   * shut down the communication channel
   * @@access private
   */
  public function shutdown() {}
}
d118 1
a118 1
	public function pdb_Parser($scriptName, $content) {
d281 1
a281 1
	  if (PDB_DEBUG) pdb_Logger::debug("parse:::$type");
d289 1
a289 1
		  if (PDB_DEBUG) pdb_Logger::debug(":::".$token);
d317 1
a317 1
		  if (PDB_DEBUG) pdb_Logger::debug(":::".$token[1].":(".token_name($token[0]).')');
a507 1

a508 2
 * This structure represents the debugger front-end. It is used by the
 * JavaScript code to communicate with the debugger back end.
d511 31
a541 5
class pdb_JSDebuggerClient {
  private static function getDebuggerFilename() {
	$script = __FILE__;
	$scriptName = basename($script);
	return realpath($scriptName == "PHPDebugger.php" ? $script :"java/PHPDebugger.php");
d543 2
a544 31
	
  private static function getCurrentRootDir() {
	$scriptName = $_SERVER['SCRIPT_NAME'];
	$scriptFilename = $_SERVER['SCRIPT_FILENAME'];
 
	$scriptDirName = dirname($scriptName);
	$scriptDir   = dirname($scriptFilename);
 
	if ((strlen($scriptDirName)>1) && ($scriptDirName[1]=='~')) {
	  $scriptDirName = ltrim($scriptDirName, "/");
	  $idx = strpos($scriptDirName, '/');
	  $scriptDirName = $idx===false ? '' : substr($scriptDirName, $idx);
	} elseif ((strlen($scriptDirName)==1) && (($scriptDirName[0]=='/') || ($scriptDirName[0]=='\\'))) {
	  $scriptDirName = '';
	}
	if (PDB_DEBUG) pdb_Logger::debug("scriptDir: $scriptDir, scriptDirName: $scriptDirName");

	if ((strlen($scriptDir) < strlen($scriptDirName)) || ($scriptDirName &&
														  (substr($scriptDir, -strlen($scriptDirName)) != $scriptDirName)))
	  return null;
	else
	  return substr($scriptDir, 0, strlen($scriptDir)-strlen($scriptDirName));
  }
  /*
   * Return the script name
   * Example: %2Fopt%2Fappserv%2Fapache-tomcat-6.0.14%2Fwebapps%2FJavaBridge%2Ftest.php"
   *
   * @@return An urlencoded file name.
   */
  public static function getDebugScriptName() {
	return urlencode($_SERVER['SCRIPT_FILENAME']);
d546 2
a547 45
  /**
   * Return the debugger URL. 
   * Example: "/JavaBridge/java/PHPDebugger.php?source=settings.php"
   *
   * @@return The debugger URL.
   * @@access private
   */
  public static function getDebuggerURL() {
	$path = self::getDebuggerFilename();
	if (!$path) 
	  trigger_error("java/PHPDebugger.php not found in document root", E_USER_ERROR);

	$root = self::getCurrentRootDir();

	$scriptName = $_SERVER['SCRIPT_NAME'];

	$scriptDirName = dirname($scriptName);
	$prefix = '';
	if ((strlen($scriptDirName)>1) && ($scriptDirName[1]=='~')) {
	  $scriptDirName = ltrim($scriptDirName, "/");
	  $idx = strpos($scriptDirName, '/');
	  $prefix = '/' . ($idx ? substr($scriptDirName, 0, $idx): $scriptDirName);
	}
  
	if (PDB_DEBUG) pdb_Logger::debug("serverRoot: $root - path: $path");
	if ($root && (strlen($root) < strlen($path)) && (!strncmp($path, $root, strlen($root))))
	  $path = "${prefix}" . str_replace('\\', '/', substr($path, strlen($root)));
	else // could not calculate debugger path
	  $path = dirname($_SERVER['SCRIPT_NAME']) . "/java/PHPDebugger.php";

	$pathInfo = isset($_SERVER['PATH_INFO']) ? $_SERVER['PATH_INFO'] : "";
	$query = isset($_SERVER['QUERY_STRING']) ? $_SERVER['QUERY_STRING'] : "";

	$url = "${path}${pathInfo}";
	if ($query) $url .= "?${query}";
	return $url;
  }

  public static function getPostData() {
	$str = '';
	foreach ($_POST as $key => $value) {
	  if ($str) $str .= '&';
	  $str .= $key . '=' . urlencode($value);
	}
	return $str;
d549 2
a550 9

  /**
   * Get the server's uniqe session ID
   * @@return a uniqe session ID
   * @@access private
   */ 
  public static function getServerID() {
	// TODO: allow more than one debug session
	return 1;
d552 2
a553 3
 
  private static function getConnection($id) {
	return new pdb_PollingClientConnection($id);
d555 2
a556 31
  private static function stripslashes($value) {
	 $value = is_array($value) ?
	   array_map("self::stripslashes", $value) :
	   stripslashes($value);
	 
	 return $value;
   }

  /**
   * Pass the command and arguments to the debug back end and
   * output the response to JavaScript.
   *
   * @@arg array The command arguments
   * @@access private
   */
  public static function handleRequest($vars) {
		if (get_magic_quotes_gpc()) $vars = self::stripslashes($vars);
	$msg = (object)$vars;
	
	if ($msg->cmd == "begin") sleep(1); // wait for the server to settle
	if (PDB_DEBUG) pdb_Logger::debug("beginHandleRequest: ".$msg->cmd);
	$conn = self::getConnection($msg->serverID);
	$conn->write($msg);

	if (!($response = $conn->read())) 
	  $output = json_encode(array("cmd"=>"term", "output"=>$conn->getOutput()));
	else
	  $output = json_encode($response);
	
	echo "($output)";
	if (PDB_DEBUG) pdb_Logger::debug("endHandleRequest");
a560 5
 * The current view frame. Contains the current script name. May be
 * selected by clicking on a include() hyperlink Allows users to set
 * breakpoints for this file.
 *
 * View will be discarded when go, step, end is invoked.
d563 3
a565 4
class pdb_View {
  /** The current script name */
  public $scriptName;
  /** Back-link to the parent or null */
d568 1
a568 7
  protected $bpCounter, $lineCounter, $code;
  /**
   * Create a new view frame
   * @@param object the parent frame
   * @@param string the script name
   */
  public function pdb_View($parent, $scriptName) {
d570 4
a573 4
	$this->scriptName = $scriptName;

	$this->bpCounter = $this->lineCounter = 1;
	$this->code = null;
d576 3
a578 2
  private function lineCB ($val) {
	return $val.(string)$this->lineCounter++;
d580 2
a581 9
  private function breakpointCB ($val) {
	return 	$val.'id="bp_'.(string)$this->bpCounter++.'"';
  }
  function replaceCallback($code, $split, $cb) {
	$ar = explode($split, $code);
	$last = array_pop($ar);
	$ar = array_map($cb, $ar);
	array_push($ar, $last);
	return implode($ar);
d583 1
d585 5
d591 1
a591 12
  /**
   * Return a HTML representation of the current script
   * @@return string the clickable HTML representation of the current script
   */
  public function getHtmlScriptSource() {
	if (!$this->code) {
	  $c=
		'<span class="breakpoint" id="bp_" onmousedown="return toggleBreakpoint(this, event);">'.
		'<span class="currentlineIndicator normal"></span>'.
		'<span class="linenumber">line#</span>'.
		'<span class="breakpointIndicator normal"></span>'.
		'</span><br />';
d593 3
a595 1
	  $code=show_source($this->scriptName, true);
d597 3
a599 4
	  // br => span id=pb_ ...
	  $code = str_replace('<br />', $c, $code);
	  // handle incomplete last line, identical to preg: '|(?<!<br >)</span>\n</span>\n</code>$|'
	  $code = ereg_replace('"(([^>])|([^/]>)|([^ ]/>)|([^r] />)|([^b]r />)|([^<]br />))(</span>\n</span>\n</code>)"', '\1 $c \8', $code);
d601 15
a615 2
	  $code = $this->replaceCallback($code, 'id="bp_"', array($this, "breakpointCB"));
	  $code = $this->replaceCallback($code, 'line#', array($this, "lineCB"));
d617 15
a631 4
	  $this->code = $code;
	}

	return $this->code;
d633 2
a634 15
}
/**
 * The current view. Used to show the contents of a variable
 * @@access private
 */
class pdb_VariableView extends pdb_View {
  /**
   * Create a new variable view
   * @@param object the parent frame
   * @@param string the variable name
   * @@param string the variable value
   */
  public function pdb_VariableView($parent, $name, $value) {
	parent::pdb_View($parent, $name);
	$this->value = $value;
d636 5
a640 5
  /**
   * {@@inheritDoc}
   */
  public function getHtmlScriptSource() {
	return (highlight_string(print_r($this->value, true), true));
d642 72
d715 1
a716 2
 * The current execution frame. Contains the current run-time script
 * name along with its state
d719 126
a844 7
class pdb_Environment extends pdb_View {
  /** bool true if a dynamic breakpoint should be inserted at the next line, false otherwise */
  public $stepNext;
  /** The execution vars */
  public $vars;
  /** The current line */
  public $line;
d846 8
d855 1
a855 3
   * Create a new execution frame
   * @@param string the script name
   * @@param bool true if a dynamic breakpoint should be inserted at the next line, false otherwise
d857 7
a863 4
  public function pdb_Environment($parent, $scriptName, $stepNext) {
	parent::pdb_View($parent, $scriptName);
	$this->stepNext = $stepNext;
	$this->line = -1;
d865 1
d867 1
a867 4
   * Update the execution frame with the current state
   * @@param string the current script name
   * @@param int the current execution line
   * @@param mixed the current variables
d869 47
a915 3
  public function update ($line, &$vars) {
	$this->line = $line;
	$this->vars = $vars;
d919 1
a919 1
	return "pdb_Environment: {$this->scriptName}, {$this->line}";
d922 2
a924 1
 * Represents a breakpoint
d927 37
a963 9
class pdb_Breakpoint {
  /** The script name */
  public $scriptName;
  /** The current line */
  public $line;
  /** The breakpointName as seen by JavaScript */
  public $breakpoint;
  /* The breakpoint type (not used yet) */
  public $type;
d965 10
a974 10
  /**
   * Create a new breakpoint
   * @@param string the breakpoint name
   * @@param string the script name
   * @@param int the line
   */
  public function pdb_Breakpoint($breakpointName, $scriptName, $line) {
	$this->breakpoint = $breakpointName;
	$this->scriptName = $scriptName;
	$this->line = $line;
d976 26
a1001 1
	$this->type = 1;
d1003 2
a1004 5
  /**
   * @@return the string representation of the breakpoint
   */
  public function __toString() {
	return "{$this->line}@@{$this->scriptName}, js name: ({$this->breakpoint}, type: {$this->type})";
d1007 1
a1008 3
 * The current debug session. Contains the current environment stack,
 * script output and all breakpoints set by the client. An optional
 * view is set by the switchView command.
d1011 6
a1016 3
final class pdb_Session {
  /** The collection of breakpoints */
  public $breakpoints;
d1018 11
a1028 10
  /** List of all frames */
  public $allFrames;
  /** The current top level frame */
  public $currentTopLevelFrame;
  /** The current execution frame */
  public $currentFrame;
  /** The current view */
  public $currentView;
  /** The script output */
  public $output;
a1029 8
  /**
   * Create a new debug session for a given script
   * @@param string the script name
   */
  public function pdb_Session($scriptName) {
	$this->breakpoints = $this->lines = array();
	$this->currentTopLevelFrame = $this->currentFrame = new pdb_Environment(null, $scriptName, true);
	$this->allFrames[] = $this->currentFrame;
d1031 8
a1038 1
	$this->currentView = null;
d1040 3
a1042 13
  /**
   * Return the clickable HTML script source, either from the cusom view or from the current frame
   * @@return string the HTML script source
   */
  public function getCurrentViewHtmlScriptSource () {
	return $this->currentView ? $this->currentView->getHtmlScriptSource() : $this->currentFrame->getHtmlScriptSource();
  }   
  /**
   * Return the current frame script name
   * @@return string the script name of the current frame
   */
  public function getScriptName () {
	return $this->currentFrame->scriptName;
d1044 9
a1052 18
  /**
   * Return the current script name, either from the view or from the current frame
   * @@return string the current script name
   */
  public function getCurrentViewScriptName () {
	return $this->currentView ? $this->currentView->scriptName : $this->getScriptName();
  }   
  /**
   * Return the breakpoints for the current script
   * @@return object the breakpoints
   */
  public function getBreakpoints () {
	$bp = array();
	foreach ($this->breakpoints as $breakpoint) {
	  if ($this->getCurrentViewScriptName() != $breakpoint->scriptName) continue;
	  array_push($bp, $breakpoint->breakpoint);
	}
	return $bp;
d1054 2
a1055 15
  /**
   * toggle and write breakpoint reply
   * @@param object the current comm. channel
   * @@param object the breakpoint
   */
  public function toggleBreakpoint($breakpoint) {
	$id = $breakpoint."@@".$this->getCurrentViewScriptName();
	if (!isset($this->breakpoints[$id])) {
	  $this->breakpoints[$id] = new pdb_Breakpoint($breakpoint, $this->getCurrentViewScriptName(), substr($breakpoint, 3));
	  return false;
	} else {
	  $bp = $this->breakpoints[$id];
	  unset ($this->breakpoints[$id]);
	  return $bp;
	}
d1057 9
a1065 8
  /**
   * check if there's a breakpoint
   * @@param string the script name
   * @@param int the line within the script 
   * @@return true if a breakpoint exists at line, false otherwise
   */
  public function hasBreakpoint($scriptName, $line) {
	if ($this->currentFrame->stepNext) return true;
d1067 15
a1081 7
	foreach ($this->breakpoints as $breakpoint) {
	  if (PDB_DEBUG) pdb_Logger::debug("process breakpoint::: $scriptName, $line:: $breakpoint");
	  if($breakpoint->type==1) {
		if ($breakpoint->scriptName==$scriptName&&$breakpoint->line==$line) return true;
	  }
	}
	return false;
d1083 12
a1094 9
  /**
   * parse code
   * @@param string the script name
   * @@param string the content
   * @@return the parsed script
   */
  public function parseCode($scriptName, $content) {
	$parser = new pdb_Parser($scriptName, $content);
	return $parser->parseScript();
d1096 3
a1098 2
  private static function doEval($__pdb_Code) {
	return eval ("?>".$__pdb_Code);
d1100 4
a1103 6
  /**
   * parse and execute script
   * @@return the script output
   */
  public function evalScript() {
	$code = $this->parseCode($this->getScriptName(), file_get_contents($this->getScriptName()));
d1105 2
a1106 5
	if (PDB_DEBUG) pdb_Logger::debug("eval:::$code,".$this->getScriptName()."\n");
	ob_start();
	self::doEval ($code);
	$this->output = ob_get_contents();
	ob_end_clean();
d1108 5
a1112 1
	return $this->output;
a1116 2
 * The java script debugger server daemon. Contains a debug session
 * and handles debug requests from the client.
d1119 13
a1131 14
class pdb_JSDebugger {
  /** The pdb_Session */
  public $session;
  private $id;
 
  public $end;
  private $includedScripts;
  private $conn;
  private $ignoreInterrupt;

  const STEP_INTO = 1;
  const STEP_OVER = 2;
  const STEP_OUT = 3;
  const GO    = 4;
d1133 8
d1142 58
a1199 2
  private function getConnection($id) {
	return new pdb_PollingServerConnection($id);
d1201 1
d1203 27
a1229 5
  /**
   * Create new PHP debugger using a given comm. ID
   * @@param int the communication address
   */
  public function pdb_JSDebugger($id) {
d1231 28
a1258 2
	$this->id = $id;
	$this->conn = $this->getConnection($id);
d1260 25
a1284 8
	$this->end = false;
	$this->session = null;

	$this->includedScripts = array();

	$this->ignoreInterrupt = false;
	set_error_handler("pdb_error_handler");
	register_shutdown_function("pdb_shutdown");
d1286 21
a1306 2
  public function setError($errno, $errfile, $errline, $errstr) {
	highlight_string("PHP error $errno: $errstr in $errfile line $errline");
d1308 2
a1309 6
  /**
   * Return the current comm. ID
   * @@return int the communication address
   */
  public function getServerID() {
	return $this->id;
d1311 9
a1319 6
  /**
   * Read data from the front end
   * @@return object the data 
   */
  public function read() {
	return $this->conn->read();
d1321 2
a1322 8
  /**
   * Write data to the front end
   * @@param object the data
   */
  public function write($data) {
	$data["serverID"] = $this->getServerID();
	if (PDB_DEBUG) pdb_Logger::debug("->".print_r($data, true));
	return $this->conn->write($data);
d1324 2
a1325 3
  private function ack() {
	$this->write(array("cmd"=>$this->packet->cmd,
					   "seq"=>$this->packet->seq));
d1327 1
d1329 6
a1334 2
  private function getOutput() {
	if (!$this->session) return "";
d1336 10
a1345 2
	if (!$this->end) $output = $this->session->output = ob_get_contents();
	return $this->session->output;
d1347 8
d1356 28
a1383 5
  /**
   * Handle requests from the front end
   */
  public function handleRequests() {
	$this->ignoreInterrupt = false;
d1385 8
a1392 30
	while(!$this->end) {
	  if (PDB_DEBUG) pdb_Logger::debug("handleRequests: accept");
   
	  if (!($this->packet = $this->read())) break; // ignore __destructors after shutdown

	  if (PDB_DEBUG) pdb_Logger::debug("handleRequests: done accept ".$this->packet->cmd);

	  switch($this->packet->cmd) {
	  case "status":
		$this->write(array("cmd"=>$this->packet->cmd,
						   "seq"=>$this->packet->seq, 
						   "line"=>$this->session->currentFrame->line, 
						   "scriptName"=>$this->session->getCurrentViewScriptName(), 
						   "breakpoints"=>$this->session->getBreakpoints()));
		break;
	  case "extendedStatus":
		$this->write(array("cmd"=>$this->packet->cmd,
						   "seq"=>$this->packet->seq, 
						   "line"=>$this->session->currentFrame->line, 
						   "scriptName"=>$this->session->getCurrentViewScriptName(), 
						   "script"=>$this->session->getCurrentViewHtmlScriptSource(),
						   "breakpoints"=>$this->session->getBreakpoints()));
		break;
	  case "begin":
		chdir (urldecode($this->packet->cwd));
		$this->session = new pdb_Session(urldecode($this->packet->scriptName));
		$this->write(array("cmd"=>$this->packet->cmd,
						   "seq"=>$this->packet->seq, 
						   "scriptName"=>$this->packet->scriptName, 
						   "script"=>$this->session->getCurrentViewHtmlScriptSource()));
d1394 3
a1396 72
		$this->session->evalScript();
		$this->end = true;
		break;
	  case "stepNext":
		if ($this->end) break;
		$this->session->currentView = null;
		$this->ack();
		return self::STEP_INTO;
	  case "stepOver":
		if ($this->end) break;
		$this->session->currentView = null;
		$this->ack();
		return self::STEP_OVER;
	  case "go":
		if ($this->end) break;
		$this->session->currentView = null;
		$this->ack();
		return self::GO;
	  case "stepOut":
		if ($this->end) break;
		$this->session->currentView = null;
		$this->ack();
		return self::STEP_OUT;
	  case "toggleBreakpoint":
		$bp = $this->session->toggleBreakpoint($this->packet->breakpoint);
		$this->write($bp ? 
					 (array("cmd"=>"unsetBreakpoint", 
							"seq"=>$this->packet->seq,
							"scriptName"=>$bp->scriptName, 
							"breakpoint"=>$bp->breakpoint)) :
					 (array("cmd"=>"setBreakpoint", 
							"seq"=>$this->packet->seq,
							"scriptName"=>$this->session->getCurrentViewScriptName(), 
							"breakpoint"=>$this->packet->breakpoint)));
		break;
	  case "toolTip":
		$name = urldecode($this->packet->item);
		$value = "";
		if ($name[0]=='$') {
		  $idx = substr($name, 1);
		  $env = (object) $this->session->currentFrame->vars;
		  $code = "return \$env->$idx;";
		  $value = eval($code);
		  if (is_object($value)) {
			$value = get_class($value) . " object";
		  } elseif (is_array($value)) {
			$value = "array[".count($value)."]";
		  } elseif (!isset($value)) {
			$value = "<undefined>";
		  } else {
			$value = print_r($value, true);
		  }
		} else {
		  $value = $this->packet->item;
		}
		$this->write(array("cmd"=>$this->packet->cmd,
						   "seq"=>$this->packet->seq,
						   "item"=>$this->packet->item,
						   "value"=>$value));
		break;
	  case "switchView":
		if (PDB_DEBUG) pdb_Logger::debug("switchView here");
		$name = urldecode($this->packet->scriptName);
		if (PDB_DEBUG) pdb_Logger::debug("switchView $name");
		if ($name[0]=='$') {
		  $idx = substr($name, 1);
		  $env = (object) $this->session->currentFrame->vars;
		  $code = "return \$env->$idx;";

		  $pdb_dbg->end = true;
		  $value = eval($code);
		  $pdb_dbg->end = false;
d1398 2
a1399 5
		  $this->session->currentView = new pdb_VariableView($this->session->currentView, $name, $value);
		} else {
		  $this->end = true;
		  $value = self::resolveIncludePath(eval("return ${name};"));
		  $this->end = false;
d1401 6
a1406 25
		  $this->session->currentView = new pdb_View($this->session->currentView, realpath($value));
		}
		$this->ack();
		break;
	  case "backView":
		if ($this->session->currentView)
		  $this->session->currentView = $this->session->currentView->parent;
		$this->ack();
		break;
	  case "output":
		if ($this->session) {
		  $this->write(array("cmd"=>$this->packet->cmd,
							 "seq"=>$this->packet->seq, 
							 "output"=>$this->getOutput()));
		} else {
		  $this->ack();
		}
		break;
	  case "end":
		$this->end();
		break;
	  default:
		if (PDB_DEBUG) pdb_Logger::debug("illegal packet: " . print_r($this->packet, true));
		exit(1);
	  }
a1407 1
	return self::GO;
d1409 14
a1422 6
  public function end() {
	$this->session->currentView = null;
	$this->write(array("cmd"=>"end",
					   "seq"=>$this->packet->seq, 
					   "output"=>$this->getOutput()));
	$this->end = true;
d1424 8
a1431 6
  /**
   * shut down the current comm. channel
   */
  public function shutdown() {
	$this->conn->setOutput($this->getOutput());
	$this->conn->shutdown();
d1434 4
a1437 7
  /**
   * called at run-time for each frame
   * @@return the current frame
   */
  public function startCall($scriptName) {
	/* check for stepOver and stepOut */
	$stepNext = $this->session->currentFrame->stepNext == pdb_JSDebugger::STEP_INTO ? pdb_JSDebugger::STEP_INTO : false;
d1439 1
a1439 4
	if (PDB_DEBUG) pdb_Logger::debug("startCall::$scriptName, $stepNext");
	$env = new pdb_Environment($this->session->currentFrame, $scriptName, $stepNext);
	$this->session->allFrames[] = $env;
	return $env;
d1442 3
a1444 5
  /**
   * @@access private
   */
  protected function resolveIncludePath($scriptName) {
	if (file_exists($scriptName)) return realpath($scriptName);
d1446 2
a1447 9
	$paths = explode(PATH_SEPARATOR, get_include_path());
	$name = $scriptName;
	foreach ($paths as $path) {
	  $x = substr($path, -1);
	  if ($x != "/" && $x != DIRECTORY_SEPARATOR) $path.=DIRECTORY_SEPARATOR;
	  $scriptName = realpath("${path}${name}");
	  if ($scriptName) return $scriptName;
	}
	trigger_error("file $scriptName not found", E_USER_ERROR);
d1449 10
a1458 9
  /**
   * called at run-time for each included file
   * @@param string the script name
   * @@return string the code
   */
  public function startInclude($scriptName, $once) {
	$isDebugger = (basename($scriptName) == "PHPDebugger.php");
	if (!$isDebugger)
	  $scriptName = $this->resolveIncludePath($scriptName);
d1460 2
a1461 1
	if (PDB_DEBUG) pdb_Logger::debug("scriptName::$scriptName, $isDebugger");
d1463 1
a1463 2
	if ($once && isset($this->includedScripts[$scriptName]))
	  $isDebugger = true;
d1465 80
a1544 3
	// include only from a top-level environment
	// initial line# and vars may be wrong due to a side-effect in step
	$this->session->currentFrame = $this->session->currentTopLevelFrame;
d1546 37
a1582 3
	$stepNext = $this->session->currentFrame->stepNext == pdb_JSDebugger::STEP_INTO ? pdb_JSDebugger::STEP_INTO : false;
	$this->session->currentFrame = new pdb_Environment($this->session->currentFrame, $scriptName, $stepNext);
	$this->session->allFrames[] = $this->session->currentFrame;
d1584 30
a1613 4
	if ($isDebugger) // do not debug self
	  $code = "<?php ?>";
	else
	  $code = $this->session->parseCode(realpath($scriptName), file_get_contents($scriptName));
a1614 1
	$this->session->currentTopLevelFrame = $this->session->currentFrame;
d1616 28
a1643 1
	if (PDB_DEBUG) pdb_Logger::debug("startInclude:::".$this->session->currentTopLevelFrame . " parent: " . $this->session->currentTopLevelFrame->parent . " code: ".$code);
d1645 21
a1665 2
	if ($once) $this->includedScripts[$scriptName] = true;
	return $code;
d1667 1
d1669 26
a1694 5
  /**
   * called at run-time after the script has been included
   */
  public function endInclude() {
	if (PDB_DEBUG) pdb_Logger::debug("endInclude:::".$this->session->currentTopLevelFrame . "parent: ".$this->session->currentTopLevelFrame->parent);
d1696 2
a1697 2
	$this->session->currentFrame = $this->session->currentTopLevelFrame = 
	  $this->session->currentTopLevelFrame->parent;
d1699 39
a1737 37

  /**
   * called at run-time for each line
   * @@param string the script name
   * @@param int the current line
   * @@param mixed the execution variables
   */
  public function step($scriptName, $line, $vars) {
	if ($this->ignoreInterrupt) return; // avoid spurious step calls from __destruct() method
	$this->ignoreInterrupt = true;

	if (PDB_DEBUG) pdb_Logger::logDebug("step: $scriptName @@ $line");
	// pull the current frame from the stack or the top-level environment
	$this->session->currentFrame = (isset($vars['__pdb_CurrentFrame'])) ? $vars['__pdb_CurrentFrame'] : $this->session->currentTopLevelFrame;
	unset($vars['__pdb_CurrentFrame']);

	$this->session->currentFrame->update($line, $vars);

	if ($this->session->hasBreakpoint($scriptName, $line)) {
	  $stepNext = $this->handleRequests();
	  if (PDB_DEBUG) pdb_Logger::logDebug("continue");

	  /* clear all dynamic breakpoints */
	  foreach ($this->session->allFrames as $currentFrame)
		$currentFrame->stepNext = false;

	  /* set new dynamic breakpoint */
	  if ($stepNext != pdb_JSDebugger::GO) {
		$currentFrame = $this->session->currentFrame;

		/* break in current frame or frame below */
		if ($stepNext != pdb_JSDebugger::STEP_OUT)
		  $currentFrame->stepNext = $stepNext;

		/* or break in any parent */
		while ($currentFrame = $currentFrame->parent) {
		  $currentFrame->stepNext = $stepNext;
d1739 3
d1743 17
d1761 6
d1768 300
a2067 2
	$this->ignoreInterrupt = false;
	if (PDB_DEBUG) pdb_Logger::logDebug("endStep: $scriptName @@ $line");
d2070 64
a2135 1
 * Convenience function called by the executor
d2139 1
a2139 1
  if(isset($vars2)) $vars1['pbd_This'] = $vars2;
d2141 1
a2141 1
  unset($vars1['__pdb_Code']);	   // see pdb_Message::doEval()
d2143 1
a2143 1
  return $vars1;  
a2144 1

a2145 1
 * Convenience function called by the executor
d2150 9
a2158 1
  if (isset($pdb_dbg)) return $pdb_dbg->startCall($scriptName);
a2161 1
 * Convenience function called by the executor
d2166 27
a2192 2
  if (isset($pdb_dbg)) return $pdb_dbg->startInclude($scriptName, $once);
  else return "";
a2193 1

a2194 1
 * Convenience function called by the executor
d2199 2
a2200 1
  if (isset($pdb_dbg)) $pdb_dbg->endInclude();
d2203 1
a2204 1
 * Convenience function called by the executor
d2207 1
a2207 1
function pdb_step($scriptName, $line, $vars) {
d2209 33
a2241 1
  if (isset($pdb_dbg)) $pdb_dbg->step($scriptName, $line, $vars);
d2250 1
a2250 4
  if ($pdb_dbg->end) return true;
 
 if (strncmp(basename($errfile),"PHPDebugger", 11)) 
   $pdb_dbg->setError($errno, $errfile, $errline, $errstr);
d2252 3
d2268 3
a2270 3
	$pdb_dbg->setError($error['type'], $error['file'], $error['line'], $error['message']);
	$pdb_dbg->end();
	$pdb_dbg->shutdown();
d2274 6
a2279 4
if (PDB_DEBUG==2) {
  $parser = new pdb_Parser($argv[1], file_get_contents($argv[1]));
 echo $parser->parseScript();
 exit (2);
a2281 2
/* * The JavaScript part, invoked after the debugger has been included() * */
if (!isset($_SERVER['HTTP_XPDB_DEBUGGER'])) {
d2283 3
a2285 101
  session_start();
  header("Expires: Sat, 1 Jan 2005 00:00:00 GMT");
  header("Last-Modified: ".gmdate( "D, d M Y H:i:s")." GMT");
  header("Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0");
  header("Pragma: no-cache");
  header("Content-Type: text/html");
?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>
PHPDebugger version 1.0
</title>
<style type="text/css">
#tooltip {
  background:#EFEFEF none repeat scroll 0 0;
  height:auto;
  width:auto;
  min-width: 1px;
  min-height: 1.5ex;
  display: block;
  border:1px solid black;
  background-color:gray; color:white;
  position:absolute;
  text-align: center;
  z-index:75;
}
.tt {
  visibility: hidden;
}
.ttHover {
  visibility: visible;
}

#run {
  height: 13px;
  width: 17px;
  display: inline-block;
  position: relative;
  margin: 1px 10px 1px 10px;
  background:green url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAANCAYAAABPeYUaAAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLBwcXGXdF1DwAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAABEUlEQVQoz62SoWvDUBDGfx0Rry6VzzUyg4lEVgYmRulfMVUKVWOqTFVWDULVbNxsTSETg8jOzm+QwcSL28ECmwhJGpqwwnrmfXfv7nvf3b2e+TQ//NMsgPRlQfoeQ14E9TBAe0uC9QyAeBoeQfK6IZjuqmC89tHeEoDFxP+TzKqQJK0JksPNlQ/QSWYBiJQVKShd+4DJa+f68hyA0f0M7fR5nKyaSiQTlHwgatB4JXkzB+q8C12RJfNwr522Vr4hy7PjtgOgbAWZKs6SRASt+gfZ8bPBcQck83B/Jl/Fre3S8AGlarx5Kuazu33o2I4atUq1LYi27cUNEj0cE925VdBxxxWOttJZXFrvFN/+jBPYL4uJYFb2zCiIAAAAAElFTkSuQmCC') no-repeat;
}
#terminate {
  height: 13px;
  width: 13px;
  display: inline-block;
  position: relative;
  margin: 1px 10px 1px 10px;
  background:red url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAANCAYAAABy6+R8AAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLBwYrNECrm4EAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAAwUlEQVQoz52SLQ7CQBCFvyaI4nYlciWSI3CEFkVQGAyOcBU0ClCARCKRHGFlN0HsuK4D0RRasWnKJOPel/fmJ/Ev/6ZnDQD89YzcL51iNc3R2ayC5HZkslx3Qs/97gcBEEBOh7jLfNGOh5RY8egQd7HiQcoG9HULPRZRwthagvdR4chapBUPQELVsZKAL8HUkBZApVVHN5FWuhoKzlEYg06HUaYwhuBcO55RGjbxWynANWdSWc5jte3+iCwHIPnn9z7J30SR7ayFNQAAAABJRU5ErkJggg==') no-repeat;
}
#stepInto {
  height: 13px;
  width: 17px;
  display: inline-block;
  position: relative;
  margin: 1px 10px 1px 10px;
  background: yellow url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAANCAYAAABPeYUaAAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLBwYtD6f61SMAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAA6ElEQVQoz2N8//r9fwYKAQuMcWy6JlYFmq4lDIIqyYQNOTZdk8Gr8jpWBdvaNRkUPz9nkDSswWkII8w72Fyi6JjMoGmRw7Ct3ZDBKvM6Ye9gU3RsuiaDpkkywTBhIqjizwfiAxbdBQhDfqCIYXMxVkN+fGdgCCqaCzXkPYNXJoS9ri+ZeO84FV1nWNYUDfEKFC9rimZwKrpOWph41d1nWNaWzcDw5zvDsrZsBq+6+/ijOHn+MQbBzxBF73kVGeYmWiHSSZMiigHY1LIwMDAw/Di/lOHaC4giQYljDAxIhqC7AJtaRmrkHQBYX2Q4HZvQSwAAAABJRU5ErkJggg==') no-repeat;
}
#stepOver {
  height: 13px;
  width: 17px;
  display: inline-block;
  position: relative;
  margin: 1px 10px 1px 10px;
  background: yellow url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAANCAYAAABPeYUaAAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLBwYsOAZcQW0AAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAABSklEQVQoz62TP0jDQBTGv5QMdSgYcEjGgEvHdsyYsW6Kg27SKeJki1PpEAShqJPYKTilHUS3dOyYbu1mhpZmERqIcIEOyRA4h9qaeCcK+uA43uPj9/7cO4GEhOKPJmYdMrMQTJ5A3nxGKO2okCsHkHbr30PIzII/slA9vMO2XGWEUTDG+PEMyXIBpdJiIWuAbjiIXkcYXJUZiHZ0A91wMOzuoVhS8hWRkFDHlCmN55RMbeqYMiUhYY5jypRMbUrjOaMpbGhpBLffgGZ43OFphge33wDSiD+TJAaQJqubY243016a5GKa4UFYP/HAVFFr+1zI8LaM/dNLoKh8BpMFnu9b0M8zkJ9sYKo4vrgGxC0gjdHrNDdJC79dqFrbR6/TZAAA+JXUH1xIy5WIlFRYJ1quoq9ti7ysycTGS/CxqbILZCC8uQn/8XfeAUbdtbmYIYl8AAAAAElFTkSuQmCC') no-repeat;
}
#stepOut {
  height: 13px;
  width: 17px;
  display: inline-block;
  position: relative;
  margin: 1px 10px 1px 10px;
  background: yellow url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAANCAYAAABPeYUaAAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLBwYsF62NfDQAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAABAUlEQVQoz62Tv2vCQBTHP5GsDoJDV8f8C44ZM+Y/EOnSgoOCQ4YOxVE6BH9MoZMdM3TI6CLcJNzmLULGCg4p6HBgoB0SFH9gKvYtj7v3fR/ufe/OSNbJD3dG6RaxGFuIsXUfhB04j0OEfwwyi/q+ZI94NjlsVG2cpyGRb1FvKQCMa54kywAZ9XE9eV78FoSjZ+yWun4S+dnH9aao+QAVBQC43hS2ktDvYLfVXz3RqCjYN5wCiiEpkOos5+vw7RhQbGyqIU2yDNhddfs70TlIFwxsAjTfBZVNnN1IuUbQqJ+i9nFJawJoOWGxykSVBwE5xPFiPl5rOC/xAXlBa/zH3/kFlslu4rTXaTUAAAAASUVORK5CYII=') no-repeat;
}
#output {
  height: 13px;
  width: 13px;
  display: inline-block;
  position: relative;
  margin: 1px 10px 1px 10px;
  visibility: visible;
  background: blue url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAANCAYAAABy6+R8AAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLCQYlB4EnoCoAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAABCklEQVQoz42Rv0oDQRCHv4MJbCCFgoUHvkBKXyGPEDufwUokhdFGokWwt7IRbISkTHmvcIUPcUKK3eJgp1g4i92Ld4gxWw2z329+8ye7vF81pcs59J0fVUjpcsZaHCwq3QQBD8Ddcv6vYDF7BDxCACMGgPFov8iIgQACChKTVw9rvCrqPK52+FopPjodCBA0Og1H0el5Nv1VXcNPPDQGHAhBMcnpZrlOJFi1aK1orXhVNm/zxGnbXnRaXE//nEchcm17ZpB+ggImIaaDx9gMaBfhQeD95bVfWiLQi4W48vzkmM1ndfBx89OczG5t001ePBVUX1UPWt1OesLMbm2zA4Puhk3n7LucxQLfZ4Norb3ftQMAAAAASUVORK5CYII=') no-repeat;
}
#backView {
  height: 13px;
  width: 16px;
  display: inline-block;
  position: relative;
  margin: 1px 10px 1px 10px;
  visibility: visible;
  background: yellow url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAANCAYAAACgu+4kAAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLBwc3GnvIoSQAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAABH0lEQVQoz5WToU4DQRCGvzZLspUn+wpIJLLyJDiQEBLMJZDAA1QgTlRUU1tXCY+A5BGoPHFiKkhukm4yiD3CNr3S9k8mu/l3Z+af2dme1GJ04HM6hBPP2f2S/9DvIj/KjNG4gUbZh36Xc15GURr2B3Abzi8Z+cQABTyqkdu8BTjP+WMV91KLSS22eMDMGjOrzNZfZuvKzCSxJlnN3p4wqcVclD3kYlJBWEJQCACrJLNvVwXnwWVoSErQbwUEwgq0+ZMa2JYfBuAV1aSJo7EwvzsFmpj515y2/WjNKbim5SN66Ry8P2dcTRexDGBWXDNwHSoc5GPZfoW8FGZFxs30FYCBi9xRc3BZCrPiNoZ2/rg5SIPMi+GO0030dv2FQ/EDM7CYPt7DsBMAAAAASUVORK5CYII=') no-repeat;
}
 
.normal {
  background: transparent;
}
.selected {
  background: yellow url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAANCAYAAABy6+R8AAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLBwYQB8PJFa8AAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAABNElEQVQoz4WPsUsCYRjGf8YNNzTo7vJBDgUNHTSc4KBbro6ORy5KU5tN0VhjS+FfEDXaEFxbY9cQuQSfQ3BCwyck3At9YIOieZo98MAL7/vjed6MMWYMcH6aQxUqePsBaqvKOm0A6PcQpaDoh4QPdcL7E8xQr4EsmC9BLKg8NA8hm72kc+Xx9Hi2GhIryMgAIHZibw9aDZDRBZ3rIs9RZ7neTDK3C1RKUC336L0cc3tTR/fDFGTByLLdTagegMp36d7VAHAWQuSPzy0Mh5BM987vxSoojiGKQBUCgkYzBQGSzOdkBNEr4Pj45QBvtza7XkhCILGg+6A1FEttPL+F67oL6RPIcZFveJse72wHBEdtctncyhcz5tOM40GM1iHxR4jnN1F5L1U8DRkzFhGwTGo4/KsfXjWDCQ6TmRMAAAAASUVORK5CYII=') no-repeat;
}
.breakpointSet {
  background: red url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAANCAYAAABy6+R8AAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLBwYOGJqAJ4UAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAA+0lEQVQoz5XSMUvDUBSG4bcXhyM4pFsudBE6GEfB5UKGZLOjq5uCIE7iPyjdxEXQoZC/4OgipIOQbqZDMW6OcbsZBO8Q0MEWkWJJ3vl7lsPpWGu/WOQqy8s44X2S8ukcmyL4Uczu6QnidZczOktUPqY8HB/Bh2OlLWEwTtAHg19kXwvuQwM1/7cBh08Z3Z0ABZCena8HAPViB6hymlHNcppUzXLKaYaq5gVtquYFitq1QtQO5fWDVsbrBygdGqTnNwLS89GhQSFCfJc0QvHNLYj8nFyHBjMcrQVmOEJH8d+PALD5M/nVNW+TFJwDEbajmODiEr2/t/pGbfoGcP1aToLr9OAAAAAASUVORK5CYII=') no-repeat;
a2287 427
#navigationBar {
  display: block;
  position: fixed;
  top: 0px;
  left: 0px;
  height: 20px;
  width: 100%;
  z-index: 100;
  background: #efefef;
}
#code {
  display: block;
  position: absolute;
  left: 92px;
  top: 22px;
  z-index: 50;
}

.breakpoint {
  display: inline;
  position: absolute;
  left: -92px;
  width: 90px;
  height: 13px;
  background: #efefef;
  overflow: hidden;
}

.linenumber {
  display: inline-block;
  position: relative;
  width: 59px;
  height: 13px;
  text-align: right;
  margin-right: 5px;
  float: right;
  color: black;
  
}
.currentlineIndicator {
  display: inline-block;
  position: relative;
  width: 13px;
  height: 13px;
  float: left;
}
.breakpointIndicator {
  display: inline-block;
  position: relative;
  width: 13px;
  height: 13px;
  float: left;
}
</style>

<script type="text/javascript">
var http = createRequestObject();
var httpCtrl = createRequestObject();
var serverID = <?php echo pdb_JSDebuggerClient::getServerID(); ?>;
var scriptName = "<?php echo pdb_JSDebuggerClient::getDebugScriptName(); ?>";
var currentScriptName = "";
var cwd = "<?php echo urlencode(getcwd()); ?>";
var debuggerURL = "<?php echo pdb_JSDebuggerClient::getDebuggerURL(); ?>";
var date = "<?php echo gmdate( 'D, d M Y H:i:s').' GMT'; ?>";
var seq = 1;

function getSeq() {
 return seq++;
}
function getServerID() {
  return serverID;
}
function createRequestObject() {
  var req;
  var browser = navigator.appName;
  if (browser == "Microsoft Internet Explorer") {
	req = new ActiveXObject("Microsoft.XMLHTTP");
  } else {
	req = new XMLHttpRequest();
  }
  return req;
}
function doCmd(text) {
  switch(text.cmd) {
  case 'stepNext': 
  case 'stepOver': 
  case 'go':
  case 'switchView':
  case 'backView':
  case 'begin':
  case 'stepOut':	getStatusCB(text); break;

  case 'output':	showOutputCB(text); break;

  case 'status':	showStatusCB(text); break;

  case 'extendedStatus': showExtendedStatusCB(text); break;

  case 'setBreakpoint':	setBreakpointCB(text); break;

  case 'unsetBreakpoint':	unsetBreakpointCB(text); break;

  case 'term':
  case 'end':		endCB(text); break;
  case 'toolTip':   showToolTipCB(text); break;

  default: alert("illegal cmd: " + text.cmd); break;
  }
}
function hasClassName(element, className) {
  var elementClassName = element.className;
  if (elementClassName.length == 0) return false;
  if (elementClassName == className ||
    elementClassName.match(new RegExp("(^|\\s)" + className + "(\\s|$)")))
   return true;
  return false;
}
if (document.getElementsByClassName == undefined) {
 document.getElementsByClassName = function(className) {
	var children = document.body.getElementsByTagName('*');
	var elements = [], child;
	for (var i = 0, length = children.length; i < length; i++) {
	 child = children[i];
	 
	 if (hasClassName(child, className)) {
	elements.push(child);
	 }
	}
	return elements;
 }
}
function sendCmd(cmd) {
  var url = debuggerURL;
  data = cmd+"&serverID="+getServerID()+"&seq="+getSeq();

  /* use synchronous requests to avoid out of order execution of 
	 step -> status -> extended status sequences */
  http.open("POST", url, false);
  http.setRequestHeader("Cache-Control", "no-store, no-cache, must-revalidate, post-check=0, pre-check=0");
  http.setRequestHeader("Last-Modified", date);
  http.setRequestHeader("Pragma", "no-cache");
  http.setRequestHeader("Expires", "Sat, 1 Jan 2005 00:00:00 GMT");
  http.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  http.setRequestHeader("Content-Length", data.length);
  http.setRequestHeader("XPDB-DEBUGGER", 0);
  /*
  http.onreadystatechange = function() {
	 if(http.readyState == 4 && http.status == 200) {
	   doCmd(eval(http.responseText));
	 }
  }
  */

  http.send(data);

  doCmd(eval(http.responseText));
}
function startServer() { 
  var url = debuggerURL;
	data = "<?php echo pdb_JSDebuggerClient::getPostData(); ?>";
	method = "<?php echo $_SERVER['REQUEST_METHOD']; ?>";
  httpCtrl.open(method, url, true);
  httpCtrl.setRequestHeader("Cache-Control", "no-store, no-cache, must-revalidate, post-check=0, pre-check=0");
  httpCtrl.setRequestHeader("Last-Modified", date);
  httpCtrl.setRequestHeader("Pragma", "no-cache");
  httpCtrl.setRequestHeader("Expires", "Sat, 1 Jan 2005 00:00:00 GMT");
  httpCtrl.setRequestHeader("Content-Length", data.length);
  httpCtrl.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  httpCtrl.setRequestHeader("XPDB-DEBUGGER", getServerID());
  httpCtrl.onreadystatechange = function() {
	 if(httpCtrl.readyState == 4 && httpCtrl.status == 200) {
	  //alert("debugger exited. Debugger debug output: " +httpCtrl.responseText);
	 }
  }
  httpCtrl.send(data);
}
function stepNext() {
  sendCmd("cmd=stepNext");
}
function stepOver() {
  sendCmd("cmd=stepOver");
}
function stepOut() {
  sendCmd("cmd=stepOut");
}
function getStatusCB(cmd) {
	sendCmd("cmd=status");
}

function loaded() {
  startServer();
  sendCmd("cmd=begin&scriptName="+encodeURI(scriptName)+"&cwd="+encodeURI(cwd));
}
function toggleBreakpoint(el, event) {
  sendCmd("cmd=toggleBreakpoint&breakpoint="+encodeURI(el.id));
  return false;
}
function setBreakpointCB(cmd) {
  document.getElementById(cmd.breakpoint).lastChild.className="breakpointIndicator breakpointSet";
}
function unsetBreakpointCB(cmd) {
  document.getElementById(cmd.breakpoint).lastChild.className="breakpointIndicator normal";
}
function showOutputCB(cmd) {
  currentScriptName = "";
  document.getElementById("code").innerHTML = cmd.output;
  window.scrollTo(0, 0);
}

function doShowStatusCB(cmd) {
  lines = document.getElementsByClassName("currentlineIndicator");
   if (lines.length == 0) {
     window.scrollTo (0, 0);
     return; // no lines to mark
   }

  lines = document.getElementsByClassName("currentlineIndicator selected");
  for (i=0; i<lines.length; i++) {
	line = lines[i];
	line.className = "currentlineIndicator normal";
  }
  for (i=0; i<cmd.breakpoints.length; i++) {
	breakpoint = cmd.breakpoints[i];
	document.getElementById(breakpoint).lastChild.className="breakpointIndicator breakpointSet";
  }
  currentLine = document.getElementById("bp_"+(cmd.line)).firstChild;

	currentLine.className="currentlineIndicator selected";

	codeDiv = document.getElementById("code");
	codeLine = currentLine.parentNode;
	toolsHeight = 30;
	if (codeLine.offsetTop < window.pageYOffset || codeLine.offsetTop + codeLine.clientHeight +toolsHeight > window.pageYOffset+window.innerHeight) {
	  window.scrollTo(0, codeLine.offsetTop + toolsHeight - window.innerHeight/2);
	}
}
function showStatusCB(cmd) {
	if (currentScriptName == cmd.scriptName)
	 doShowStatusCB(cmd);
	else
	 sendCmd("cmd=extendedStatus"); // another round-trip 
}
function showExtendedStatusCB(cmd) {
	currentScriptName = cmd.scriptName;
	document.getElementById("code").innerHTML = cmd.script;
	document.title = cmd.scriptName;

	doShowStatusCB(cmd);
}

function stepInto(el, event) {
  sendCmd("cmd=stepNext");
  return false;
}
function stepOver(el, event) {
  sendCmd("cmd=stepOver");
  return false;
}
function stepOut(el, event) {
  sendCmd("cmd=stepOut");
  return false;
}
function end(el, event) {
  sendCmd("cmd=end");
  return false;
}
function endCB(cmd) {
  document.body.innerHTML = cmd.output;
}
function go(el, event) {
  sendCmd("cmd=go");
  return false;
}
function switchView(data) {
  data = encodeURI(data);
  sendCmd("cmd=switchView&scriptName="+data);
  return false;
}
function backView(el, event) {
  sendCmd("cmd=backView");
  return false;
}
function output(el, event) {
  sendCmd("cmd=output");
  return false;
}

var currentEl, tooltipItem;
var currentX, currentY;
var timer;
var tt;
function getToolTip() {
  if(tt) return tt;
  return tt = document.getElementById("tooltip");
}
function mouseout(el, event) {
  getToolTip().className = "tt";
  if (timer) {
	window.clearTimeout(timer);
	timer = null;
  }
  return true;
}
function mousemove(el, event) {
  if (timer) {
	window.clearTimeout(timer);
	getToolTip().className = "tt";
	timer = null;
  }
  if (getEventSource(event).parentNode.className=="breakpoint") return true;
  el = getEventSource(event);
  if (el.nodeName !="SPAN") return true;

  currentEl = el;
  currentX = getEventX(event) + window.pageXOffset;
  currentY = getEventY(event) + window.pageYOffset;
  timer = window.setTimeout("showToolTip()", 600);
  return false;
}
function toolTipCmd(el) {
  el=encodeURI(el);
  sendCmd("cmd=toolTip&item="+el);
  return false;
}
function showToolTip() {
  el = currentEl;
  if (el && el.firstChild && el.firstChild.data) {
	data = trim(el.firstChild.data);
	while (el && el.previousSibling && el.previousSibling.firstChild && el.previousSibling.firstChild.data && trim(el.previousSibling.firstChild.data)=='->') {
	  el = el.previousSibling.previousSibling;
	  if (el && el.firstChild && el.firstChild.data) data = trim(el.firstChild.data)+"->"+data;
	}
  }
    toolTipCmd(data);
}
function showToolTipCB(cmd) {
  tt = getToolTip();
  if(tooltipItem) tt.removeChild(tooltipItem);
  tooltipItem = (document.createTextNode(cmd.value));
  tt.appendChild(tooltipItem);
  tt.style.top=(currentY+10) + "px";
  tt.style.left=(currentX+10) + "px";
  tt.className = "ttHover";

}
function trim(str) {
  nbspChar = String.fromCharCode(160);
  return str.replace(/^\s*/, "").replace(/\s*$/, "").replace(nbspChar,"");
}
function getEventSource(event) {
 if (event.target != undefined) return event.target;
 return event.srcElement;
}
function getEventX(event) {
  if (event.clientX != undefined) return event.clientX;
  return event.offsetX;
}
function getEventY(event) {
  if (event.clientY != undefined) return event.clientY;
  return event.offsetY;
}
function mousedown(el, event) {
  getToolTip().className = "tt";

  if (getEventSource(event).parentNode.className=="breakpoint") return true;
  el = getEventSource(event);
  if (el && el.firstChild && el.firstChild.data) {
	data = trim(el.firstChild.data);
	while (el && el.previousSibling && el.previousSibling.firstChild && el.previousSibling.firstChild.data && trim(el.previousSibling.firstChild.data)=='->') {
	  el = el.previousSibling.previousSibling;
	  if (el && el.firstChild && el.firstChild.data) data = trim(el.firstChild.data)+"->"+data;
	}
	switchView(data);
  }
  return false;
}
</script>

</head>
<body>

<div id="navigationBar">
<a id="run" onmousedown="return go(this, event);"></a>
<a id="terminate" onmousedown="return end(this, event);"></a>
<a id="stepInto" onmousedown="return stepInto(this, event);"></a>
<a id="stepOver" onmousedown="return stepOver(this, event);"></a>
<a id="stepOut" onmousedown="return stepOut(this, event);"></a>
<a id="output" onmousedown="return output(this, event);"></a>
<a id="backView" onmousedown="return backView(this, event);"></a>
</div>
 <div onmouseout="return mouseout(this, event);" onmousemove="return mousemove(this, event);" onmousedown="return mousedown(this, event);">
 <div id="code">
<span>loading...
<noscript>failed! Please enable JavaScript and try again.</noscript>
</span>
</div>
<div id="tooltip" class="tt" />
</div>
<script type="text/javascript">
 loaded();
</script>
</body>
</html>
<?php
 exit (0);
} elseif (($serverID = $_SERVER['HTTP_XPDB_DEBUGGER']) != "0") {
/* * The back end part, invoked from JavaScript using a json call. $serverID is a uniq ID generated from JavaScript * */
 header("Expires: Sat, 1 Jan 2005 00:00:00 GMT");
 header("Last-Modified: ".gmdate( "D, d M Y H:i:s")." GMT");
 header("Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0");
 header("Pragma: no-cache");
 header("Content-Encoding: identity");
 $pdb_dbg = new pdb_JSDebugger((int)$serverID);
 $pdb_dbg->handleRequests();
 $pdb_dbg->shutdown();
 if (PDB_DEBUG) pdb_Logger::debug("SERVER TERMINATED!");
 exit(0);
} else {
/* * The front end part, invoked from JavaScript using json calls * */
 header("Expires: Sat, 1 Jan 2005 00:00:00 GMT");
 header("Last-Modified: ".gmdate( "D, d M Y H:i:s")." GMT");
 header("Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0");
 header("Pragma: no-cache");
 header("Content-Encoding: identity");
 pdb_JSDebuggerClient::handleRequest ($_POST);
 exit(0);
}
@


1.16
log
@Release-6-1-2-1
@
text
@a233 1
	  if (PDB_DEBUG) pdb_Logger::debug("...{$this->role}, {$this->id} poll...");
d238 8
a245 2
	  if (count($_SESSION[$chan]) > $_SESSION[$chanCtr]) {
		$val = json_decode($_SESSION[$chan][$_SESSION[$chanCtr]++]);
d252 2
d256 2
a257 1
	if (!$this->checkTrm()) $_SESSION[$chan][]=json_encode($val);
d278 1
d284 1
a284 1
	$this->send($val);
a327 1
	$chanCtr = "pdb_ctr{$this->role}{$this->id}";
d331 5
a335 8
	  if (PDB_DEBUG) pdb_Logger::debug("...{$this->role}, {$this->id} poll...");
	  if (!isset($_SESSION[$chanCtr])) $_SESSION[$chanCtr] = 0; 
	  if (isset($_SESSION[$chan]) && (count($_SESSION[$chan]) > $_SESSION[$chanCtr])) {
		$val = json_decode($_SESSION[$chan][$_SESSION[$chanCtr]]);
		if ($val->seq == $this->seq) 
		  $_SESSION[$chanCtr]++;
		else
		  $val = false;
d1195 1
a1195 1
	if (!PDB_DEBUG) ob_start();
d1198 1
a1198 1
	if(!PDB_DEBUG) ob_end_clean();
d1620 1
a1620 1
  if ($pdb_dbg->end) return false;
d1962 1
d1967 4
a1970 1
   if (lines.length == 0) return; // no lines to mark
@


1.15
log
@Release-6-1-2-1
@
text
@d4 54
a57 37
	 PHPDebugger.php version 1.0 -- A pure PHP debugger (JavaScript version)

	 Copyright (C) 2009 Jost Boekemeier

	 This file is part of the PHPDebugger.

	 The PHPDebugger ("the library") is free software; you can
	 redistribute it and/or modify it under the terms of the GNU General
	 Public License as published by the Free Software Foundation; either
	 version 2, or (at your option) any later version.

	 The library is distributed in the hope that it will be useful, but
	 WITHOUT ANY WARRANTY; without even the implied warranty of
	 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
	 General Public License for more details.

	 You should have received a copy of the GNU General Public License
	 along with the PHPDebugger; see the file COPYING. If not, write to the
	 Free Software Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA
	 02111-1307 USA.

	 Linking this file statically or dynamically with other modules is
	 making a combined work based on this library. Thus, the terms and
	 conditions of the GNU General Public License cover the whole
	 combination.

	 As a special exception, the copyright holders of this library give you
	 permission to link this library with independent modules to produce an
	 executable, regardless of the license terms of these independent
	 modules, and to copy and distribute the resulting executable under
	 terms of your choice, provided that you also meet, for each linked
	 independent module, the terms and conditions of the license of that
	 module. An independent module is a module which is not derived from
	 or based on this library. If you modify this library, you may extend
	 this exception to your version of the library, but you are not
	 obligated to do so. If you do not wish to do so, delete this
	 exception statement from your version. */
d59 2
a61 1
define ("PDB_DEBUG", 0);
a68 15
 * Usage:
 * 
 * 1. include() this file at the beginning of your script
 *
 * 2. browse to your script using firefox 
 *
 * 3. set breakpoints using the JavaScript GUI, click on any
 * variable or included file to visit that variable or file
 * 
 * 4. click on the stop button to terminate the debug session
 *
 */


/**
d79 1
a79 2
  private static $logFileName = "/tmp/pdb_PHPDebugger.log";

d84 3
d170 1
a170 1
  const TIMER_DURATION = 150000; // every 150ms
d234 1
a234 1
	  pdb_Logger::debug("...{$this->role}, {$this->id} poll...");
d297 1
a297 1
	pdb_Logger::debug("session terminated: {$this->chanTrm}");
d323 1
a323 1
	  pdb_Logger::debug("...{$this->role}, {$this->id} poll...");
d540 1
a540 1
	  pdb_Logger::debug("parse:::$type");
d548 1
a548 1
		  pdb_Logger::debug(":::".$token);
d576 1
a576 1
		  pdb_Logger::debug(":::".$token[1].":(".token_name($token[0]).')');
d664 1
d668 1
a685 1

d694 1
a694 1
			if ($this->nextTokenIs(array(T_ELSE, T_ELSEIF))) {
a716 1
			$this->writeNext();
d718 2
d723 1
d794 1
a794 1
	pdb_Logger::debug("scriptDir: $scriptDir, scriptDirName: $scriptDirName");
d835 1
a835 1
	pdb_Logger::debug("serverRoot: $root - path: $path");
d871 8
d887 1
d891 1
a891 1
	pdb_Logger::debug("beginHandleRequest: ".$msg->cmd);
d901 1
a901 1
	pdb_Logger::debug("endHandleRequest");
d964 1
a964 1
	  $code = ereg_replace('<br />', $c, $code);
d1162 1
a1162 1
	  pdb_Logger::debug("process breakpoint::: $scriptName, $line:: $breakpoint");
d1352 25
d1378 1
d1380 1
d1385 2
d1388 2
d1392 5
a1396 5
		  $value = eval("return ".$name.";");
		  if (file_exists($value)) 
			$this->session->currentView = new pdb_View($this->session->currentView, realpath($value));
		  else
			$this->session->currentView = new pdb_VariableView($this->session->currentView, $name, $value);
d1418 1
a1418 1
		pdb_Logger::debug("illegal packet: " . print_r($this->packet, true));
d1447 1
a1447 1
	pdb_Logger::debug("startCall::$scriptName, $stepNext");
d1458 1
d1462 2
d1479 1
a1479 1
	pdb_Logger::debug("scriptName::$scriptName, $isDebugger");
d1499 1
a1499 1
	pdb_Logger::debug("startInclude:::".$this->session->currentTopLevelFrame . " parent: " . $this->session->currentTopLevelFrame->parent . " code: ".$code);
d1509 1
a1509 1
	pdb_Logger::debug("endInclude:::".$this->session->currentTopLevelFrame . "parent: ".$this->session->currentTopLevelFrame->parent);
d1525 1
a1525 1
	pdb_Logger::logDebug("step: $scriptName @@ $line");
d1534 1
a1534 1
	  pdb_Logger::logDebug("continue");
d1556 1
a1556 1
	pdb_Logger::logDebug("endStep: $scriptName @@ $line");
d1662 20
d1855 1
d1885 4
a1888 1
  http.open("POST", url, true);
d1896 1
d1899 1
a1899 1
	  doCmd(eval(http.responseText));
d1902 2
d1905 2
d1942 1
a1942 1
  sendCmd("cmd=begin&scriptName="+scriptName+"&cwd="+cwd);
d1945 1
a1945 1
  sendCmd("cmd=toggleBreakpoint&breakpoint="+el.id);
d1963 1
d2021 1
d2034 16
d2051 40
d2100 8
d2109 2
d2137 7
a2143 1
 <div onmousemove="return mousemove(this, event);" onmousedown="return mousedown(this, event);" id="code"><span>loading...<noscript>failed! Please enable JavaScript and try again.</noscript></span>
a2144 1
</body>
d2148 1
d2162 1
a2162 1
 pdb_Logger::debug("SERVER TERMINATED!");
@


1.14
log
@Release-6-1-2-1
@
text
@a1976 4
<noscript>
Please enable JavaScript in your browser.
</noscript>

d1989 1
a1989 1
 <div onmousemove="return mousemove(this, event);" onmousedown="return mousedown(this, event);" id="code"><span>loading...</span>
@


1.13
log
@Release-6-1-2-1
@
text
@d176 1
d184 10
@


1.12
log
@Release-6-1-2-1
@
text
@d165 1
a165 1
  const TIMER_DURATION = 200000; // every 200ms
d347 1
d396 1
a396 1
	private function writeInclude() {
d411 1
a411 1
		$this->write("eval('?>'.pdb_startInclude($name)); pdb_endInclude();");
d426 1
a426 1
	  $this->write("\$__pdb_CurrentFrame=pdb_startCall(\"$scriptName\", $this->currentLine);");
d513 3
d533 1
a533 1
		  if (!$pLevel && $type==self::BLOCK && $token=='}') $this->writeStep($pLevel);
d588 1
a588 1
			$this->parseBlock();
d685 2
a687 1
		  case T_INCLUDE_ONCE: 
a688 1
		  case T_REQUIRE_ONCE: // FIXME: implement require and _once
d690 1
a690 1
			$this->writeInclude();
d1182 1
d1208 2
d1412 1
a1412 1
  public function startInclude($scriptName) {
d1419 7
d1437 4
a1440 2
	pdb_Logger::debug("include:::".$code);
	return $code; // eval -> pdb_step/MSG_READY or pdb_endInclude/MSG_READY OR FINISH
d1447 2
d1523 1
a1523 1
function pdb_startInclude($scriptName) {
d1525 1
a1525 1
  if (isset($pdb_dbg)) return $pdb_dbg->startInclude($scriptName);
d1886 3
a1888 4
  scrollBarHeight = 30;
	if ((codeLine.offsetTop - document.body.scrollTop + currentLine.clientHeight + scrollBarHeight + codeDiv.clientTop > document.body.clientHeight) ||
	(codeLine.offsetTop - document.body.scrollTop + codeDiv.clientTop <= 0)) {
	 currentLine.scrollIntoView(false);
@


1.11
log
@Release-6-1-2-1
@
text
@d378 1
a378 1
		  $this->currentLine = $cur[2];
d436 1
a436 1
		  $this->write(";pdb_step(\"$scriptName\", $line, pdb_getDefinedVars(get_defined_vars()));");
d529 1
d583 2
@


1.10
log
@Release-6-1-2-1
@
text
@d43 1
a43 1
define ("PDBJS_DEBUG", 0);
d45 3
a47 3
$pdbjs_version = phpversion();
if ((version_compare("5.3.0", $pdbjs_version, ">")))
  trigger_error("<br><strong>PHP ${pdbjs_version} too old.</strong><br>\nPlease set the path to a PHP >= 5.3 executable, see php_exec in the WEB-INF/web.xml", E_USER_ERROR);
d69 1
a69 1
class pdbjs_Logger {
d76 1
a76 1
  private static $logFileName = "/tmp/pdbjs_PHPDebugger.log";
d79 1
a79 1
	if (!self::$logLevel) self::$logLevel=PDBJS_DEBUG?self::DEBUG:self::INFO;
d118 1
a118 1
interface pdbjs_Queue {
d160 1
a160 1
class pdbjs_PollingServerConnection implements pdbjs_Queue {
d171 1
a171 1
  public function pdbjs_PollingServerConnection($id) {
d173 1
a173 1
	$this->chanTrm = "pdbjs_trmserver{$this->id}";
d189 2
a190 2
	$chanCtr = "pdbjs_ctr{$this->role}{$this->id}";
	$chan = "pdbjs_{$this->role}{$this->id}";
d197 2
a198 2
	$chanCtr = "pdbjs_ctr{$this->role}{$this->id}";
	$chan = "pdbjs_{$this->role}{$this->id}";
d214 2
a215 2
	$chanCtr = "pdbjs_ctr{$this->role}{$this->id}";
	$chan = "pdbjs_{$this->role}{$this->id}";
d218 1
a218 1
	  pdbjs_Logger::debug("...{$this->role}, {$this->id} poll...");
d231 1
a231 1
	$chan = "pdbjs_{$this->to}{$this->id}";
d281 1
a281 1
	pdbjs_Logger::debug("session terminated: {$this->chanTrm}");
d294 1
a294 1
class pdbjs_PollingClientConnection extends pdbjs_PollingServerConnection {
d303 2
a304 2
	$chanCtr = "pdbjs_ctr{$this->role}{$this->id}";
	$chan = "pdbjs_{$this->role}{$this->id}";
d307 1
a307 1
	  pdbjs_Logger::debug("...{$this->role}, {$this->id} poll...");
d338 1
a338 15
/**
 * The PHP parser
 * @@access private
 */
class pdbjs_Parser {
  const BLOCK = 1;
  const STATEMENT = 2;
  const EXPRESSION = 3;

  private $scriptName, $content;
  private $code;
  private $output;
  private $line, $currentLine;
  private $beginStatement, $inPhp, $inDQuote;
 
d340 1
a340 3
   * Create a new PHP parser
   * @@param string the script name
   * @@param string the script content
d343 40
a382 22
  public function pdbjs_Parser($scriptName, $content) {
	$this->scriptName = $scriptName;
	$this->content = $content;
	$this->code = token_get_all($content);
	$this->output = "";
	$this->line = $this->currentLine = 0;
	$this->beginStatement = $this->inPhp = $this->inDQuote = false;
  }

  private function toggleDQuote($chr) {
	if ($chr == '"') $this->inDQuote = !$this->inDQuote;
  }

  private function each() {
	$next = each ($this->code);
	if ($next) {
	  $cur = current($this->code);
	  if (is_array($cur)) {
		$this->currentLine = $cur[2];
		if ($this->isWhitespace($cur)) {
		  $this->write($cur[1]);
		  return $this->each();
d384 2
d387 6
a392 2
	  else 
		$this->toggleDQuote($cur);
a393 2
	return $next;
  }
d395 17
a411 4
  private function write($code) {
	//echo "write:::".$code."\n";
	$this->output.=$code;
  }
d413 10
a422 10
  private function writeInclude() {
	$name = "";
	while(1) {
	  if (!$this->each()) die("parse error");
	  $val = current($this->code);
	  if (is_array($val)) {
		$name.=$val[1];
	  } else {
		if ($val==';') break;
		$name.=$val;
d424 2
a426 5
	if (PDBJS_DEBUG == 2) 
	  $this->write("EVAL($name);");
	else
	  $this->write("eval('?>'.pdbjs_startInclude($name)); pdbjs_endInclude();");
  }
d428 9
a436 9
  private function writeCall() {
	while(1) {
	  if (!$this->each()) die("parse error");
	  $val = current($this->code);
	  if (is_array($val)) {
		$this->write($val[1]);
	  } else {
		$this->write($val);
		if ($val=='{') break;
a438 3
	$scriptName = $this->scriptName;
	$this->write("\$__pdbjs_CurrentFrame=pdbjs_startCall(\"$scriptName\");");
  }
d440 5
a444 9
  private function writeStep($pLevel) {
	$token = current($this->code);
	if ($this->inPhp && !$pLevel && !$this->inDQuote && $this->beginStatement && !$this->isWhitespace($token) && ($this->line != $this->currentLine)) {
	  $lastLine = $this->line = $this->currentLine;
	  $scriptName = $this->scriptName;
	  if (PDBJS_DEBUG == 2)
		$this->write(";STEP($lastLine);");
	  else
		$this->write(";pdbjs_step(\"$scriptName\", $lastLine, pdbjs_getDefinedVars(get_defined_vars(), (isset(\$this) ? \$this : NULL)));");
a445 1
  }
d447 16
a462 19
  private function writeNext() {
	$this->next();
	$token = current($this->code);
	if (is_array($token)) $token = $token[1];
	$this->write($token);
  }

  private function nextIs($chr) {
	$i = 0;
	while(each($this->code)) {
	  $cur = current($this->code);
	  $i++;
	  if (is_array($cur)) {
		switch ($cur[0]) {
		case T_COMMENT:
		case T_DOC_COMMENT:
		case T_WHITESPACE:
		  break;	/* skip */
		default: 
d464 1
a464 1
		  return false;	/* not found */
a465 3
	  } else {
		while($i--) prev($this->code);
		return $cur == $chr;	/* found */
d467 2
a469 3
	while($i--) prev($this->code);
	return false;	/* not found */
  }
d471 17
a487 14
  private function nextTokenIs($ar) {
	$i = 0;
	while(each($this->code)) {
	  $cur = current($this->code);
	  $i++;
	  if (is_array($cur)) {
		switch ($cur[0]) {
		case T_COMMENT:
		case T_DOC_COMMENT:
		case T_WHITESPACE:
		  break;	/* skip */
		default: 
		  while($i--) prev($this->code);
		  return (in_array($cur[0], $ar));
a488 2
	  } else {
		break; /* not found */
d490 2
a492 3
	while($i--) prev($this->code);
	return false;	/* not found */
  }
d494 13
a506 8
  private function isWhitespace($token) {
	$isWhitespace = false;
	switch($token[0]) {
	case T_COMMENT:
	case T_DOC_COMMENT:
	case T_WHITESPACE:
	  $isWhitespace = true;
	  break;
a507 5
	return $isWhitespace;
  }
  private function next() {
	if (!$this->each()) trigger_error("parse error", E_USER_ERROR);
  }
d509 47
a555 9
  private function parseBlock () {
	$this->parse(self::BLOCK);
  }
  private function parseStatement () {
	$this->parse(self::STATEMENT);
  }
  private function parseExpression () {
	$this->parse(self::EXPRESSION);
  }
d557 4
a560 2
  private function parse ($type) {
	pdbjs_Logger::debug("parse:::$type");
d562 1
a562 2
	$this->beginStatement = true;
	$pLevel = 0;
d564 5
a568 10
	do {
	  $token = current($this->code);
	  if (!is_array($token)) {
		pdbjs_Logger::debug(":::".$token);
		$this->write($token);
		if ($this->inPhp && !$this->inDQuote) {
		  $this->beginStatement = false; 
		  switch($token) {
		  case '(': 
			$pLevel++;
d570 7
a576 2
		  case ')':
			if (!--$pLevel && $type==self::EXPRESSION) return;
d578 5
a582 3
		  case '{': 
			$this->next();
			$this->parseBlock(); 
d584 18
a601 7
		  case '}': 
			if (!$pLevel) return;
			break;
		  case ';':
			if (!$pLevel) {
			  if ($type==self::STATEMENT) return;
			  $this->beginStatement = true; 
d603 3
a606 4
		  }
		}
	  } else {
		pdbjs_Logger::debug(":::".$token[1].":(".token_name($token[0]).')');
d608 23
a630 6
		if ($this->inDQuote) {
		  $this->write($token[1]);
		  continue;
		}

		switch($token[0]) {
d632 1
a632 25
		case T_OPEN_TAG: 
		case T_START_HEREDOC:
		case T_OPEN_TAG_WITH_ECHO: 
		  $this->beginStatement = $this->inPhp = true;
		  $this->write($token[1]);
		  break;

		case T_END_HEREDOC:
		case T_CLOSE_TAG: 
		  $this->writeStep($pLevel);

		  $this->write($token[1]);
		  $this->beginStatement = $this->inPhp = false; 
		  break;

		case T_FUNCTION:
		  $this->write($token[1]);
		  $this->writeCall();
		  $this->beginStatement = true;
		  break;

		case T_ELSE:
		  $this->write($token[1]);
		  if ($this->nextIs('{')) {
			$this->writeNext();
d634 1
d636 1
a636 3
			$this->parseBlock();
		  } else {
			$this->next();
a637 2
			/* create an artificial block */
			$this->write('{');
d639 6
a645 2
			$this->parseStatement();
			$this->write('}');
d647 2
a648 2
		  }
		  if ($type==self::STATEMENT) return;
d650 1
a650 2
		  $this->beginStatement = true;
		  break;
d652 3
a654 6
		case T_DO:
		  $this->writeStep($pLevel);
		  $this->write($token[1]);
		  if ($this->nextIs('{')) {
			$this->writeNext();
			$this->next();
d656 1
a656 2
			$this->parseBlock();
			$this->next();
a657 2
		  } else {
			$this->next();
d659 2
a660 10
			/* create an artificial block */
			$this->write('{');
			$this->beginStatement = true;
			$this->writeStep($pLevel);
			$this->parseStatement();
			$this->next();
			$this->write('}');
		  }
		  $token = current($this->code);
		  $this->write($token[1]);
d662 7
a668 3
		  if ($token[0]!=T_WHILE) trigger_error("parse error", E_USER_ERROR);
		  $this->next();
		  $this->parseExpression();
d670 7
a676 1
		  if ($type==self::STATEMENT) return;
d678 6
a683 2
		  $this->beginStatement = true;
		  break;
d685 1
a685 5
		case T_IF:
		case T_ELSEIF:
		case T_FOR:
		case T_WHILE:
		  $this->writeStep($pLevel);
d687 2
a688 2
		  $this->write($token[1]);
		  $this->next();
d690 3
a692 3
		  $this->parseExpression();

		  if ($this->nextIs('{')) {
d694 7
a700 1
			$this->next();
d702 12
a713 5
			$this->parseBlock();


		  } else {
			$this->next();
d715 1
a715 3
			/* create an artificial block */
			$this->write('{');
			$this->beginStatement = true;
d717 1
a717 5
			$this->parseStatement();
			$this->write('}');
		  }

		  if ($this->nextTokenIs(array(T_ELSE, T_ELSEIF))) {
d719 2
a720 3
		  } else {
			if ($type==self::STATEMENT) return;
			$this->beginStatement = true;
a721 34
		  break;

		case T_INCLUDE: 
		case T_INCLUDE_ONCE: 
		case T_REQUIRE: 
		case T_REQUIRE_ONCE: // FIXME: implement require and _once
		  $this->writeStep($pLevel);
		  $this->writeInclude();

		  if ($type==self::STATEMENT) return;

		  $this->beginStatement = true;
		  break;

		case T_CLASS:
		case T_CASE:
		case T_DEFAULT:
		case T_PUBLIC:
		case T_PRIVATE:
		case T_PROTECTED:
		case T_STATIC:
		case T_CONST:
		case T_GLOBAL:
		case T_ABSTRACT:
		  $this->write($token[1]);
		  $this->beginStatement = false;
		  break;

		default:
		  $this->writeStep($pLevel);
		  $this->write($token[1]);
		  $this->beginStatement = false;
		  break;
	
d723 2
a724 3
	  }
	} while($this->each());
  }
d726 9
a734 9
  /**
   * parse the given PHP script
   * @@return the parsed PHP script
   * @@access private
   */
  public function parseScript() {
	do {
	  $this->parseBlock();
	} while($this->each());
d736 2
a737 1
	return $this->output;
d741 1
d747 1
a747 1
class pdbjs_JSDebuggerClient {
d768 1
a768 1
	pdbjs_Logger::debug("scriptDir: $scriptDir, scriptDirName: $scriptDirName");
d809 1
a809 1
	pdbjs_Logger::debug("serverRoot: $root - path: $path");
d843 1
a843 1
	return new pdbjs_PollingClientConnection($id);
d856 1
a856 1
	pdbjs_Logger::debug("beginHandleRequest: ".$msg->cmd);
d866 1
a866 1
	pdbjs_Logger::debug("endHandleRequest");
d878 1
a878 1
class pdbjs_View {
d890 1
a890 1
  public function pdbjs_View($parent, $scriptName) {
d946 1
a946 1
class pdbjs_VariableView extends pdbjs_View {
d953 2
a954 2
  public function pdbjs_VariableView($parent, $name, $value) {
	parent::pdbjs_View($parent, $name);
d969 1
a969 1
class pdbjs_Environment extends pdbjs_View {
d982 2
a983 2
  public function pdbjs_Environment($parent, $scriptName, $stepNext) {
	parent::pdbjs_View($parent, $scriptName);
d999 1
a999 1
	return "pdbjs_Environment: {$this->scriptName}, {$this->line}";
d1006 1
a1006 1
class pdbjs_Breakpoint {
d1022 1
a1022 1
  public function pdbjs_Breakpoint($breakpointName, $scriptName, $line) {
d1042 1
a1042 1
final class pdbjs_Session {
d1061 1
a1061 1
  public function pdbjs_Session($scriptName) {
d1063 1
a1063 1
	$this->currentTopLevelFrame = $this->currentFrame = new pdbjs_Environment(null, $scriptName, true);
d1109 1
a1109 1
	  $this->breakpoints[$id] = new pdbjs_Breakpoint($breakpoint, $this->getCurrentViewScriptName(), substr($breakpoint, 3));
d1127 1
a1127 1
	  pdbjs_Logger::debug("process breakpoint::: $scriptName, $line:: $breakpoint");
d1141 1
a1141 1
	$parser = new pdbjs_Parser($scriptName, $content);
d1144 2
a1145 2
  private static function doEval($__pdbjs_Code) {
	return eval ("?>".$__pdbjs_Code);
d1154 2
a1155 2
	if (PDBJS_DEBUG) pdbjs_Logger::debug("eval:::$code,".$this->getScriptName()."\n");
	if (!PDBJS_DEBUG) ob_start();
d1158 1
a1158 1
	if(!PDBJS_DEBUG) ob_end_clean();
d1169 2
a1170 2
class pdbjs_JSDebugger {
  /** The pdbjs_Session */
d1185 1
a1185 1
	return new pdbjs_PollingServerConnection($id);
d1192 1
a1192 1
  public function pdbjs_JSDebugger($id) {
d1201 2
a1202 2
	set_error_handler("pdbjs_error_handler");
	register_shutdown_function("pdbjs_shutdown");
d1227 1
a1227 1
	if (PDBJS_DEBUG) pdbjs_Logger::debug("->".print_r($data, true));
d1249 1
a1249 1
	  if (PDBJS_DEBUG) pdbjs_Logger::debug("handleRequests: accept");
d1253 1
a1253 1
	  if (PDBJS_DEBUG) pdbjs_Logger::debug("handleRequests: done accept ".$this->packet->cmd);
d1273 1
a1273 1
		$this->session = new pdbjs_Session(urldecode($this->packet->scriptName));
d1321 1
a1321 1
		  $this->session->currentView = new pdbjs_VariableView($this->session->currentView, $name, $value);
d1325 1
a1325 1
			$this->session->currentView = new pdbjs_View($this->session->currentView, realpath($value));
d1327 1
a1327 1
			$this->session->currentView = new pdbjs_VariableView($this->session->currentView, $name, $value);
d1349 1
a1349 1
		pdbjs_Logger::debug("illegal packet: " . print_r($this->packet, true));
d1376 1
a1376 1
	$stepNext = $this->session->currentFrame->stepNext == pdbjs_JSDebugger::STEP_INTO ? pdbjs_JSDebugger::STEP_INTO : false;
d1378 2
a1379 2
	pdbjs_Logger::debug("startCall::$scriptName, $stepNext");
	$env = new pdbjs_Environment($this->session->currentFrame, $scriptName, $stepNext);
d1407 1
a1407 1
	pdbjs_Logger::debug("scriptName::$scriptName, $isDebugger");
d1409 2
a1410 2
	$stepNext = $this->session->currentFrame->stepNext == pdbjs_JSDebugger::STEP_INTO ? pdbjs_JSDebugger::STEP_INTO : false;
	$this->session->currentFrame = new pdbjs_Environment($this->session->currentFrame, $scriptName, $stepNext);
d1420 2
a1421 2
	pdbjs_Logger::debug("include:::".$code);
	return $code; // eval -> pdbjs_step/MSG_READY or pdbjs_endInclude/MSG_READY OR FINISH
d1442 1
a1442 1
	pdbjs_Logger::logDebug("step: $scriptName @@ $line");
d1444 2
a1445 2
	$this->session->currentFrame = (isset($vars['__pdbjs_CurrentFrame'])) ? $vars['__pdbjs_CurrentFrame'] : $this->session->currentTopLevelFrame;
	unset($vars['__pdbjs_CurrentFrame']);
d1451 1
a1451 1
	  pdbjs_Logger::logDebug("continue");
d1458 1
a1458 1
	  if ($stepNext != pdbjs_JSDebugger::GO) {
d1462 1
a1462 1
		if ($stepNext != pdbjs_JSDebugger::STEP_OUT)
d1473 1
a1473 1
	pdbjs_Logger::logDebug("endStep: $scriptName @@ $line");
d1481 1
a1481 1
function pdbjs_getDefinedVars($vars1, $vars2) {
d1484 1
a1484 1
  unset($vars1['__pdbjs_Code']);	   // see pdbjs_Message::doEval()
d1493 3
a1495 3
function pdbjs_startCall($scriptName) {
  global $pdbjs_dbg;
  if (isset($pdbjs_dbg)) return $pdbjs_dbg->startCall($scriptName);
d1502 3
a1504 3
function pdbjs_startInclude($scriptName) {
  global $pdbjs_dbg;
  if (isset($pdbjs_dbg)) return $pdbjs_dbg->startInclude($scriptName);
d1512 3
a1514 3
function pdbjs_endInclude() {
  global $pdbjs_dbg;
  if (isset($pdbjs_dbg)) $pdbjs_dbg->endInclude();
d1521 3
a1523 3
function pdbjs_step($scriptName, $line, $vars) {
  global $pdbjs_dbg;
  if (isset($pdbjs_dbg)) $pdbjs_dbg->step($scriptName, $line, $vars);
d1529 4
a1532 4
function pdbjs_error_handler($errno, $errstr, $errfile, $errline) {
  global $pdbjs_dbg;
  if (PDBJS_DEBUG) pdbjs_Logger::debug("PHP error $errno: $errstr in $errfile line $errline");
  if ($pdbjs_dbg->end) return false;
d1535 1
a1535 1
   $pdbjs_dbg->setError($errno, $errfile, $errline, $errstr);
d1543 4
a1546 4
function pdbjs_shutdown() {
  global $pdbjs_dbg;
  if (PDBJS_DEBUG) pdbjs_Logger::debug("PHP error: ".print_r(error_get_last(), true));
  if ($pdbjs_dbg->end) return;
d1550 3
a1552 3
	$pdbjs_dbg->setError($error['type'], $error['file'], $error['line'], $error['message']);
	$pdbjs_dbg->end();
	$pdbjs_dbg->shutdown();
d1556 2
a1557 2
if (PDBJS_DEBUG==2) {
 $parser = new pdbjs_Parser("test.php", file_get_contents("test.php"));
d1563 1
a1563 1
if (!isset($_SERVER['HTTP_XPDBJS_DEBUGGER'])) {
d1706 2
a1707 2
var serverID = <?php echo pdbjs_JSDebuggerClient::getServerID(); ?>;
var scriptName = "<?php echo pdbjs_JSDebuggerClient::getDebugScriptName(); ?>";
d1710 1
a1710 1
var debuggerURL = "<?php echo pdbjs_JSDebuggerClient::getDebuggerURL(); ?>";
d1788 1
a1788 1
  http.setRequestHeader("XPDBJS-DEBUGGER", 0);
d1798 1
a1798 1
	data = "<?php echo pdbjs_JSDebuggerClient::getPostData(); ?>";
d1807 1
a1807 1
  httpCtrl.setRequestHeader("XPDBJS-DEBUGGER", getServerID());
d1971 1
a1971 1
} elseif (($serverID = $_SERVER['HTTP_XPDBJS_DEBUGGER']) != "0") {
d1978 4
a1981 4
 $pdbjs_dbg = new pdbjs_JSDebugger((int)$serverID);
 $pdbjs_dbg->handleRequests();
 $pdbjs_dbg->shutdown();
 pdbjs_Logger::debug("SERVER TERMINATED!");
d1990 1
a1990 1
 pdbjs_JSDebuggerClient::handleRequest ($_POST);
@


1.9
log
@Release-6-1-2-1
@
text
@d754 4
a757 2
	if ((strlen($scriptDir) < strlen($scriptDirName)) || 
		(substr($scriptDir, -strlen($scriptDirName)) != $scriptDirName))
d795 1
d1562 1
a1562 1
PHPDebugger version 1.0beta
@


1.8
log
@Release-6-1-2
@
text
@d4 1
a4 1
	 PHPDebugger.php version 1.0beta -- A pure PHP debugger.
d42 2
a43 2
define ("PDB_DEBUG", 0);
ini_set("max_execution_time", 40);
d45 3
a47 3
$pdb_version = phpversion();
if ((version_compare("5.3.0", $pdb_version, ">")))
  trigger_error("<br><strong>PHP ${pdb_version} too old.</strong><br>\nPlease set the path to a PHP >= 5.3 executable, see php_exec in the WEB-INF/web.xml", E_USER_ERROR);
a64 94
/** Use our own json coder, if no native implementation is available */
if (!function_exists("json_encode")) {
  /**
   * @@access private
   */
  function json_decode($v) {
	$length = strlen($v);
	$inDquote = false;
	$inQuote = false;
	$decoded = array();
	$ctr = 0;
	$str = "";
	
	for ($i=0; $i<$length; $i++) {
	  $val = $v[$i];
	  if ($inDquote) {
		if ($inQuote) {
		  $inQuote = false;
		  switch($val) {
		  case 'b': $str.="\b"; break;
		  case 't': $str.="\t"; break;
		  case 'n': $str.="\n"; break;
		  case 'r': $str.="\r"; break;
		  case 'f': $str.="\f"; break;
		  case '\"': $str.="\""; break;
		  case '/': $str.="/"; break;
		  case '\\': $str.='\\'; break;
		  default: 
			trigger_error("Cannot json decode value ${val}", E_USER_ERROR);
		  }
		} else {
		  switch($val) {
		  case '"': $inDquote = false; break;
		  case '\\': $inQuote = true; break;
		  default: $str .= $val; break;
		  }
		}
	  } else {
		switch($val) {
		case ':': $key = $str; $str = ""; break;
		case '}':
		case ',': $val = $str; $str = ""; $decoded[$key]=$val; break;
		case '"': $inDquote = true; break;
		}
	  }
	}
	return (object)$decoded;
  }
  /**
   * @@access private
   */
  function json_encode($array) {
	$first = true;
	$encoded = "{";
	foreach ($array as $k=>$v) {
	 
	  if (!$first) 
		$encoded.=","; 
	  else 
		$first = false;
	 
	  $encoded.='"';
	  $encoded.=$k;
	  $encoded.='":"';
	  $length = strlen($v);
	  for ($i=0; $i<$length; $i++) {
		$val = $v[$i];
		switch($val) {
		case "\b": $encoded.='\b'; break;
		case "\t": $encoded.='\t'; break;
		case "\n": $encoded.='\n'; break;
		case "\r": $encoded.='\r'; break;
		case "\f": $encoded.='\f'; break;
		case "\"": $encoded.='\"'; break;
		case "/": $encoded.='\/'; break;
		case "\\": $encoded.="\\\\"; break;
		default: 
		  $code = ord($val);
		  if ($code > 0x7f) {
			trigger_error("Cannot json encode non-ascii value ${val}", E_USER_WARNING); 
			$encoded.= chr(0x7f & $code);
		  } else {
			$encoded.=$val;
		  }
		  break;
		}
	  }
	  $encoded.='"';
	}
	
	$encoded.="}";
	return $encoded;
  }
}
d69 1
a69 1
class pdb_Logger {
d76 1
a76 1
  private static $logFileName = "/tmp/pdb_PHPDebugger.log";
d79 1
a79 1
	if (!self::$logLevel) self::$logLevel=PDB_DEBUG?self::DEBUG:self::INFO;
d118 1
a118 1
interface pdb_Queue {
d160 1
a160 1
class pdb_PollingServerConnection implements pdb_Queue {
d171 1
a171 1
  public function pdb_PollingServerConnection($id) {
d173 1
a173 1
	$this->chanTrm = "pdb_trmserver{$this->id}";
d189 2
a190 2
	$chanCtr = "pdb_ctr{$this->role}{$this->id}";
	$chan = "pdb_{$this->role}{$this->id}";
d197 2
a198 2
	$chanCtr = "pdb_ctr{$this->role}{$this->id}";
	$chan = "pdb_{$this->role}{$this->id}";
d214 2
a215 2
	$chanCtr = "pdb_ctr{$this->role}{$this->id}";
	$chan = "pdb_{$this->role}{$this->id}";
d218 1
a218 1
	  pdb_Logger::debug("...{$this->role}, {$this->id} poll...");
d231 1
a231 1
	$chan = "pdb_{$this->to}{$this->id}";
d248 2
a250 2
	  else
		usleep(self::TIMER_DURATION*5);
d281 1
a281 1
	pdb_Logger::debug("session terminated: {$this->chanTrm}");
d294 1
a294 1
class pdb_PollingClientConnection extends pdb_PollingServerConnection {
d303 2
a304 2
	$chanCtr = "pdb_ctr{$this->role}{$this->id}";
	$chan = "pdb_{$this->role}{$this->id}";
d307 1
a307 1
	  pdb_Logger::debug("...{$this->role}, {$this->id} poll...");
d342 1
a342 1
class pdb_Parser {
d359 1
a359 1
  public function pdb_Parser($scriptName, $content) {
d406 1
a406 1
	if (PDB_DEBUG == 2) 
d409 1
a409 1
	  $this->write("eval('?>'.pdb_startInclude($name)); pdb_endInclude();");
d424 1
a424 1
	$this->write("\$__pdb_CurrentFrame=pdb_startCall(\"$scriptName\");");
d432 1
a432 1
	  if (PDB_DEBUG == 2)
d435 1
a435 1
		$this->write(";pdb_step(\"$scriptName\", $lastLine, pdb_getDefinedVars(get_defined_vars(), (isset(\$this) ? \$this : NULL)));");
d519 1
a519 1
	pdb_Logger::debug("parse:::$type");
d527 1
a527 1
		pdb_Logger::debug(":::".$token);
d554 1
a554 1
		pdb_Logger::debug(":::".$token[1].":(".token_name($token[0]).')');
d733 1
a733 1
class pdb_JSDebuggerClient {
d826 1
a826 1
	return new pdb_PollingClientConnection($id);
d839 1
a839 1
	pdb_Logger::debug("beginHandleRequest: ".$msg->cmd);
d849 1
a849 1
	pdb_Logger::debug("endHandleRequest");
d861 1
a861 1
class pdb_View {
d873 1
a873 1
  public function pdb_View($parent, $scriptName) {
d929 1
a929 1
class pdb_VariableView extends pdb_View {
d936 2
a937 2
  public function pdb_VariableView($parent, $name, $value) {
	parent::pdb_View($parent, $name);
d944 1
a944 5
	if (function_exists("java_get_base") && java_server_name() && 
		is_object($this->value) && ($this->value instanceof java_JavaType)) 
	  return (highlight_string(java_cast($this->value, "S"), true));
	else
	  return (highlight_string($this->value, true));
d952 1
a952 1
class pdb_Environment extends pdb_View {
d965 2
a966 2
  public function pdb_Environment($parent, $scriptName, $stepNext) {
	parent::pdb_View($parent, $scriptName);
d982 1
a982 1
	return "pdb_Environment: {$this->scriptName}, {$this->line}";
d989 1
a989 1
class pdb_Breakpoint {
d1005 1
a1005 1
  public function pdb_Breakpoint($breakpointName, $scriptName, $line) {
d1025 1
a1025 1
final class pdb_Session {
d1044 1
a1044 1
  public function pdb_Session($scriptName) {
d1046 1
a1046 1
	$this->currentTopLevelFrame = $this->currentFrame = new pdb_Environment(null, $scriptName, true);
d1092 1
a1092 1
	  $this->breakpoints[$id] = new pdb_Breakpoint($breakpoint, $this->getCurrentViewScriptName(), substr($breakpoint, 3));
d1110 1
a1110 1
	  pdb_Logger::debug("process breakpoint::: $scriptName, $line:: $breakpoint");
d1124 1
a1124 1
	$parser = new pdb_Parser($scriptName, $content);
d1127 2
a1128 2
  private static function doEval($__pdb_Code) {
	return eval ("?>".$__pdb_Code);
d1137 2
a1138 2
	if (PDB_DEBUG) pdb_Logger::debug("eval:::$code,".$this->getScriptName()."\n");
	if (!PDB_DEBUG) ob_start();
d1141 1
a1141 1
	if(!PDB_DEBUG) ob_end_clean();
d1152 2
a1153 2
class pdb_JSDebugger {
  /** The pdb_Session */
d1157 1
a1157 1
  private $end;
d1168 1
a1168 1
	return new pdb_PollingServerConnection($id);
d1175 1
a1175 1
  public function pdb_JSDebugger($id) {
d1184 5
d1210 1
a1210 1
	if (PDB_DEBUG) pdb_Logger::debug("->".print_r($data, true));
d1232 1
a1232 1
	  if (PDB_DEBUG) pdb_Logger::debug("handleRequests: accept");
d1236 1
a1236 1
	  if (PDB_DEBUG) pdb_Logger::debug("handleRequests: done accept ".$this->packet->cmd);
d1256 1
a1256 1
		$this->session = new pdb_Session(urldecode($this->packet->scriptName));
d1301 4
a1304 3
		  $value = $this->session->currentFrame->vars["$idx"];

		  $this->session->currentView = new pdb_VariableView($this->session->currentView, $name, $value);
d1308 1
a1308 1
			$this->session->currentView = new pdb_View($this->session->currentView, realpath($value));
d1310 1
a1310 1
			$this->session->currentView = new pdb_VariableView($this->session->currentView, $name, $value);
d1329 1
a1329 5
		$this->session->currentView = null;
		$this->write(array("cmd"=>$this->packet->cmd,
						   "seq"=>$this->packet->seq, 
						   "output"=>$this->getOutput()));
		$this->end = true;
d1332 1
a1332 1
		pdb_Logger::debug("illegal packet: " . print_r($this->packet, true));
d1338 7
d1359 1
a1359 1
	$stepNext = $this->session->currentFrame->stepNext == pdb_JSDebugger::STEP_INTO ? pdb_JSDebugger::STEP_INTO : false;
d1361 2
a1362 2
	pdb_Logger::debug("startCall::$scriptName, $stepNext");
	$env = new pdb_Environment($this->session->currentFrame, $scriptName, $stepNext);
d1390 1
a1390 1
	pdb_Logger::debug("scriptName::$scriptName, $isDebugger");
d1392 2
a1393 2
	$stepNext = $this->session->currentFrame->stepNext == pdb_JSDebugger::STEP_INTO ? pdb_JSDebugger::STEP_INTO : false;
	$this->session->currentFrame = new pdb_Environment($this->session->currentFrame, $scriptName, $stepNext);
d1403 2
a1404 2
	pdb_Logger::debug("include:::".$code);
	return $code; // eval -> pdb_step/MSG_READY or pdb_endInclude/MSG_READY OR FINISH
d1425 1
a1425 1
	pdb_Logger::logDebug("step: $scriptName @@ $line");
d1427 2
a1428 2
	$this->session->currentFrame = (isset($vars['__pdb_CurrentFrame'])) ? $vars['__pdb_CurrentFrame'] : $this->session->currentTopLevelFrame;
	unset($vars['__pdb_CurrentFrame']);
d1434 1
a1434 1
	  pdb_Logger::logDebug("continue");
d1441 1
a1441 1
	  if ($stepNext != pdb_JSDebugger::GO) {
d1445 1
a1445 1
		if ($stepNext != pdb_JSDebugger::STEP_OUT)
d1456 1
a1456 1
	pdb_Logger::logDebug("endStep: $scriptName @@ $line");
d1464 1
a1464 1
function pdb_getDefinedVars($vars1, $vars2) {
d1467 1
a1467 1
  unset($vars1['__pdb_Code']);	   // see pdb_Message::doEval()
d1476 3
a1478 3
function pdb_startCall($scriptName) {
  global $dbg;
  if (isset($dbg)) return $dbg->startCall($scriptName);
d1485 3
a1487 3
function pdb_startInclude($scriptName) {
  global $dbg;
  if (isset($dbg)) return $dbg->startInclude($scriptName);
d1495 3
a1497 3
function pdb_endInclude() {
  global $dbg;
  if (isset($dbg)) $dbg->endInclude();
d1504 33
a1536 3
function pdb_step($scriptName, $line, $vars) {
  global $dbg;
  if (isset($dbg)) $dbg->step($scriptName, $line, $vars);
d1539 2
a1540 2
if (PDB_DEBUG==2) {
 $parser = new pdb_Parser("test.php", file_get_contents("test.php"));
d1546 1
a1546 1
if (!isset($_SERVER['HTTP_XPDB_DEBUGGER'])) {
d1689 2
a1690 2
var serverID = <?php echo pdb_JSDebuggerClient::getServerID(); ?>;
var scriptName = "<?php echo pdb_JSDebuggerClient::getDebugScriptName(); ?>";
d1693 1
a1693 1
var debuggerURL = "<?php echo pdb_JSDebuggerClient::getDebuggerURL(); ?>";
d1771 1
a1771 1
  http.setRequestHeader("XPDB-DEBUGGER", 0);
d1781 1
a1781 1
	data = "<?php echo pdb_JSDebuggerClient::getPostData(); ?>";
d1790 1
a1790 1
  httpCtrl.setRequestHeader("XPDB-DEBUGGER", getServerID());
d1916 8
a1923 2
  if (getEventSource(event)&& getEventSource(event).firstChild && getEventSource(event).firstChild.data) {
	switchView(trim(getEventSource(event).firstChild.data));
a1946 1

d1954 1
a1954 1
} elseif (($serverID = $_SERVER['HTTP_XPDB_DEBUGGER']) != "0") {
d1961 4
a1964 4
 $dbg = new pdb_JSDebugger((int)$serverID);
 $dbg->handleRequests();
 $dbg->shutdown();
 pdb_Logger::debug("SERVER TERMINATED!");
d1973 1
a1973 1
 pdb_JSDebuggerClient::handleRequest ($_POST);
@


1.7
log
@Release-6-1-0
@
text
@a1204 2
	static $first = true;
  
a1209 3
		if ($first && $breakpoint->scriptName==$scriptName&&$breakpoint->line==-1) {
		  $first = false; return true;
		}
@


1.6
log
@Release-6-0-3
@
text
@d831 1
a831 1
	return $scriptName == "PHPDebugger.php" ? $script :"java/PHPDebugger.php";
a837 1
 
d871 1
a871 1
	$path = realpath(self::getDebuggerFilename());
d873 1
a873 1
	  trigger_error("No such file or directory: $path", E_USER_ERROR);
d887 1
a887 1
	if ($root)
@


1.5
log
@Release-6-0-0
@
text
@d17 1
a17 1
	 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
d21 1
a21 1
	 along with the PHPDebugger; see the file COPYING.  If not, write to the
d26 1
a26 1
	 making a combined work based on this library.  Thus, the terms and
d36 2
a37 2
	 module.  An independent module is a module which is not derived from
	 or based on this library.  If you modify this library, you may extend
d39 1
a39 1
	 obligated to do so.  If you do not wish to do so, delete this
d49 14
a62 14
  
  /**
   * Usage:
   * 
   * 1. include() this file at the beginning of your script
   *
   * 2. browse to your script using firefox 
   *
   * 3. set breakpoints using the JavaScript GUI, click on any
   * variable or included file to visit that variable or file
   * 
   * 4. click on the stop button to terminate the debug session
   *
   */
d90 2
a91 2
		  case '/':  $str.="/"; break;
		  case '\\':  $str.='\\'; break;
d120 1
a120 1
	  
d125 1
a125 1
	  
d139 1
a139 1
		case "/":  $encoded.='\/'; break;
d209 3
a211 3
  /**
   * @@access private
   */
d249 1
a249 1
 * This class represents the debugger back end connection.  It
d266 2
a267 2
    $this->id = $id;
    $this->chanTrm = "pdb_trmserver{$this->id}";
d270 1
a270 1
    $this->init();
d278 1
a278 1
    session_start();
d280 2
a281 2
    $this->role = "client";
    $this->to   = "server";
d283 2
a284 2
    $chanCtr = "pdb_ctr{$this->role}{$this->id}";
    $chan = "pdb_{$this->role}{$this->id}";
d288 2
a289 2
    $this->role = "server";
    $this->to   = "client";
d291 2
a292 2
    $chanCtr = "pdb_ctr{$this->role}{$this->id}";
    $chan = "pdb_{$this->role}{$this->id}";
d307 4
a310 4
    $val = "";
    $chanCtr = "pdb_ctr{$this->role}{$this->id}";
    $chan = "pdb_{$this->role}{$this->id}";
    session_start();
d321 2
a322 2
    session_write_close();
    return $val;
d325 2
a326 2
    $chan = "pdb_{$this->to}{$this->id}";
    session_start();
d328 1
a328 1
    session_write_close();
d336 1
a336 1
    $val = null;
d346 1
a346 1
    return $val === true ? null : $val;
d376 1
a376 1
    session_start();
d378 1
a378 1
    session_write_close();
d380 1
a380 1
}    
d383 1
a383 1
 * This class represents the debugger front end connection.  It
d392 2
a393 2
    $this->role = "client";
    $this->to   = "server";
d397 3
a399 3
    $chanCtr = "pdb_ctr{$this->role}{$this->id}";
    $chan = "pdb_{$this->role}{$this->id}";
    session_start();
d411 2
a412 2
    session_write_close();
    return $val;
d446 1
a446 1
  
d454 6
a459 6
    $this->scriptName = $scriptName;
    $this->content = $content;
    $this->code = token_get_all($content);
    $this->output = "";
    $this->line = $this->currentLine = 0;
    $this->beginStatement = $this->inPhp = $this->inDQuote = false;
d484 2
a485 2
    //echo "write:::".$code."\n";
    $this->output.=$code;
d489 2
a490 2
    $name = "";
    while(1) {
d492 2
a493 2
      $val = current($this->code);
      if (is_array($val)) {
d495 1
a495 1
      } else {
d498 6
a503 6
      }
    }
    if (PDB_DEBUG == 2) 
      $this->write("EVAL($name);");
    else
      $this->write("eval('?>'.pdb_startInclude($name)); pdb_endInclude();");
d507 1
a507 1
    while(1) {
d509 2
a510 2
      $val = current($this->code);
      if (is_array($val)) {
d512 1
a512 1
      } else {
d515 2
a516 2
      }
    }
d518 1
a518 1
    $this->write("\$__pdb_CurrentFrame=pdb_startCall(\"$scriptName\");");
d522 5
a526 5
    $token = current($this->code);
    if ($this->inPhp && !$pLevel && !$this->inDQuote && $this->beginStatement && !$this->isWhitespace($token) && ($this->line != $this->currentLine)) {
      $lastLine = $this->line = $this->currentLine;
      $scriptName = $this->scriptName;
      if (PDB_DEBUG == 2)
d528 1
a528 1
      else
d530 1
a530 1
    }
d541 5
a545 5
    $i = 0;
    while(each($this->code)) {
      $cur = current($this->code);
      $i++;
      if (is_array($cur)) {
d550 1
a550 1
		  break;		/* skip */
d553 1
a553 1
		  return false;		/* not found */
d555 1
a555 1
      } else {
d558 4
a561 4
      }
    }
    while($i--) prev($this->code);
    return false;		/* not found */
d565 5
a569 5
    $i = 0;
    while(each($this->code)) {
      $cur = current($this->code);
      $i++;
      if (is_array($cur)) {
d574 1
a574 1
		  break;		/* skip */
d579 1
a579 1
      } else {
d581 4
a584 4
      }
    }
    while($i--) prev($this->code);
    return false;		/* not found */
d588 2
a589 2
    $isWhitespace = false;
    switch($token[0]) {
d595 2
a596 2
    }
    return $isWhitespace;
d615 1
a615 1
    $this->beginStatement = true;
d618 3
a620 3
    do {
      $token = current($this->code);
      if (!is_array($token)) {
d632 1
a632 1
		  case '{':  
d647 1
a647 1
      } else {
d735 2
a736 2
        case T_ELSEIF:
        case T_FOR:
d804 2
a805 2
      }
    } while($this->each());
d814 3
a816 3
    do {
      $this->parseBlock();
    } while($this->each());
d818 1
a818 1
    return $this->output;
d823 1
a823 1
 * This structure represents the debugger front-end.  It is used by the
d833 1
a833 1
		
d837 2
a838 2
  
  
d840 2
a841 2
	$scriptDir     = dirname($scriptFilename);
  
d849 5
a853 1
	return substr($scriptDir, 0, strlen($scriptDir)-strlen($scriptDirName));
d887 6
a892 2
    
	$path = "${prefix}" . str_replace('\\', '/', substr($path, strlen($root)));
d902 5
a906 5
    $str = '';
    foreach ($_POST as $key => $value) {
        if ($str) $str .= '&';
        $str .= $key . '=' . urlencode($value);
    }
d919 1
a919 1
  
d969 2
a970 2
    $this->parent = $parent;
    $this->scriptName = $scriptName;
d972 2
a973 2
    $this->bpCounter = $this->lineCounter = 1;
    $this->code = null;
d996 2
a997 2
    if (!$this->code) {
      $c=
d1007 1
a1007 1
      $code = ereg_replace('<br />', $c, $code);
d1009 1
a1009 1
      $code = ereg_replace('"(([^>])|([^/]>)|([^ ]/>)|([^r] />)|([^b]r />)|([^<]br />))(</span>\n</span>\n</code>)"', '\1 $c \8', $code);
d1017 1
a1017 1
    return $this->code;
d1032 2
a1033 2
    parent::pdb_View($parent, $name);
    $this->value = $value;
d1065 3
a1067 3
    parent::pdb_View($parent, $scriptName);
    $this->stepNext = $stepNext;
    $this->line = -1;
d1076 2
a1077 2
    $this->line = $line;
    $this->vars = $vars;
d1105 3
a1107 3
    $this->breakpoint = $breakpointName;
    $this->scriptName = $scriptName;
    $this->line = $line;
d1109 1
a1109 1
    $this->type = 1;
d1120 1
a1120 1
 * script output and all breakpoints set by the client.  An optional
d1144 2
a1145 2
    $this->breakpoints = $this->lines = array();
    $this->currentTopLevelFrame = $this->currentFrame = new pdb_Environment(null, $scriptName, true);
d1148 1
a1148 1
    $this->currentView = null;
d1155 2
a1156 2
    return $this->currentView ? $this->currentView->getHtmlScriptSource() : $this->currentFrame->getHtmlScriptSource();
  }      
d1162 1
a1162 1
    return $this->currentFrame->scriptName;
d1169 2
a1170 2
    return $this->currentView ? $this->currentView->scriptName : $this->getScriptName();
  }      
d1176 6
a1181 6
    $bp = array();
    foreach ($this->breakpoints as $breakpoint) {
      if ($this->getCurrentViewScriptName() != $breakpoint->scriptName) continue;
      array_push($bp, $breakpoint->breakpoint);
    }
    return $bp;
d1189 3
a1191 3
    $id = $breakpoint."@@".$this->getCurrentViewScriptName();
    if (!isset($this->breakpoints[$id])) {
      $this->breakpoints[$id] = new pdb_Breakpoint($breakpoint, $this->getCurrentViewScriptName(), substr($breakpoint, 3));
d1193 3
a1195 3
    } else {
      $bp = $this->breakpoints[$id];
      unset ($this->breakpoints[$id]);
d1197 1
a1197 1
    }
d1206 7
a1212 7
    static $first = true;
    
    if ($this->currentFrame->stepNext) return true;
    
    foreach ($this->breakpoints as $breakpoint) {
	  pdb_Logger::debug("process breakpoint::: $scriptName, $line::  $breakpoint");
      if($breakpoint->type==1) {
d1217 3
a1219 3
      }
    }
    return false;
d1232 1
a1232 1
    return  eval ("?>".$__pdb_Code);
d1239 1
a1239 1
    $code = $this->parseCode($this->getScriptName(), file_get_contents($this->getScriptName()));
d1241 5
a1245 5
    if (PDB_DEBUG) pdb_Logger::debug("eval:::$code,".$this->getScriptName()."\n");
    if (!PDB_DEBUG) ob_start();
    self::doEval ($code);
    $this->output = ob_get_contents();
    if(!PDB_DEBUG) ob_end_clean();
d1247 1
a1247 1
    return $this->output;
d1260 1
a1260 1
  
d1267 2
a1268 2
  const STEP_OUT  = 3;
  const GO        = 4;
d1281 2
a1282 2
    $this->id = $id;
    $this->conn = $this->getConnection($id);
d1284 1
a1284 1
    $this->end = false;
d1294 1
a1294 1
    return $this->id;
d1308 3
a1310 3
    $data["serverID"] = $this->getServerID();
    if (PDB_DEBUG) pdb_Logger::debug("->".print_r($data, true));
    return $this->conn->write($data);
d1313 1
a1313 1
    $this->write(array("cmd"=>$this->packet->cmd,
d1330 4
a1333 4
    while(!$this->end) {
      if (PDB_DEBUG) pdb_Logger::debug("handleRequests: accept");
      
      if (!($this->packet = $this->read())) break; // ignore __destructors after shutdown
d1335 1
a1335 1
      if (PDB_DEBUG) pdb_Logger::debug("handleRequests: done accept ".$this->packet->cmd);
d1337 2
a1338 2
      switch($this->packet->cmd) {
      case "status":
d1353 1
a1353 1
      case "begin":
d1364 1
a1364 1
      case "stepNext":
d1369 1
a1369 1
      case "stepOver":
d1374 1
a1374 1
      case "go":
d1379 1
a1379 1
      case "stepOut":
d1384 1
a1384 1
      case "toggleBreakpoint":
d1396 1
a1396 1
      case "switchView":
d1412 1
a1412 1
      case "backView":
d1417 1
a1417 1
      case "output":
d1426 1
a1426 1
      case "end":
d1436 2
a1437 2
      }
    }
d1445 1
a1445 1
    $this->conn->shutdown();
d1453 2
a1454 2
    /* check for stepOver and stepOut */
    $stepNext = $this->session->currentFrame->stepNext == pdb_JSDebugger::STEP_INTO ? pdb_JSDebugger::STEP_INTO : false;
d1457 1
a1457 1
    $env = new pdb_Environment($this->session->currentFrame, $scriptName, $stepNext);
d1466 2
a1467 2
    if (file_exists($scriptName)) return realpath($scriptName);
    $paths = explode(PATH_SEPARATOR, get_include_path());
d1469 5
a1473 5
    foreach ($paths as $path) {
      $scriptName = realpath("${path}${name}");
      if ($scriptName) return $scriptName;
    }
    trigger_error("file $scriptName not found", E_USER_ERROR);
d1487 2
a1488 2
    $stepNext = $this->session->currentFrame->stepNext == pdb_JSDebugger::STEP_INTO ? pdb_JSDebugger::STEP_INTO : false;
    $this->session->currentFrame = new pdb_Environment($this->session->currentFrame, $scriptName, $stepNext);
d1491 4
a1494 4
    if ($isDebugger) // do not debug self
      $code = "<?php ?>";
    else
      $code = $this->session->parseCode(realpath($scriptName), file_get_contents($scriptName));
d1499 1
a1499 1
    return $code; // eval -> pdb_step/MSG_READY or pdb_endInclude/MSG_READY OR FINISH
d1521 3
a1523 3
    // pull the current frame from the stack or the top-level environment
    $this->session->currentFrame = (isset($vars['__pdb_CurrentFrame'])) ? $vars['__pdb_CurrentFrame'] : $this->session->currentTopLevelFrame;
    unset($vars['__pdb_CurrentFrame']);
d1525 1
a1525 1
    $this->session->currentFrame->update($line, $vars);
d1527 2
a1528 2
    if ($this->session->hasBreakpoint($scriptName, $line)) {
      $stepNext = $this->handleRequests();
d1562 1
a1562 1
  unset($vars1['__pdb_Code']);	     // see pdb_Message::doEval()
d1564 1
a1564 1
  return $vars1;   
d1605 3
a1607 3
  $parser = new pdb_Parser("test.php", file_get_contents("test.php"));
  echo $parser->parseScript();
  exit (2);
d1613 6
a1618 6
    session_start();
    header("Expires: Sat, 1 Jan 2005 00:00:00 GMT");
    header("Last-Modified: ".gmdate( "D, d M Y H:i:s")." GMT");
    header("Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0");
    header("Pragma: no-cache");
    header("Content-Type: text/html");
d1628 6
a1633 6
    height: 13px;
    width: 17px;
    display: inline-block;
    position: relative;
    margin: 1px 10px 1px 10px;
   background:green url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAANCAYAAABPeYUaAAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLBwcXGXdF1DwAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAABEUlEQVQoz62SoWvDUBDGfx0Rry6VzzUyg4lEVgYmRulfMVUKVWOqTFVWDULVbNxsTSETg8jOzm+QwcSL28ECmwhJGpqwwnrmfXfv7nvf3b2e+TQ//NMsgPRlQfoeQ14E9TBAe0uC9QyAeBoeQfK6IZjuqmC89tHeEoDFxP+TzKqQJK0JksPNlQ/QSWYBiJQVKShd+4DJa+f68hyA0f0M7fR5nKyaSiQTlHwgatB4JXkzB+q8C12RJfNwr522Vr4hy7PjtgOgbAWZKs6SRASt+gfZ8bPBcQck83B/Jl/Fre3S8AGlarx5Kuazu33o2I4atUq1LYi27cUNEj0cE925VdBxxxWOttJZXFrvFN/+jBPYL4uJYFb2zCiIAAAAAElFTkSuQmCC') no-repeat;
d1636 6
a1641 6
    height: 13px;
    width: 13px;
    display: inline-block;
    position: relative;
    margin: 1px 10px 1px 10px;
    background:red url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAANCAYAAABy6+R8AAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLBwYrNECrm4EAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAAwUlEQVQoz52SLQ7CQBCFvyaI4nYlciWSI3CEFkVQGAyOcBU0ClCARCKRHGFlN0HsuK4D0RRasWnKJOPel/fmJ/Ev/6ZnDQD89YzcL51iNc3R2ayC5HZkslx3Qs/97gcBEEBOh7jLfNGOh5RY8egQd7HiQcoG9HULPRZRwthagvdR4chapBUPQELVsZKAL8HUkBZApVVHN5FWuhoKzlEYg06HUaYwhuBcO55RGjbxWynANWdSWc5jte3+iCwHIPnn9z7J30SR7ayFNQAAAABJRU5ErkJggg==') no-repeat;
d1644 6
a1649 6
    height: 13px;
    width: 17px;
    display: inline-block;
    position: relative;
    margin: 1px 10px 1px 10px;
    background: yellow url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAANCAYAAABPeYUaAAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLBwYtD6f61SMAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAA6ElEQVQoz2N8//r9fwYKAQuMcWy6JlYFmq4lDIIqyYQNOTZdk8Gr8jpWBdvaNRkUPz9nkDSswWkII8w72Fyi6JjMoGmRw7Ct3ZDBKvM6Ye9gU3RsuiaDpkkywTBhIqjizwfiAxbdBQhDfqCIYXMxVkN+fGdgCCqaCzXkPYNXJoS9ri+ZeO84FV1nWNYUDfEKFC9rimZwKrpOWph41d1nWNaWzcDw5zvDsrZsBq+6+/ijOHn+MQbBzxBF73kVGeYmWiHSSZMiigHY1LIwMDAw/Di/lOHaC4giQYljDAxIhqC7AJtaRmrkHQBYX2Q4HZvQSwAAAABJRU5ErkJggg==') no-repeat;
d1652 6
a1657 6
    height: 13px;
    width: 17px;
    display: inline-block;
    position: relative;
    margin: 1px 10px 1px 10px;
    background: yellow url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAANCAYAAABPeYUaAAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLBwYsOAZcQW0AAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAABSklEQVQoz62TP0jDQBTGv5QMdSgYcEjGgEvHdsyYsW6Kg27SKeJki1PpEAShqJPYKTilHUS3dOyYbu1mhpZmERqIcIEOyRA4h9qaeCcK+uA43uPj9/7cO4GEhOKPJmYdMrMQTJ5A3nxGKO2okCsHkHbr30PIzII/slA9vMO2XGWEUTDG+PEMyXIBpdJiIWuAbjiIXkcYXJUZiHZ0A91wMOzuoVhS8hWRkFDHlCmN55RMbeqYMiUhYY5jypRMbUrjOaMpbGhpBLffgGZ43OFphge33wDSiD+TJAaQJqubY243016a5GKa4UFYP/HAVFFr+1zI8LaM/dNLoKh8BpMFnu9b0M8zkJ9sYKo4vrgGxC0gjdHrNDdJC79dqFrbR6/TZAAA+JXUH1xIy5WIlFRYJ1quoq9ti7ysycTGS/CxqbILZCC8uQn/8XfeAUbdtbmYIYl8AAAAAElFTkSuQmCC') no-repeat;
d1660 6
a1665 6
    height: 13px;
    width: 17px;
    display: inline-block;
    position: relative;
    margin: 1px 10px 1px 10px;
    background: yellow url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAANCAYAAABPeYUaAAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLBwYsF62NfDQAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAABAUlEQVQoz62Tv2vCQBTHP5GsDoJDV8f8C44ZM+Y/EOnSgoOCQ4YOxVE6BH9MoZMdM3TI6CLcJNzmLULGCg4p6HBgoB0SFH9gKvYtj7v3fR/ufe/OSNbJD3dG6RaxGFuIsXUfhB04j0OEfwwyi/q+ZI94NjlsVG2cpyGRb1FvKQCMa54kywAZ9XE9eV78FoSjZ+yWun4S+dnH9aao+QAVBQC43hS2ktDvYLfVXz3RqCjYN5wCiiEpkOos5+vw7RhQbGyqIU2yDNhddfs70TlIFwxsAjTfBZVNnN1IuUbQqJ+i9nFJawJoOWGxykSVBwE5xPFiPl5rOC/xAXlBa/zH3/kFlslu4rTXaTUAAAAASUVORK5CYII=') no-repeat;
d1668 7
a1674 7
    height: 13px;
    width: 13px;
    display: inline-block;
    position: relative;
    margin: 1px 10px 1px 10px;
    visibility: visible;
    background: blue url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAANCAYAAABy6+R8AAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLCQYlB4EnoCoAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAABCklEQVQoz42Rv0oDQRCHv4MJbCCFgoUHvkBKXyGPEDufwUokhdFGokWwt7IRbISkTHmvcIUPcUKK3eJgp1g4i92Ld4gxWw2z329+8ye7vF81pcs59J0fVUjpcsZaHCwq3QQBD8Ddcv6vYDF7BDxCACMGgPFov8iIgQACChKTVw9rvCrqPK52+FopPjodCBA0Og1H0el5Nv1VXcNPPDQGHAhBMcnpZrlOJFi1aK1orXhVNm/zxGnbXnRaXE//nEchcm17ZpB+ggImIaaDx9gMaBfhQeD95bVfWiLQi4W48vzkmM1ndfBx89OczG5t001ePBVUX1UPWt1OesLMbm2zA4Puhk3n7LucxQLfZ4Norb3ftQMAAAAASUVORK5CYII=') no-repeat;
d1677 7
a1683 7
    height: 13px;
    width: 16px;
    display: inline-block;
    position: relative;
    margin: 1px 10px 1px 10px;
    visibility: visible;
    background: yellow url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAANCAYAAACgu+4kAAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLBwc3GnvIoSQAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAABH0lEQVQoz5WToU4DQRCGvzZLspUn+wpIJLLyJDiQEBLMJZDAA1QgTlRUU1tXCY+A5BGoPHFiKkhukm4yiD3CNr3S9k8mu/l3Z+af2dme1GJ04HM6hBPP2f2S/9DvIj/KjNG4gUbZh36Xc15GURr2B3Abzi8Z+cQABTyqkdu8BTjP+WMV91KLSS22eMDMGjOrzNZfZuvKzCSxJlnN3p4wqcVclD3kYlJBWEJQCACrJLNvVwXnwWVoSErQbwUEwgq0+ZMa2JYfBuAV1aSJo7EwvzsFmpj515y2/WjNKbim5SN66Ry8P2dcTRexDGBWXDNwHSoc5GPZfoW8FGZFxs30FYCBi9xRc3BZCrPiNoZ2/rg5SIPMi+GO0030dv2FQ/EDM7CYPt7DsBMAAAAASUVORK5CYII=') no-repeat;
d1687 1
a1687 1
    background: transparent;
d1690 1
a1690 1
    background: yellow url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAANCAYAAABy6+R8AAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLBwYQB8PJFa8AAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAABNElEQVQoz4WPsUsCYRjGf8YNNzTo7vJBDgUNHTSc4KBbro6ORy5KU5tN0VhjS+FfEDXaEFxbY9cQuQSfQ3BCwyck3At9YIOieZo98MAL7/vjed6MMWYMcH6aQxUqePsBaqvKOm0A6PcQpaDoh4QPdcL7E8xQr4EsmC9BLKg8NA8hm72kc+Xx9Hi2GhIryMgAIHZibw9aDZDRBZ3rIs9RZ7neTDK3C1RKUC336L0cc3tTR/fDFGTByLLdTagegMp36d7VAHAWQuSPzy0Mh5BM987vxSoojiGKQBUCgkYzBQGSzOdkBNEr4Pj45QBvtza7XkhCILGg+6A1FEttPL+F67oL6RPIcZFveJse72wHBEdtctncyhcz5tOM40GM1iHxR4jnN1F5L1U8DRkzFhGwTGo4/KsfXjWDCQ6TmRMAAAAASUVORK5CYII=') no-repeat;
d1693 1
a1693 1
    background: red url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAANCAYAAABy6+R8AAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLBwYOGJqAJ4UAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAA+0lEQVQoz5XSMUvDUBSG4bcXhyM4pFsudBE6GEfB5UKGZLOjq5uCIE7iPyjdxEXQoZC/4OgipIOQbqZDMW6OcbsZBO8Q0MEWkWJJ3vl7lsPpWGu/WOQqy8s44X2S8ukcmyL4Uczu6QnidZczOktUPqY8HB/Bh2OlLWEwTtAHg19kXwvuQwM1/7cBh08Z3Z0ABZCena8HAPViB6hymlHNcppUzXLKaYaq5gVtquYFitq1QtQO5fWDVsbrBygdGqTnNwLS89GhQSFCfJc0QvHNLYj8nFyHBjMcrQVmOEJH8d+PALD5M/nVNW+TFJwDEbajmODiEr2/t/pGbfoGcP1aToLr9OAAAAAASUVORK5CYII=') no-repeat;
d1697 8
a1704 8
    display: block;
    position: fixed;
    top: 0px;
    left: 0px;
    height: 20px;
    width: 100%;
    z-index: 100;
    background: #efefef;
d1707 5
a1711 5
    display: block;
    position: absolute;
    left: 92px;
    top: 22px;
    z-index: 50;
d1715 7
a1721 7
    display: inline;
    position: absolute;
    left: -92px;
    width: 90px;
    height: 13px;
    background: #efefef;
    overflow: hidden;
d1725 9
a1733 9
    display: inline-block;
    position: relative;
    width: 59px;
    height: 13px;
    text-align: right;
    margin-right: 5px;
    float: right;
    color: black;
    
d1736 5
a1740 5
    display: inline-block;
    position: relative;
    width: 13px;
    height: 13px;
    float: left;
d1743 5
a1747 5
    display: inline-block;
    position: relative;
    width: 13px;
    height: 13px;
    float: left;
d1763 1
a1763 1
  return seq++;
d1766 1
a1766 1
    return serverID;
d1769 3
a1771 3
    var req;
    var browser = navigator.appName;
    if (browser == "Microsoft Internet Explorer") {
d1773 1
a1773 1
    } else {
d1775 2
a1776 2
    }
    return req;
d1779 8
a1786 8
    switch(text.cmd) {
    case 'stepNext': 
    case 'stepOver': 
    case 'go':
    case 'switchView':
    case 'backView':
    case 'begin':
    case 'stepOut':		getStatusCB(text); break;
d1788 1
a1788 1
    case 'output':		showOutputCB(text); break;
d1790 1
a1790 1
    case 'status':		showStatusCB(text); break;
d1792 1
a1792 1
    case 'extendedStatus': showExtendedStatusCB(text); break;
d1794 1
a1794 1
    case 'setBreakpoint':	setBreakpointCB(text); break;
d1796 1
a1796 1
    case 'unsetBreakpoint':	unsetBreakpointCB(text); break;
d1798 2
a1799 2
    case 'term':
    case 'end':			endCB(text); break;
d1801 2
a1802 2
    default: alert("illegal cmd: " + text.cmd); break;
    }
d1805 6
a1810 6
    var elementClassName = element.className;
    if (elementClassName.length == 0) return false;
    if (elementClassName == className ||
        elementClassName.match(new RegExp("(^|\\s)" + className + "(\\s|$)")))
      return true;
    return false;
d1813 1
a1813 1
  document.getElementsByClassName = function(className) {
d1817 5
a1821 5
	  child = children[i];
	  
	  if (hasClassName(child, className)) {
		elements.push(child);
	  }
d1824 1
a1824 1
  }
d1827 11
a1837 11
    var url = debuggerURL;
    data = cmd+"&serverID="+getServerID()+"&seq="+getSeq();
    http.open("POST", url, true);
    http.setRequestHeader("Cache-Control", "no-store, no-cache, must-revalidate, post-check=0, pre-check=0");
    http.setRequestHeader("Last-Modified", date);
    http.setRequestHeader("Pragma", "no-cache");
    http.setRequestHeader("Expires", "Sat, 1 Jan 2005 00:00:00 GMT");
    http.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    http.setRequestHeader("Content-Length", data.length);
    http.setRequestHeader("XPDB-DEBUGGER", 0);
    http.onreadystatechange = function() {
d1839 1
a1839 1
	    doCmd(eval(http.responseText));
d1841 2
a1842 2
    }
    http.send(data);
d1845 1
a1845 1
    var url = debuggerURL;
d1848 9
a1856 9
    httpCtrl.open(method, url, true);
    httpCtrl.setRequestHeader("Cache-Control", "no-store, no-cache, must-revalidate, post-check=0, pre-check=0");
    httpCtrl.setRequestHeader("Last-Modified", date);
    httpCtrl.setRequestHeader("Pragma", "no-cache");
    httpCtrl.setRequestHeader("Expires", "Sat, 1 Jan 2005 00:00:00 GMT");
    httpCtrl.setRequestHeader("Content-Length", data.length);
    httpCtrl.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    httpCtrl.setRequestHeader("XPDB-DEBUGGER", getServerID());
    httpCtrl.onreadystatechange = function() {
d1858 1
a1858 1
	   //alert("debugger exited. Debugger debug output: " +httpCtrl.responseText);
d1860 2
a1861 2
    }
    httpCtrl.send(data);
d1864 1
a1864 1
    sendCmd("cmd=stepNext");
d1867 1
a1867 1
    sendCmd("cmd=stepOver");
d1870 1
a1870 1
    sendCmd("cmd=stepOut");
d1877 2
a1878 2
    startServer();
    sendCmd("cmd=begin&scriptName="+scriptName+"&cwd="+cwd);
d1881 2
a1882 2
    sendCmd("cmd=toggleBreakpoint&breakpoint="+el.id);
    return false;
d1885 1
a1885 1
    document.getElementById(cmd.breakpoint).lastChild.className="breakpointIndicator breakpointSet";
d1888 1
a1888 1
    document.getElementById(cmd.breakpoint).lastChild.className="breakpointIndicator normal";
d1891 2
a1892 2
    currentScriptName = "";
    document.getElementById("code").innerHTML = cmd.output;
d1896 2
a1897 2
    lines = document.getElementsByClassName("currentlineIndicator");
     if (lines.length == 0) return; // no lines to mark
d1899 1
a1899 1
    for (i=0; i<lines.length; i++) {
d1902 2
a1903 2
    }
    for (i=0; i<cmd.breakpoints.length; i++) {
d1906 2
a1907 2
    }
    currentLine = document.getElementById("bp_"+(cmd.line)).firstChild;
d1913 1
a1913 1
    scrollBarHeight = 30;
d1915 2
a1916 2
		(codeLine.offsetTop - document.body.scrollTop + codeDiv.clientTop  <= 0)) {
	  currentLine.scrollIntoView(false);
d1921 1
a1921 1
	  doShowStatusCB(cmd);
d1923 1
a1923 1
	  sendCmd("cmd=extendedStatus"); // another round-trip 
d1934 2
a1935 2
    sendCmd("cmd=stepNext");
    return false;
d1938 2
a1939 2
    sendCmd("cmd=stepOver");
    return false;
d1942 2
a1943 2
    sendCmd("cmd=stepOut");
    return false;
d1946 2
a1947 2
    sendCmd("cmd=end");
    return false;
d1950 1
a1950 1
    document.body.innerHTML = cmd.output;
d1953 2
a1954 2
    sendCmd("cmd=go");
    return false;
d1957 2
a1958 2
    sendCmd("cmd=switchView&scriptName="+data);
    return false;
d1961 2
a1962 2
    sendCmd("cmd=backView");
    return false;
d1965 2
a1966 2
    sendCmd("cmd=output");
    return false;
d1972 2
a1973 2
    nbspChar = String.fromCharCode(160);
    return str.replace(/^\s*/, "").replace(/\s*$/, "").replace(nbspChar,"");
d1976 2
a1977 2
  if (event.target != undefined) return event.target;
  return event.srcElement;
d1980 2
a1981 2
    if (getEventSource(event).parentNode.className=="breakpoint") return true;
    if (getEventSource(event)&& getEventSource(event).firstChild && getEventSource(event).firstChild.data) {
d1983 2
a1984 2
    }
   return false;
d2004 1
a2004 1
  <div onmousemove="return mousemove(this, event);" onmousedown="return mousedown(this, event);" id="code"><span>loading...</span>
d2009 1
a2009 1
  loaded();
d2013 1
a2013 1
  exit (0);
d2016 10
a2025 10
  header("Expires: Sat, 1 Jan 2005 00:00:00 GMT");
  header("Last-Modified: ".gmdate( "D, d M Y H:i:s")." GMT");
  header("Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0");
  header("Pragma: no-cache");
  header("Content-Encoding: identity");
  $dbg = new pdb_JSDebugger((int)$serverID);
  $dbg->handleRequests();
  $dbg->shutdown();
  pdb_Logger::debug("SERVER TERMINATED!");
  exit(0);
d2028 7
a2034 7
  header("Expires: Sat, 1 Jan 2005 00:00:00 GMT");
  header("Last-Modified: ".gmdate( "D, d M Y H:i:s")." GMT");
  header("Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0");
  header("Pragma: no-cache");
  header("Content-Encoding: identity");
  pdb_JSDebuggerClient::handleRequest ($_POST);
  exit(0);
@


1.4
log
@Release-5-5-5
@
text
@d4 1
a4 1
	 PHPDebugger.inc version 1.0beta -- A pure PHP debugger.
d249 2
a250 2
 * This class represents the debugger front end connection.  It
 * communicates with the debugger back end using a shared-memory queue.
d254 1
a254 1
class pdb_PollingClientConnection implements pdb_Queue {
d265 1
a265 1
  public function pdb_PollingClientConnection($id) {
d272 1
d278 2
d282 22
d307 1
d313 6
a318 3
	  if (!isset($_SESSION[$chanCtr])) $_SESSION[$chanCtr] = 0; 
	  if (isset($_SESSION[$chan]) && (count($_SESSION[$chan]) > $_SESSION[$chanCtr])) {
		$val = $_SESSION[$chan][$_SESSION[$chanCtr]++];
d327 1
a327 1
	if (!$this->checkTrm()) $_SESSION[$chan][]=$val;
d339 2
a340 1
	  if ($cntr++<=20) 
d342 1
d346 1
a346 1
    return $val;
d355 1
d373 54
d928 1
a928 1
	$conn->write(json_encode($msg));
d930 4
a933 2
	if (($response = $conn->read()) === true) 
	  $response = json_encode(array("cmd"=>"term", "output"=>$conn->getOutput()));
a934 1
	$output = $response;
d952 1
a952 1
  public $parentView;
d960 2
a961 2
  public function pdb_View($parentView, $scriptName) {
    $this->parentView = $parentView;
d1023 2
a1024 2
  public function pdb_VariableView($parentView, $name, $value) {
    parent::pdb_View($parentView, $name);
d1056 2
a1057 2
  public function pdb_Environment($scriptName, $stepNext) {
    parent::pdb_View(null, $scriptName);
a1059 1

d1071 4
d1120 4
a1123 2
  /** The environment tree */
  public $environments;
d1137 2
a1138 1
    $this->environments = array($this->currentFrame = new pdb_Environment($scriptName, true));
a1241 62
/**
 * This class represents the debugger back end connection.  It
 * communicates with the debugger front end using a shared-memory queue.
 * It is slow, but it does not require any special library.
 * @@access private
 */
class pdb_PollingServerConnection extends pdb_PollingClientConnection {
  protected function init() {
    session_start();

	parent::init();
    $chanCtr = "pdb_ctr{$this->role}{$this->id}";
    $chan = "pdb_{$this->role}{$this->id}";
	unset ($_SESSION[$chan]);
	unset ($_SESSION[$chanCtr]);

    $this->role = "server";
    $this->to   = "client";

    $chanCtr = "pdb_ctr{$this->role}{$this->id}";
    $chan = "pdb_{$this->role}{$this->id}";
	unset ($_SESSION[$chan]);
	unset ($_SESSION[$chanCtr]);

	if (isset($_SESSION[$this->chanTrm]) && !$this->checkTrm()) {
	  $_SESSION[$this->chanTrm] = true;
	  session_write_close();
	  sleep(1);
	  session_start();
	}
	$_SESSION[$this->chanTrm] = false;
	session_write_close();
  }

  protected function poll() {
    $val = "";
    $chanCtr = "pdb_ctr{$this->role}{$this->id}";
    $chan = "pdb_{$this->role}{$this->id}";
    session_start();
	if (!($val = $this->checkTrm())) {
	  pdb_Logger::debug("...{$this->role}, {$this->id} poll...");
	  if(!isset($_SESSION[$chanCtr])) { 
		$_SESSION[$chan] = array(); 
		$_SESSION[$chanCtr]=0; 
	  }
	  if (count($_SESSION[$chan]) > $_SESSION[$chanCtr]) {
		$val = $_SESSION[$chan][$_SESSION[$chanCtr]++];
	  }
	}
    session_write_close();
    return $val;
  }
  /**
   * shut down the communication channel
   */
  public function shutdown() {
	pdb_Logger::debug("session terminated: {$this->chanTrm}");
    session_start();
	$_SESSION[$this->chanTrm] = $this->output;
    session_write_close();
  }
}    
d1259 1
d1293 1
a1293 2
	$val = $this->conn->read();
	return $val===true?$val:json_decode($val);
d1302 1
a1302 1
    return $this->conn->write(json_encode($data));
d1305 2
a1306 1
    $this->write(array("cmd"=>$this->packet->cmd));
d1325 1
a1325 1
      if (($this->packet = $this->read()) === true) break; // ignore __destructors after shutdown
d1331 2
a1332 1
		$this->write(array("cmd"=>$this->packet->cmd, 
d1338 2
a1339 1
		$this->write(array("cmd"=>$this->packet->cmd, 
d1348 2
a1349 1
		$this->write(array("cmd"=>$this->packet->cmd, 
a1365 1
      case "stepOut":
d1371 5
d1379 3
a1381 1
					 (array("cmd"=>"unsetBreakpoint", "scriptName"=>$bp->scriptName, 
d1383 3
a1385 1
					 (array("cmd"=>"setBreakpoint", "scriptName"=>$this->session->getCurrentViewScriptName(), 
d1406 1
a1406 1
		  $this->session->currentView = $this->session->currentView->parentView;
d1411 3
a1413 1
		  $this->write(array("cmd"=>$this->packet->cmd, "output"=>$this->getOutput()));
d1420 3
a1422 1
		$this->write(array("cmd"=>$this->packet->cmd, "output"=>$this->getOutput()));
d1430 1
d1449 3
a1451 1
    return new pdb_Environment($scriptName, $stepNext);
d1480 2
a1481 1
    $this->session->currentFrame = new pdb_Environment($scriptName, $stepNext);
d1488 1
a1488 1
    array_push($this->session->environments, $this->session->currentFrame);
d1498 2
a1499 3
    array_pop($this->session->environments);

    $this->session->currentFrame = end($this->session->environments);
d1514 1
a1514 1
    $this->session->currentFrame = (isset($vars['__pdb_CurrentFrame'])) ? $vars['__pdb_CurrentFrame'] : end($this->session->environments);
d1522 19
a1540 2
      $this->session->currentFrame->stepNext = $stepNext != pdb_JSDebugger::GO ? $stepNext : false;
    }
d1616 1
a1616 1
PHPDebugger version 1.0 
d1752 1
d1754 3
a1759 3
function setServerID(port) {
    serverID = port;
}
d1820 1
a1820 1
    data = cmd+"&serverID="+getServerID();
d1850 1
a1850 2
	     // alert("debugger exited. Debugger debug output: " +httpCtrl.responseText);
	    document.getElementById("code").innerHTML = httpCtrl.responseText;
a1864 1
    setServerID(cmd.serverID);
a1876 1
    setServerID(cmd.serverID);
a1879 1
    setServerID(cmd.serverID);
a1882 1
    setServerID(cmd.serverID);
a1911 1
    setServerID(cmd.serverID);
a1917 2
    setServerID(cmd.serverID);

@


1.3
log
@Release-5-5-5
@
text
@d4 1
a4 1
	 PHPDebugger.inc version 1.0alpha -- A pure PHP debugger.
a42 1
define ("PDB_DISABLE_JAVA", false);
d45 3
d49 1
a64 3
/** Use the PHP/Java Bridge, if it is available */
if (!PDB_DISABLE_JAVA) @@include_once("Java.inc");

d67 3
d113 3
d161 1
d209 3
d217 1
d224 1
d230 1
d236 1
d243 1
d252 1
a252 1
 * @@see pdb_JavaClientConnection 
d263 1
d304 1
d319 1
d326 1
d333 1
d341 1
a346 64
 * This class represents the debugger front end connection.  It
 * communicates with the debugger back end using a LinkedBlockingQueue.
 * Requires the PHP/Java Bridge library.
 * @@see pdb_PollingClientConnection
 */
class pdb_JavaClientConnection implements pdb_Queue {
  protected $session;
  protected $id;
  protected $queue;
  protected $role, $to;
  protected $chanTrm; // "back end terminated" flag
  protected $output;

  public function pdb_JavaClientConnection($id) {
	$this->session = java_session();
	$this->id = $id;
	$this->output = "<missing>";

	$this->init();
  }
  /**
   * Set the script output
   */
  public function setOutput($output) {
	$this->output = $output;
  }
  /**
   * Get the script output
   */
  public function getOutput() {
    $chan = "pdb_{$this->role}{$this->id}";
	$queue = $this->session->get($chan);
	return java_values($queue->getResult());
  }

  protected function init() {
    $this->role = "client";
    $this->to   = "server";
  }
  /**{@@inheritDoc}*/
  public function read() {
    $chan = "pdb_{$this->role}{$this->id}";
	$queue = $this->session->get($chan);
	$val = java_values($queue->remove());
	$val = $val === null ? true : (string)$val;
	pdb_Logger::log("${this} read: ${val}");
	return $val;
  }
  /**{@@inheritDoc}*/
  public function write($val) {
    $chan = "pdb_{$this->to}{$this->id}";
	$queue = $this->session->get($chan);
	$queue->add($val);
	pdb_Logger::log("${this} wrote: ${val}");
  }
  /**{@@inheritDoc}*/
  public function shutdown() {}

  public function __toString() {
	return "java {$this->role} queue for {$this->id}";
  }
}

/**
d348 1
d365 1
d725 1
d739 1
d779 1
d819 1
d827 1
a827 4
	if (!PDB_DISABLE_JAVA && function_exists("java_get_base") && java_server_name()) 
	  return new pdb_JavaClientConnection($id);
	else
	  return new pdb_PollingClientConnection($id);
d834 1
d859 1
d927 1
d944 1
a944 1
	if (!PDB_DISABLE_JAVA && function_exists("java_get_base") && java_server_name() && 
d954 1
d988 1
d1024 1
d1153 1
a1153 1
 * @@see pdb_JavaServerConnection
a1210 36
/**
 * This class represents the debugger back end connection.  It
 * communicates with the debugger front end using a LinkedBlockingQueue.
 * Requires the PHP/Java Bridge library.
 * @@see pdb_PollingServerConnection
 */
class pdb_JavaServerConnection extends pdb_JavaClientConnection {
  public function pdb_JavaServerConnection($id) {
	parent::pdb_JavaClientConnection($id);

	$queue = new java("php.java.bridge.BlockingQueue");
    $chan = "pdb_{$this->role}{$this->id}";
	$old = $this->session->get($chan);
	if (!java_is_null($old) && java_is_false($old->isDestroyed())) $old->shutdown("");
	$this->session->put($chan, $queue);

	$queue = new java("php.java.bridge.BlockingQueue");
    $chan = "pdb_{$this->to}{$this->id}";
	$old = $this->session->get($chan);
	if (!java_is_null($old) && java_is_false($old->isDestroyed())) $old->shutdown("");
	$this->session->put($chan, $queue);
  }
  protected function init() {
    $this->role = "server";
    $this->to   = "client";
  }
  public function shutdown() {
    $chan = "pdb_{$this->role}{$this->id}";
	$queue = $this->session->get($chan);
	if (!java_is_null($queue)) $queue->shutdown("");

    $chan = "pdb_{$this->to}{$this->id}";
	$queue = $this->session->get($chan);
	if (!java_is_null($queue)) $queue->shutdown($this->output);
  }
}
d1215 1
d1232 1
a1232 4
	if (!PDB_DISABLE_JAVA && function_exists("java_get_base") && java_server_name()) 
	  return new pdb_JavaServerConnection($id);
	else
	  return new pdb_PollingServerConnection($id);
d1404 3
d1482 1
d1494 1
d1503 1
d1513 1
d1522 1
a1538 2
	if (!PDB_DISABLE_JAVA && function_exists("java_get_base") && java_server_name()) java_session();

@


1.2
log
@Release-5-5-5
@
text
@d44 1
a44 1
ini_set("max_execution_time", 60);
d217 10
d243 1
d252 2
d257 1
a257 1
	return isset($_SESSION[$this->chanTrm]);
d307 13
d337 1
d342 1
a342 2
    $this->chanTrm = "pdb_trmserver{$this->id}";
	$this->session->put($this->chanTrm, false);
d346 13
a358 2
  protected function checkTrm() {
	return java_is_true($this->session->get($this->chanTrm));
d368 5
a372 8
	if (!$this->checkTrm()) {
	  $queue = $this->session->get($chan);
	  $val = $queue->remove();
	  $val = java_is_null($val) ? true : (string)$val;
	  pdb_Logger::log("${this} read: ${val}");
	  return $val;
	}
	return true;
d378 2
a379 4
	if(!$this->checkTrm()) {
	  $queue->add($val);
	  pdb_Logger::log("${this} wrote: ${val}");
	}
d382 1
a382 8
  public function shutdown() {
    $chan = "pdb_{$this->role}{$this->id}";
	$queue = $this->session->get($chan);
	if (!java_is_null($queue)) $queue->shutdown();

    $chan = "pdb_{$this->to}{$this->id}";
	$queue = $this->session->get($chan);
	if (!java_is_null($queue)) $queue->shutdown();
a383 2
	$this->session->put($this->chanTrm, false);
  }
d799 1
a799 1
	} elseif ((strlen($scriptDirName)==1) && ($scriptDirName[0]=='/')) {
d836 1
a836 1
	$path = "${prefix}" . substr($path, strlen($root));
a858 10
	/*
	if (!isset($_SESSION['pdb_ServerID'])) 
	  return $_SESSION['pdb_ServerID'] = 1;
	else  {
	  $oldId = $_SESSION['pdb_ServerID'];
	  $conn = self::getConnection($oldId);
	  $conn->shutdown();
	  return ++$_SESSION['pdb_ServerID'];
	}
	*/
d860 1
a860 4
	$oldId = 1;
	$conn = self::getConnection($oldId);
	$conn->shutdown();
	return $oldId;
d882 3
a884 1
	$response = $conn->read();
a885 2
	if ($msg->cmd == "end") $conn->shutdown();

d1019 1
a1019 1
    $this->vars = &$vars;
a1081 1
    $this->end = false;
d1121 1
a1121 1
  public function writeToggleBreakpoint($channel, $breakpoint) {
d1125 1
a1125 1
      $channel->write(array("cmd"=>"setBreakpoint", "scriptName"=>$this->getCurrentViewScriptName(), "breakpoint"=>$breakpoint));
d1129 1
a1129 1
      $channel->write(array("cmd"=>"unsetBreakpoint", "scriptName"=>$bp->scriptName, "breakpoint"=>$bp->breakpoint));
d1171 1
a1171 1
  public function parseScript() {
d1191 8
d1201 14
d1241 1
a1241 1
	$_SESSION[$this->chanTrm] = 1;
d1257 2
d1263 2
a1266 1

d1271 9
d1317 1
d1348 8
d1362 1
a1362 1
    while(true) {
d1390 1
a1390 1
		$this->session->parseScript();
d1410 6
a1415 1
		$this->session->writeToggleBreakpoint($this, $this->packet->breakpoint);
d1420 3
a1422 1
		  $value = $this->session->currentFrame->vars[substr($name, 1)];
d1440 1
a1440 4
		  if (!$this->end)
			$this->session->output = ob_get_contents();
		  $this->write(array("cmd"=>$this->packet->cmd, 
							 "output"=>$this->session->output));
d1447 3
a1449 4
		$this->ack();
		$this->shutdown();
		//return;
		exit(0);
d1460 1
d1565 1
a1565 1
  return $dbg->startCall($scriptName);
d1573 2
a1574 1
  return $dbg->startInclude($scriptName);
d1582 1
a1582 1
  $dbg->endInclude();
d1590 1
a1590 1
  $dbg->step($scriptName, $line, $vars);
d1611 1
a1617 9
#navigationBar {
    display: block;
    position: relative;
    background: #efefef;
    width: 100%;
    height: auto;
    overflow: hidden;
    margin-bottom: 2px;
}
d1624 1
a1624 1
   background:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAANCAYAAABPeYUaAAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLBwcXGXdF1DwAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAABEUlEQVQoz62SoWvDUBDGfx0Rry6VzzUyg4lEVgYmRulfMVUKVWOqTFVWDULVbNxsTSETg8jOzm+QwcSL28ECmwhJGpqwwnrmfXfv7nvf3b2e+TQ//NMsgPRlQfoeQ14E9TBAe0uC9QyAeBoeQfK6IZjuqmC89tHeEoDFxP+TzKqQJK0JksPNlQ/QSWYBiJQVKShd+4DJa+f68hyA0f0M7fR5nKyaSiQTlHwgatB4JXkzB+q8C12RJfNwr522Vr4hy7PjtgOgbAWZKs6SRASt+gfZ8bPBcQck83B/Jl/Fre3S8AGlarx5Kuazu33o2I4atUq1LYi27cUNEj0cE925VdBxxxWOttJZXFrvFN/+jBPYL4uJYFb2zCiIAAAAAElFTkSuQmCC') no-repeat;
d1632 1
a1632 1
    background:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAANCAYAAABy6+R8AAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLBwYrNECrm4EAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAAwUlEQVQoz52SLQ7CQBCFvyaI4nYlciWSI3CEFkVQGAyOcBU0ClCARCKRHGFlN0HsuK4D0RRasWnKJOPel/fmJ/Ev/6ZnDQD89YzcL51iNc3R2ayC5HZkslx3Qs/97gcBEEBOh7jLfNGOh5RY8egQd7HiQcoG9HULPRZRwthagvdR4chapBUPQELVsZKAL8HUkBZApVVHN5FWuhoKzlEYg06HUaYwhuBcO55RGjbxWynANWdSWc5jte3+iCwHIPnn9z7J30SR7ayFNQAAAABJRU5ErkJggg==') no-repeat;
d1640 1
a1640 1
    background:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAANCAYAAABPeYUaAAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLBwYtD6f61SMAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAA6ElEQVQoz2N8//r9fwYKAQuMcWy6JlYFmq4lDIIqyYQNOTZdk8Gr8jpWBdvaNRkUPz9nkDSswWkII8w72Fyi6JjMoGmRw7Ct3ZDBKvM6Ye9gU3RsuiaDpkkywTBhIqjizwfiAxbdBQhDfqCIYXMxVkN+fGdgCCqaCzXkPYNXJoS9ri+ZeO84FV1nWNYUDfEKFC9rimZwKrpOWph41d1nWNaWzcDw5zvDsrZsBq+6+/ijOHn+MQbBzxBF73kVGeYmWiHSSZMiigHY1LIwMDAw/Di/lOHaC4giQYljDAxIhqC7AJtaRmrkHQBYX2Q4HZvQSwAAAABJRU5ErkJggg==') no-repeat;
d1648 1
a1648 1
    background:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAANCAYAAABPeYUaAAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLBwYsOAZcQW0AAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAABSklEQVQoz62TP0jDQBTGv5QMdSgYcEjGgEvHdsyYsW6Kg27SKeJki1PpEAShqJPYKTilHUS3dOyYbu1mhpZmERqIcIEOyRA4h9qaeCcK+uA43uPj9/7cO4GEhOKPJmYdMrMQTJ5A3nxGKO2okCsHkHbr30PIzII/slA9vMO2XGWEUTDG+PEMyXIBpdJiIWuAbjiIXkcYXJUZiHZ0A91wMOzuoVhS8hWRkFDHlCmN55RMbeqYMiUhYY5jypRMbUrjOaMpbGhpBLffgGZ43OFphge33wDSiD+TJAaQJqubY243016a5GKa4UFYP/HAVFFr+1zI8LaM/dNLoKh8BpMFnu9b0M8zkJ9sYKo4vrgGxC0gjdHrNDdJC79dqFrbR6/TZAAA+JXUH1xIy5WIlFRYJ1quoq9ti7ysycTGS/CxqbILZCC8uQn/8XfeAUbdtbmYIYl8AAAAAElFTkSuQmCC') no-repeat;
d1656 1
a1656 1
    background:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAANCAYAAABPeYUaAAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLBwYsF62NfDQAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAABAUlEQVQoz62Tv2vCQBTHP5GsDoJDV8f8C44ZM+Y/EOnSgoOCQ4YOxVE6BH9MoZMdM3TI6CLcJNzmLULGCg4p6HBgoB0SFH9gKvYtj7v3fR/ufe/OSNbJD3dG6RaxGFuIsXUfhB04j0OEfwwyi/q+ZI94NjlsVG2cpyGRb1FvKQCMa54kywAZ9XE9eV78FoSjZ+yWun4S+dnH9aao+QAVBQC43hS2ktDvYLfVXz3RqCjYN5wCiiEpkOos5+vw7RhQbGyqIU2yDNhddfs70TlIFwxsAjTfBZVNnN1IuUbQqJ+i9nFJawJoOWGxykSVBwE5xPFiPl5rOC/xAXlBa/zH3/kFlslu4rTXaTUAAAAASUVORK5CYII=') no-repeat;
d1665 1
a1665 1
    background:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAANCAYAAABy6+R8AAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLCQYlB4EnoCoAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAABCklEQVQoz42Rv0oDQRCHv4MJbCCFgoUHvkBKXyGPEDufwUokhdFGokWwt7IRbISkTHmvcIUPcUKK3eJgp1g4i92Ld4gxWw2z329+8ye7vF81pcs59J0fVUjpcsZaHCwq3QQBD8Ddcv6vYDF7BDxCACMGgPFov8iIgQACChKTVw9rvCrqPK52+FopPjodCBA0Og1H0el5Nv1VXcNPPDQGHAhBMcnpZrlOJFi1aK1orXhVNm/zxGnbXnRaXE//nEchcm17ZpB+ggImIaaDx9gMaBfhQeD95bVfWiLQi4W48vzkmM1ndfBx89OczG5t001ePBVUX1UPWt1OesLMbm2zA4Puhk3n7LucxQLfZ4Norb3ftQMAAAAASUVORK5CYII=') no-repeat;
d1674 1
a1674 1
    background:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAANCAYAAACgu+4kAAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLBwc3GnvIoSQAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAABH0lEQVQoz5WToU4DQRCGvzZLspUn+wpIJLLyJDiQEBLMJZDAA1QgTlRUU1tXCY+A5BGoPHFiKkhukm4yiD3CNr3S9k8mu/l3Z+af2dme1GJ04HM6hBPP2f2S/9DvIj/KjNG4gUbZh36Xc15GURr2B3Abzi8Z+cQABTyqkdu8BTjP+WMV91KLSS22eMDMGjOrzNZfZuvKzCSxJlnN3p4wqcVclD3kYlJBWEJQCACrJLNvVwXnwWVoSErQbwUEwgq0+ZMa2JYfBuAV1aSJo7EwvzsFmpj515y2/WjNKbim5SN66Ry8P2dcTRexDGBWXDNwHSoc5GPZfoW8FGZFxs30FYCBi9xRc3BZCrPiNoZ2/rg5SIPMi+GO0030dv2FQ/EDM7CYPt7DsBMAAAAASUVORK5CYII=') no-repeat;
d1681 1
a1681 1
    background:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAANCAYAAABy6+R8AAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLBwYQB8PJFa8AAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAABNElEQVQoz4WPsUsCYRjGf8YNNzTo7vJBDgUNHTSc4KBbro6ORy5KU5tN0VhjS+FfEDXaEFxbY9cQuQSfQ3BCwyck3At9YIOieZo98MAL7/vjed6MMWYMcH6aQxUqePsBaqvKOm0A6PcQpaDoh4QPdcL7E8xQr4EsmC9BLKg8NA8hm72kc+Xx9Hi2GhIryMgAIHZibw9aDZDRBZ3rIs9RZ7neTDK3C1RKUC336L0cc3tTR/fDFGTByLLdTagegMp36d7VAHAWQuSPzy0Mh5BM987vxSoojiGKQBUCgkYzBQGSzOdkBNEr4Pj45QBvtza7XkhCILGg+6A1FEttPL+F67oL6RPIcZFveJse72wHBEdtctncyhcz5tOM40GM1iHxR4jnN1F5L1U8DRkzFhGwTGo4/KsfXjWDCQ6TmRMAAAAASUVORK5CYII=') no-repeat;
d1684 1
a1684 1
    background:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAANCAYAAABy6+R8AAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9kLBwYOGJqAJ4UAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAA+0lEQVQoz5XSMUvDUBSG4bcXhyM4pFsudBE6GEfB5UKGZLOjq5uCIE7iPyjdxEXQoZC/4OgipIOQbqZDMW6OcbsZBO8Q0MEWkWJJ3vl7lsPpWGu/WOQqy8s44X2S8ukcmyL4Uczu6QnidZczOktUPqY8HB/Bh2OlLWEwTtAHg19kXwvuQwM1/7cBh08Z3Z0ABZCena8HAPViB6hymlHNcppUzXLKaYaq5gVtquYFitq1QtQO5fWDVsbrBygdGqTnNwLS89GhQSFCfJc0QvHNLYj8nFyHBjMcrQVmOEJH8d+PALD5M/nVNW+TFJwDEbajmODiEr2/t/pGbfoGcP1aToLr9OAAAAAASUVORK5CYII=') no-repeat;
d1690 2
a1691 2
    top: 0;
    left: 0;
d1695 1
d1724 1
d1731 1
d1738 1
d1761 1
a1761 1
    if (browser ==" Microsoft Internet Explorer") {
d1788 1
d1794 22
d1834 1
a1834 1
function startServer() {
d1892 2
d1902 1
a1903 1
    currentLine = document.getElementById("bp_"+(cmd.line)).firstChild;
d1905 2
a1906 1
	code = document.getElementById("code");
d1909 2
a1910 2
	if ((codeLine.offsetTop - document.body.scrollTop + currentLine.clientHeight + scrollBarHeight + code.clientTop > document.body.clientHeight) ||
		(codeLine.offsetTop - document.body.scrollTop + code.clientTop  <= 0)) {
d1948 1
a1948 3
    setServerID(cmd.serverID);
    document.getElementById("code").innerHTML = "";
    document.title = "PDB";
d1970 6
a1975 1
    return str.replace(/^\s*/, "").replace(/\s*$/, "");
d1978 3
a1980 3
    if (event.target.parentNode.className=="breakpoint") return true;
    if (event.target && event.target.firstChild && event.target.firstChild.data) {
	switchView(trim(event.target.firstChild.data));
d2021 1
@


1.1
log
@PHPDebugger added
@
text
@d43 2
a44 1
ini_set("max_execution_time", 240);
d61 95
d202 21
d226 2
d229 1
a229 1
class pdb_ClientConnection {
d232 2
a233 1
  const TIMER_DURATION = 200000; // 200ms
d238 1
a238 1
  public function pdb_ClientConnection($id) {
d240 1
d243 4
a250 10
  private function getCookies() {
    $str="";
    $first=true;
    foreach($_COOKIE as $k => $v) {
      $str .= ($first ? "Cookie: $k=$v":"; $k=$v");
      $first=false;
    }
    if(!$first) $str .= "\r\n";
    return $str;
  }
a252 1
    $val = "";
d256 7
a262 4
    if (!isset($_SESSION[$chanCtr])) $_SESSION[$chanCtr] = 0; 
    if (isset($_SESSION[$chan]) && (count($_SESSION[$chan]) > $_SESSION[$chanCtr])) {
      $val = $_SESSION[$chan][$_SESSION[$chanCtr]++];
    }
d269 1
a269 1
    $_SESSION[$chan][]=$val;
d278 7
a284 3
    while(!($val=$this->poll())) {
      usleep(self::TIMER_DURATION);
    }
d291 1
a291 1
    $this->send($val);
d296 54
d351 12
a362 2
	pdb_Logger::debug("shutdown comm channel");
	session_destroy();
d763 1
d781 15
d831 4
d836 1
d839 4
a842 1
	else 
d844 7
d852 13
a864 1

d868 1
a868 1
	if ($msg->cmd == "begin") sleep(1); // FIXME wait for the server to settle
d870 1
a870 1
	$conn = new pdb_ClientConnection($msg->serverID);
a895 1

d908 13
a920 5
  private function breakpointCounter ($val) {
    if ($val[0]=="line#") 
      return (string)$this->lineCounter++;
    else
      return 'id="bp_'.$this->bpCounter++.'"';
d922 2
d925 1
a925 1
   * Return the HTML representation of the current script
d936 14
a949 10
      $this->code = 
		preg_replace_callback(array('|id="bp_"|', // id=bp_ => id=bp_$n
									'|line#|'),  // lineno => $n
							  array($this, "breakpointCounter"),
							  preg_replace(array('|<br />|', // br => span id=pb_ ...
												 '|<span style="color: #0000BB">\?&gt;</span>|'), // handle incomplete last line
										   array($c, 
												 '<span style="color: #0000BB">?&gt;'.$c.'</span>'),
										   show_source($this->scriptName, true)));
    }
d971 5
a975 1
    return $this->value;
d1177 2
d1180 1
a1180 1
class pdb_ServerConnection extends pdb_ClientConnection {
d1182 2
a1183 2
    $this->to = "client";
    $this->role   = "server";
d1191 10
a1200 4
    if(!isset($_SESSION[$chanCtr])) { $_SESSION[$chan] = array(); $_SESSION[$chanCtr]=0; }
    if (count($_SESSION[$chan]) > $_SESSION[$chanCtr]) {
      $val = $_SESSION[$chan][$_SESSION[$chanCtr]++];
    }
d1204 34
a1238 1
}    
d1257 6
d1271 1
a1271 1
    $this->conn = new pdb_ServerConnection($id);
d1289 2
a1290 1
    return json_decode($this->conn->read());
d1313 1
a1313 1
      $this->packet = $this->read();
d1393 1
d1395 3
d1423 1
d1425 2
a1426 2
      $scriptName="$path/$scriptName";
      if (file_exists($scriptName)) return realpath($scriptName);
d1544 1
d1546 2
a1627 11
.breakpoint {
    float: left;
    margin-right: 1em;
    width: auto;
    height: 13px;
    background: #efefef;
    display: block;
    position: relative;
    overflow: hidden;
    margin: 2px solid black;
}
d1638 27
d1666 1
a1666 2
    width: 3em;
    height: inherit;
d1668 2
a1669 1
    display: block;
d1676 2
a1679 2
    position: relative;
    display: inline-block;
d1682 2
a1685 2
    position: relative;
    display: inline-block;
d1693 1
a1693 1
var scriptName = "<?php echo urlencode($_SERVER['SCRIPT_FILENAME']); ?>";
d1747 1
a1747 1
    http.setRequestHeader("Expires", "Thu, 19 Nov 1981 08:52:00 GMT");
d1827 1
a1827 1
	codeArea = document.getElementById("codeArea");
d1829 4
a1832 3
	if ((codeLine.offsetTop - codeArea.scrollTop > codeArea.offsetHeight) ||
		(codeLine.offsetTop - codeLine.offsetHeight - codeArea.scrollTop <= 0)) {
	  currentLine.scrollIntoView(true);
d1920 1
a1920 2
<div id="codeArea" style="height:97%;width:97%;overflow:auto;">
  <div style="height:100%;width:10000px;" onmousemove="return mousemove(this, event);" onmousedown="return mousedown(this, event);" id="code"><span>loading...</span></div>
d1951 1
a1951 1
?>@

